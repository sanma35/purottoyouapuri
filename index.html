<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ—ãƒ­ãƒƒãƒˆãƒ¡ãƒ¼ã‚«ãƒ¼ PRO</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #app {
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            padding: 30px;
            width: 90%;
            max-width: 1000px; /* å°‘ã—åºƒã‚ã« */
            margin-bottom: 30px;
            display: flex; /* Flexboxã§ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
            gap: 20px;
        }
        #sidebar {
            width: 250px;
            padding-right: 20px;
            border-right: 1px solid #eee;
            flex-shrink: 0; /* ç¸®ã¾ãªã„ */
        }
        #main-content {
            flex-grow: 1; /* æ®‹ã‚Šã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’åŸ‹ã‚ã‚‹ */
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 25px;
            font-size: 2.2em;
        }
        h2 {
            color: #34495e;
            margin-top: 20px;
            margin-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 8px;
            font-size: 1.6em;
        }
        h3 {
             color: #4a637d;
             margin-top: 15px;
             margin-bottom: 10px;
             font-size: 1.3em;
        }
        .section-title { /* æ—¢å­˜ã®section-titleã¯h2, h3ãªã©ã«ç½®ãæ›ãˆ */
            color: #34495e;
            margin-top: 30px;
            margin-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 8px;
            font-size: 1.5em;
        }
        .input-group {
            margin-bottom: 18px;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        .input-group input[type="text"],
        .input-group input[type="number"],
        .input-group textarea,
        .input-group select {
            width: calc(100% - 20px);
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
            box-sizing: border-box;
            background-color: #fafafa;
        }
        .input-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap; /* ãƒœã‚¿ãƒ³ã®æŠ˜ã‚Šè¿”ã— */
        }
        button {
            background-color: #3498db;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s ease, transform 0.1s ease;
            white-space: nowrap; /* ãƒœã‚¿ãƒ³å†…ã®ãƒ†ã‚­ã‚¹ãƒˆæ”¹è¡Œé˜²æ­¢ */
        }
        button:hover {
            background-color: #2980b9;
            transform: translateY(-1px);
        }
        button:active {
            transform: translateY(0);
        }
        button.secondary {
            background-color: #95a5a6;
        }
        button.secondary:hover {
            background-color: #7f8c8d;
        }
        button.danger {
            background-color: #e74c3c;
        }
        button.danger:hover {
            background-color: #c0392b;
        }
        button.edit-btn {
            background-color: #f39c12; /* é»„è‰²ã£ã½ã„ã‚ªãƒ¬ãƒ³ã‚¸ */
            padding: 6px 12px; /* ãƒªã‚¹ãƒˆå†…ãƒœã‚¿ãƒ³ã®ã‚µã‚¤ã‚º */
            font-size: 0.8em;
            margin-left: 8px;
        }
        button.edit-btn:hover {
            background-color: #e67e22;
        }

        #plot-output { /* ä½¿ç”¨ã—ãªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒæ®‹ã—ã¦ãŠãã¾ã™ */
            background-color: #ecf0f1;
            border: 1px dashed #bdc3c7;
            padding: 25px;
            min-height: 200px;
            margin-top: 30px;
            border-radius: 8px;
            font-size: 1.1em;
            line-height: 1.8;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .list-container {
            list-style: none;
            padding: 0;
            max-height: 300px; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã«ã™ã‚‹ */
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 5px;
            background-color: #fcfcfc;
        }
        .list-container li {
            background-color: #f9f9f9;
            border-bottom: 1px solid #eee;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .list-container li:last-child {
            border-bottom: none;
        }
        .list-container li:hover {
            background-color: #eaf3f9;
        }
        .list-container li.selected {
            background-color: #dbe9f5;
            font-weight: bold;
            color: #2c3e50;
        }
        .list-container li span {
            flex-grow: 1;
            margin-right: 15px;
        }
        .list-container li .list-item-controls {
            display: flex;
            align-items: center;
            gap: 5px; /* ãƒœã‚¿ãƒ³é–“ã®ã‚¹ãƒšãƒ¼ã‚¹ */
        }
        .list-container li button {
            padding: 6px 12px;
            font-size: 0.8em;
            margin-left: 8px; /* å¾“æ¥ã®margin-left */
            box-shadow: none; /* ãƒªã‚¹ãƒˆå†…ãƒœã‚¿ãƒ³ã®å½±ã‚’ãªãã™ */
        }

        /* Drag and Drop styles */
        .list-container li[draggable="true"] {
            cursor: grab;
        }
        .list-container li[draggable="true"]:active {
            cursor: grabbing;
        }
        .list-container li.dragging {
            opacity: 0.5;
            border: 2px dashed #3498db;
            background-color: #e0f0fb;
        }
        .list-container li.drag-over {
            border-top: 2px solid #3498db;
            /* ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼æ™‚ã®ç·šã®è‰²ã¨å¤ªã• */
        }
        /* drag-over-bottom ã¯ãƒ‰ãƒ©ãƒƒã‚°ã‚’ä¸‹ã«æŒ¿å…¥ã™ã‚‹éš›ã«ä½¿ç”¨ */
        .list-container li.drag-over-bottom {
            border-bottom: 2px solid #3498db;
        }

        .plot-type-options {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .plot-type-options label {
            background-color: #e0e0e0;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .plot-type-options label:hover {
            background-color: #d0d0d0;
        }
        .plot-type-options input[type="radio"] {
            display: none;
        }
        .plot-type-options input[type="radio"]:checked + label {
            background-color: #3498db;
            color: white;
            font-weight: bold;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚° */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border: 1px solid #888;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
        }
        #overallSummaryTextarea, #charDetailSummaryTextarea {
            width: calc(100% - 20px);
            min-height: 200px;
            margin-bottom: 15px;
        }
        #charDetailInputs label, #charDetailInputs input {
            margin-bottom: 10px;
        }
        #charDetailInputs input {
            width: calc(100% - 10px);
        }

        /* æç”»ãƒ»ç”»åƒãƒ»ãƒ†ãƒ¼ãƒ–ãƒ«é–¢é€£ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #drawingCanvas, #timelineCanvas {
            border: 1px solid #bdc3c7;
            background-color: white;
            display: block;
            margin-top: 15px;
            border-radius: 5px;
        }
        #imagePreviewElement img {
            max-width: 100%;
            height: auto;
            border: 1px solid #eee;
            border-radius: 5px;
            display: block;
            margin-top: 15px;
        }
        #tablePreviewElement table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        #tablePreviewElement th, #tablePreviewElement td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
            word-wrap: break-word; /* é•·ã„å˜èªã®æŠ˜ã‚Šè¿”ã— */
        }
        #tablePreviewElement td[contenteditable="true"]:focus {
            outline: 2px solid #3498db;
        }
        #tablePreviewElement th {
            background-color: #e9ecef;
        }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆä»»æ„ï¼‰ */
        .list-container::-webkit-scrollbar,
        body::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .list-container::-webkit-scrollbar-thumb,
        body::-webkit-scrollbar-thumb {
            background-color: #ccc;
            border-radius: 4px;
        }
        .list-container::-webkit-scrollbar-track,
        body::-webkit-scrollbar-track {
            background-color: #f1f1f1;
        }

        /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ */
        #characterSelectForScene {
            width: calc(100% - 20px);
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
            box-sizing: border-box;
            background-color: #fafafa;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="sidebar">
            <h1>ãƒ—ãƒ­ãƒƒãƒˆãƒ¡ãƒ¼ã‚«ãƒ¼ PRO</h1>
            <div class="section">
                <h2>ä½œå“ãƒªã‚¹ãƒˆ</h2>
                <ul id="project-list" class="list-container">
                    </ul>
                <div class="button-group">
                    <button id="addProjectButton">æ–°ã—ã„ä½œå“</button>
                    <button id="deleteProjectButton" class="danger secondary">ä½œå“ã‚’å‰Šé™¤</button>
                </div>
            </div>

            <div class="section" id="overall-summary-section" style="display:none;">
                <h2>ä½œå“æ¦‚è¦</h2>
                <div class="button-group">
                    <button id="openOverallSummaryModal">æ¦‚è¦ãƒ¡ãƒ¢ã‚’é–‹ã</button>
                </div>
            </div>

            <div class="section" id="character-list-section" style="display:none;">
                <h2>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒªã‚¹ãƒˆ</h2>
                <ul id="character-list" class="list-container">
                    </ul>
                <div class="button-group">
                    <button id="addCharacterButton">æ–°ã—ã„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼</button>
                    <button id="deleteCharacterButton" class="danger secondary">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’å‰Šé™¤</button>
                </div>
            </div>

            <div class="section" id="sequence-list-section" style="display:none;">
                <h2>ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹ãƒªã‚¹ãƒˆ</h2>
                <ul id="sequence-list" class="list-container">
                    </ul>
                <div class="button-group">
                    <button id="addSequenceButton">æ–°ã—ã„ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹</button>
                    <button id="deleteSequenceButton" class="danger secondary">ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹ã‚’å‰Šé™¤</button>
                </div>
            </div>
        </div>

        <div id="main-content">
            <h2 id="current-project-title">ä½œå“ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
            <h3 id="current-sequence-title" style="display:none;"></h3>

            <div class="section" id="scene-input-section" style="display:none;">
                <h3>ã‚·ãƒ¼ãƒ³å…¥åŠ›</h3>
                <div class="plot-type-options">
                    <input type="radio" id="typeTimeline" name="plotType" value="timeline" checked>
                    <label for="typeTimeline">æ™‚ç³»åˆ—ãƒ—ãƒ­ãƒƒãƒˆ</label>

                    <input type="radio" id="typeCharacter" name="plotType" value="character">
                    <label for="typeCharacter">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ—ãƒ­ãƒƒãƒˆ</label>

                    <input type="radio" id="typeStory" name="plotType" value="story">
                    <label for="typeStory">ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ—ãƒ­ãƒƒãƒˆ</label>
                </div>

                <div id="timelinePlotInputs">
                    <div class="input-group">
                        <label for="date">æ—¥ä»˜/æ™‚æœŸ:</label>
                        <input type="text" id="date" placeholder="ä¾‹: 2023/01/15, ç´€å…ƒå‰500å¹´, å¤">
                    </div>
                    <div class="input-group">
                        <label for="event">å‡ºæ¥äº‹/å†…å®¹:</label>
                        <textarea id="event" placeholder="ä¾‹: ä¸»äººå…¬ãŒæ–°ã—ã„ã‚¹ã‚­ãƒ«ã‚’ç¿’å¾—ã™ã‚‹"></textarea>
                    </div>
                </div>

                <div id="characterPlotInputs" style="display: none;">
                    <div class="input-group">
                        <label for="characterSelectForScene">æ—¢å­˜ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸æŠ:</label>
                        <select id="characterSelectForScene">
                            <option value="">-- æ–°ã—ã„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ --</option>
                            </select>
                    </div>
                    <div class="input-group">
                        <label for="charName">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å (æ–°è¦ã®å ´åˆ):</label>
                        <input type="text" id="charName" placeholder="ä¾‹: ã‚¨ãƒ«ã‚¶">
                    </div>
                    <div class="input-group">
                        <label for="charTrait">ç‰¹å¾´/æ€§æ ¼:</label>
                        <textarea id="charTrait" placeholder="ä¾‹: å†·é™æ²ˆç€ã€é­”åŠ›ãŒé«˜ã„"></textarea>
                    </div>
                    <div class="input-group">
                        <label for="charRole">å½¹å‰²:</label>
                        <input type="text" id="charRole" placeholder="ä¾‹: ä¸»äººå…¬ã€æ•µå½¹ã€ã‚µãƒãƒ¼ãƒˆ">
                    </div>
                </div>

                <div id="storyPlotInputs" style="display: none;">
                    <div class="input-group">
                        <label for="storyChapter">ç« /ã‚·ãƒ¼ãƒ³:</label>
                        <input type="text" id="storyChapter" placeholder="ä¾‹: ç¬¬1ç« : å‡ºä¼šã„ã€ã‚·ãƒ¼ãƒ³3: è¨“ç·´">
                    </div>
                    <div class="input-group">
                        <label for="storySummary">æ¦‚è¦:</label>
                        <textarea id="storySummary" placeholder="ä¾‹: ä¸»äººå…¬ã¨ãƒ’ãƒ­ã‚¤ãƒ³ãŒåˆã‚ã¦å‡ºä¼šã„ã€äº’ã„ã®ç›®æ¨™ã‚’çŸ¥ã‚‹"></textarea>
                    </div>
                    <div class="input-group">
                        <label for="storyConflict">è‘›è—¤/è§£æ±º:</label>
                        <textarea id="storyConflict" placeholder="ä¾‹: å†…ãªã‚‹è‘›è—¤ã€æ•µã¨ã®å¯¾æ±ºã€æ–°ãŸãªå‹æƒ…"></textarea>
                    </div>
                </div>

                <div class="button-group">
                    <button id="addSceneButton">ã‚·ãƒ¼ãƒ³ã‚’è¿½åŠ </button>
                    <button id="clearSceneInputs" class="secondary">å…¥åŠ›ã‚¯ãƒªã‚¢</button>
                </div>
            </div>

            <div class="section" id="scene-list-section" style="display:none;">
                <h3>ã‚·ãƒ¼ãƒ³ãƒªã‚¹ãƒˆ</h3>
                <ul id="scene-list" class="list-container">
                    </ul>
                <div class="button-group">
                    <button id="deleteSceneButton" class="danger secondary">ã‚·ãƒ¼ãƒ³ã‚’å‰Šé™¤</button>
                </div>
            </div>

            <div class="section" id="scene-details-section" style="display:none;">
                <h3>é¸æŠä¸­ã®ã‚·ãƒ¼ãƒ³è©³ç´°</h3>
                <div id="selected-scene-content">
                    </div>

                <div class="section-title">ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æç”»</div>
                <div class="button-group">
                    <button id="timelineDisplayMode">ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ</button>
                </div>
                <canvas id="timelineCanvas" width="800" height="200"></canvas>

                <div class="section-title">è‡ªç”±æç”»</div>
                <div class="button-group">
                    <button id="drawingModeButton">æç”»ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ</button>
                    <label for="lineThickness">å¤ªã•:</label>
                    <input type="range" id="lineThickness" min="1" max="20" value="5">
                    <label for="lineColor">è‰²:</label>
                    <input type="color" id="lineColor" value="#000000">
                    <button id="clearDrawingButton" class="secondary">ã‚¯ãƒªã‚¢</button>
                </div>
                <canvas id="drawingCanvas" width="800" height="400"></canvas>

                <div class="section-title">ç”»åƒ</div>
                <div class="input-group">
                    <label for="imageUpload">ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰:</label>
                    <input type="file" id="imageUpload" accept="image/*">
                </div>
                <div id="imagePreviewElement"></div>

                <div class="section-title">ãƒ†ãƒ¼ãƒ–ãƒ«</div>
                <div class="input-group">
                    <label>ãƒ†ãƒ¼ãƒ–ãƒ«ã‚µã‚¤ã‚º:</label>
                    <input type="number" id="tableRowsInput" value="3" min="1" max="100" style="width: 80px;"> è¡Œ
                    <input type="number" id="tableColsInput" value="3" min="1" max="100" style="width: 80px; margin-left: 10px;"> åˆ—
                </div>
                <div class="button-group">
                    <button id="createTableButton">ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ</button>
                </div>
                <div id="tablePreviewElement"></div>
            </div>
        </div>
    </div>

    <div id="overallSummaryModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>ä½œå“å…¨ä½“æ¦‚è¦</h2>
            <textarea id="overallSummaryTextarea" placeholder="ä½œå“å…¨ä½“ã®ã‚ã‚‰ã™ã˜ã‚„è¨­å®šãªã©ã‚’ã“ã“ã«è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚"></textarea>
            <div class="button-group">
                <button id="saveOverallSummaryButton">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div id="characterDetailModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è©³ç´°</h2>
            <div id="charDetailInputs">
                <div class="input-group">
                    <label for="charDetailName">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å:</label>
                    <input type="text" id="charDetailName" placeholder="ä¾‹: ã‚¨ãƒ«ã‚¶">
                </div>
                <div class="input-group">
                    <label for="charDetailTrait">ç‰¹å¾´/æ€§æ ¼:</label>
                    <input type="text" id="charDetailTrait" placeholder="ä¾‹: å†·é™æ²ˆç€ã€é­”åŠ›ãŒé«˜ã„">
                </div>
                <div class="input-group">
                    <label for="charDetailRole">å½¹å‰²:</label>
                    <input type="text" id="charDetailRole" placeholder="ä¾‹: ä¸»äººå…¬ã€æ•µå½¹ã€ã‚µãƒãƒ¼ãƒˆ">
                </div>
                <div class="input-group">
                    <label for="charDetailSummaryTextarea">è©³ç´°ãƒ¡ãƒ¢:</label>
                    <textarea id="charDetailSummaryTextarea" placeholder="ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®èƒŒæ™¯ã€ç”Ÿã„ç«‹ã¡ã€èƒ½åŠ›ã€äººé–“é–¢ä¿‚ãªã©ã€è©³ç´°ãªæƒ…å ±ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚"></textarea>
                </div>
            </div>
            <div class="button-group">
                <button id="saveCharacterDetailButton">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- UIè¦ç´ ã®å–å¾— ---
            const projectList = document.getElementById('project-list');
            const addProjectButton = document.getElementById('addProjectButton');
            const deleteProjectButton = document.getElementById('deleteProjectButton');
            const overallSummarySection = document.getElementById('overall-summary-section');
            const openOverallSummaryModalButton = document.getElementById('openOverallSummaryModal');
            const overallSummaryModal = document.getElementById('overallSummaryModal');
            const closeOverallSummaryModalButton = overallSummaryModal.querySelector('.close-button');
            const overallSummaryTextarea = document.getElementById('overallSummaryTextarea');
            const saveOverallSummaryButton = document.getElementById('saveOverallSummaryButton');

            const characterListSection = document.getElementById('character-list-section'); // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒªã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³
            const characterList = document.getElementById('character-list'); // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒªã‚¹ãƒˆ
            const addCharacterButton = document.getElementById('addCharacterButton'); // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¿½åŠ ãƒœã‚¿ãƒ³
            const deleteCharacterButton = document.getElementById('deleteCharacterButton'); // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å‰Šé™¤ãƒœã‚¿ãƒ³
            const characterDetailModal = document.getElementById('characterDetailModal'); // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«
            const closeCharacterDetailModalButton = characterDetailModal.querySelector('.close-button');
            const charDetailNameInput = document.getElementById('charDetailName'); // è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®åå‰å…¥åŠ›
            const charDetailTraitInput = document.getElementById('charDetailTrait'); // è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ç‰¹å¾´å…¥åŠ›
            const charDetailRoleInput = document.getElementById('charDetailRole'); // è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®å½¹å‰²å…¥åŠ›
            const charDetailSummaryTextarea = document.getElementById('charDetailSummaryTextarea'); // è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ãƒ¡ãƒ¢å…¥åŠ›
            const saveCharacterDetailButton = document.getElementById('saveCharacterDetailButton'); // è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ä¿å­˜ãƒœã‚¿ãƒ³

            const sequenceListSection = document.getElementById('sequence-list-section');
            const sequenceList = document.getElementById('sequence-list');
            const addSequenceButton = document.getElementById('addSequenceButton');
            const deleteSequenceButton = document.getElementById('deleteSequenceButton');

            const sceneInputSection = document.getElementById('scene-input-section');
            const sceneListSection = document.getElementById('scene-list-section');
            const sceneDetailsSection = document.getElementById('scene-details-section');
            const sceneList = document.getElementById('scene-list');
            const addSceneButton = document.getElementById('addSceneButton');
            const deleteSceneButton = document.getElementById('deleteSceneButton');
            const selectedSceneContent = document.getElementById('selected-scene-content');

            const currentProjectTitle = document.getElementById('current-project-title');
            const currentSequenceTitle = document.getElementById('current-sequence-title');

            // --- æ—¢å­˜ã®ãƒ—ãƒ­ãƒƒãƒˆå…¥åŠ›UIè¦ç´  ---
            const radioButtons = document.querySelectorAll('input[name="plotType"]');
            const timelineInputs = document.getElementById('timelinePlotInputs');
            const characterInputs = document.getElementById('characterPlotInputs'); // ã‚·ãƒ¼ãƒ³è¿½åŠ æ™‚ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å…¥åŠ›
            const storyInputs = document.getElementById('storyPlotInputs');

            const dateInput = document.getElementById('date');
            const eventInput = document.getElementById('event');
            const charNameInput = document.getElementById('charName'); // ã‚·ãƒ¼ãƒ³è¿½åŠ æ™‚ç”¨
            const charTraitInput = document.getElementById('charTrait'); // ã‚·ãƒ¼ãƒ³è¿½åŠ æ™‚ç”¨
            const charRoleInput = document.getElementById('charRole'); // ã‚·ãƒ¼ãƒ³è¿½åŠ æ™‚ç”¨
            const characterSelectForScene = document.getElementById('characterSelectForScene'); // ã‚·ãƒ¼ãƒ³è¿½åŠ æ™‚ã®æ—¢å­˜ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠ
            const storyChapterInput = document.getElementById('storyChapter');
            const storySummaryInput = document.getElementById('storySummary');
            const storyConflictInput = document.getElementById('storyConflict');
            const clearSceneInputsButton = document.getElementById('clearSceneInputs');

            // --- æç”»ãƒ»ç”»åƒãƒ»ãƒ†ãƒ¼ãƒ–ãƒ«UIè¦ç´  ---
            const timelineCanvas = document.getElementById('timelineCanvas');
            const timelineContext = timelineCanvas.getContext('2d');
            const timelineDisplayModeButton = document.getElementById('timelineDisplayMode');

            const drawingCanvas = document.getElementById('drawingCanvas');
            const drawingContext = drawingCanvas.getContext('2d');
            const drawingModeButton = document.getElementById('drawingModeButton');
            const lineThicknessInput = document.getElementById('lineThickness');
            const lineColorInput = document.getElementById('lineColor');
            const clearDrawingButton = document.getElementById('clearDrawingButton');

            const imageUploadInput = document.getElementById('imageUpload');
            const imagePreviewElement = document.getElementById('imagePreviewElement');

            const tableRowsInput = document.getElementById('tableRowsInput');
            const tableColsInput = document.getElementById('tableColsInput');
            const createTableButton = document.getElementById('createTableButton');
            const tablePreviewElement = document.getElementById('tablePreviewElement');

            // --- ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ« ---
            let projects = []; // å…¨ã¦ã®ä½œå“ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
            let currentProjectId = null;
            let currentSequenceId = null;
            let currentSceneId = null; // é¸æŠä¸­ã®ã‚·ãƒ¼ãƒ³ID
            let currentCharacterId = null; // é¸æŠä¸­ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ID (æ–°ã—ã„æ©Ÿèƒ½)

            // æç”»ãƒ»ç”»åƒãƒ»ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿
            let isDrawingMode = false;
            let drawingPath = [];
            let currentDrawingData = []; // ç¾åœ¨ã®ã‚·ãƒ¼ãƒ³ã®æç”»ãƒ‘ã‚¹
            let currentImageData = null; // ç¾åœ¨ã®ã‚·ãƒ¼ãƒ³ã®ç”»åƒ
            let currentTableData = null; // ç¾åœ¨ã®ã‚·ãƒ¼ãƒ³ã®ãƒ†ãƒ¼ãƒ–ãƒ«

            // æç”»é–¢é€£
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;

            // è‡ªå‹•ä¿å­˜ç”¨ã‚¿ã‚¤ãƒãƒ¼
            let autoSaveTimer;
            const AUTO_SAVE_DELAY = 1000; // è‡ªå‹•ä¿å­˜ã®é…å»¶æ™‚é–“ (ãƒŸãƒªç§’)

            // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—é–¢é€£
            let draggedItem = null; // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®è¦ç´ ã‚’ä¿æŒ
            let dragType = null; // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®è¦ç´ ã®ã‚¿ã‚¤ãƒ— (project, character, sequence, scene)

            // --- ãƒ‡ãƒ¼ã‚¿ç®¡ç†é–¢æ•° ---
            function generateId() {
                return '_' + Math.random().toString(36).substr(2, 9);
            }

            // autoSaveFlag: trueã®å ´åˆã€ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤ºã—ãªã„
            function saveProjects(autoSaveFlag = false) {
                localStorage.setItem('plotMakerProjects', JSON.stringify(projects));
                if (!autoSaveFlag) {
                    console.log('Projects saved:', projects); // ãƒ‡ãƒãƒƒã‚°ç”¨
                }
            }

            function loadProjects() {
                const savedProjects = localStorage.getItem('plotMakerProjects');
                projects = savedProjects ? JSON.parse(savedProjects) : [];
                // ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–ãƒã‚§ãƒƒã‚¯ï¼ˆéå»ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‹ã‚‰ã®äº’æ›æ€§ã®ãŸã‚ï¼‰
                projects.forEach(project => {
                    if (!project.characters) project.characters = [];
                    if (!project.sequences) project.sequences = [];
                    project.sequences.forEach(seq => {
                        if (!seq.scenes) seq.scenes = [];
                    });
                });
                console.log('Projects loaded:', projects); // ãƒ‡ãƒãƒƒã‚°ç”¨
                renderProjectList();
            }

            // --- UIãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–¢æ•° ---
            function renderProjectList() {
                projectList.innerHTML = '';
                if (projects.length === 0) {
                    projectList.innerHTML = '<li>ä½œå“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œæ–°ã—ã„ä½œå“ã€ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚</li>';
                    return;
                }
                projects.forEach(project => {
                    const listItem = document.createElement('li');
                    listItem.dataset.id = project.id;
                    listItem.dataset.type = 'project'; // è¿½åŠ 
                    listItem.draggable = true; // è¿½åŠ 
                    if (project.id === currentProjectId) {
                        listItem.classList.add('selected');
                    }

                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = project.name;
                    nameSpan.addEventListener('click', () => selectProject(project.id));
                    listItem.appendChild(nameSpan);

                    const controlsDiv = document.createElement('div');
                    controlsDiv.classList.add('list-item-controls');

                    const editButton = document.createElement('button');
                    editButton.textContent = 'ç·¨é›†';
                    editButton.classList.add('edit-btn');
                    editButton.addEventListener('click', (e) => {
                        e.stopPropagation(); // liã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã—ãªã„ã‚ˆã†ã«ã™ã‚‹
                        editProjectName(project.id);
                    });
                    controlsDiv.appendChild(editButton);

                    listItem.appendChild(controlsDiv);
                    projectList.appendChild(listItem);
                });
                addDragAndDropListeners(projectList); // è¿½åŠ 
            }

            function renderCharacterList() {
                characterList.innerHTML = '';
                const currentProject = projects.find(p => p.id === currentProjectId);
                if (!currentProject || !currentProject.characters || currentProject.characters.length === 0) {
                    characterList.innerHTML = '<li>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</li>';
                    return;
                }
                currentProject.characters.forEach(char => {
                    const listItem = document.createElement('li');
                    listItem.dataset.id = char.id;
                    listItem.dataset.type = 'character'; // è¿½åŠ 
                    listItem.draggable = true; // è¿½åŠ 
                    if (char.id === currentCharacterId) {
                        listItem.classList.add('selected');
                    }
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = char.name;
                    nameSpan.addEventListener('click', (e) => {
                        e.stopPropagation(); // liè¦ç´ ã¸ã®ã‚¯ãƒªãƒƒã‚¯ãŒã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹
                        selectCharacter(char.id);
                    });
                    listItem.appendChild(nameSpan);

                    characterList.appendChild(listItem);
                });
                addDragAndDropListeners(characterList); // è¿½åŠ 
            }

            function renderSequenceList() {
                sequenceList.innerHTML = '';
                const currentProject = projects.find(p => p.id === currentProjectId);
                if (!currentProject || currentProject.sequences.length === 0) {
                    sequenceList.innerHTML = '<li>ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œæ–°ã—ã„ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹ã€ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚</li>';
                    return;
                }
                currentProject.sequences.forEach(seq => {
                    const listItem = document.createElement('li');
                    listItem.dataset.id = seq.id;
                    listItem.dataset.type = 'sequence'; // è¿½åŠ 
                    listItem.draggable = true; // è¿½åŠ 
                    if (seq.id === currentSequenceId) {
                        listItem.classList.add('selected');
                    }

                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = seq.name;
                    nameSpan.addEventListener('click', () => selectSequence(seq.id));
                    listItem.appendChild(nameSpan);

                    const controlsDiv = document.createElement('div');
                    controlsDiv.classList.add('list-item-controls');

                    const editButton = document.createElement('button');
                    editButton.textContent = 'ç·¨é›†';
                    editButton.classList.add('edit-btn');
                    editButton.addEventListener('click', (e) => {
                        e.stopPropagation(); // liã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã—ãªã„ã‚ˆã†ã«ã™ã‚‹
                        editSequenceName(seq.id);
                    });
                    controlsDiv.appendChild(editButton);

                    listItem.appendChild(controlsDiv);
                    sequenceList.appendChild(listItem);
                });
                addDragAndDropListeners(sequenceList); // è¿½åŠ 
            }

            function renderSceneList() {
                sceneList.innerHTML = '';
                const currentProject = projects.find(p => p.id === currentProjectId);
                const currentSequence = currentProject ? currentProject.sequences.find(s => s.id === currentSequenceId) : null;

                if (!currentSequence || currentSequence.scenes.length === 0) {
                    sceneList.innerHTML = '<li>ã‚·ãƒ¼ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œã‚·ãƒ¼ãƒ³ã‚’è¿½åŠ ã€ã—ã¦ãã ã•ã„ã€‚</li>';
                    return;
                }
                currentSequence.scenes.forEach(scene => {
                    const listItem = document.createElement('li');
                    listItem.dataset.id = scene.id;
                    listItem.dataset.type = 'scene'; // è¿½åŠ 
                    listItem.draggable = true; // è¿½åŠ 
                    if (scene.id === currentSceneId) {
                        listItem.classList.add('selected');
                    }
                    let displayTitle = '';
                    if (scene.type === 'timeline') {
                        displayTitle = `[${scene.data.date || 'æ—¥ä»˜ãªã—'}] ${scene.data.event?.substring(0, 30) || 'å‡ºæ¥äº‹ãªã—'}...`;
                    } else if (scene.type === 'character') {
                        // ä½œå“ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒªã‚¹ãƒˆã‹ã‚‰åå‰ã‚’å–å¾—ã€è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°ã‚·ãƒ¼ãƒ³ã®charNameã‚’ä½¿ç”¨
                        const charName = currentProject?.characters.find(c => c.id === scene.data.charId)?.name || scene.data.charName;
                        displayTitle = `ğŸ‘¤ ${charName || 'ä¸æ˜'} (${scene.data.charRole || 'å½¹å‰²ä¸æ˜'})`;
                    } else if (scene.type === 'story') {
                        displayTitle = `ğŸ“– ${scene.data.storyChapter || 'ç« ãªã—'}: ${scene.data.storySummary?.substring(0, 30) || 'æ¦‚è¦ãªã—'}...`;
                    }
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = displayTitle;
                    nameSpan.addEventListener('click', () => selectScene(scene.id));
                    listItem.appendChild(nameSpan);

                    sceneList.appendChild(listItem);
                });
                addDragAndDropListeners(sceneList); // è¿½åŠ 
            }

            function renderSelectedSceneDetails() {
                const currentProject = projects.find(p => p.id === currentProjectId);
                const currentSequence = currentProject ? currentProject.sequences.find(s => s.id === currentSequenceId) : null;
                const currentScene = currentSequence ? currentSequence.scenes.find(sc => sc.id === currentSceneId) : null;

                selectedSceneContent.innerHTML = '';
                if (!currentScene) {
                    selectedSceneContent.textContent = 'ã‚·ãƒ¼ãƒ³ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚';
                    // æç”»ãƒ»ç”»åƒãƒ»ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¨ãƒªã‚¢ã‚‚ã‚¯ãƒªã‚¢
                    clearDrawingCanvas();
                    imagePreviewElement.innerHTML = '';
                    tablePreviewElement.innerHTML = '';
                    currentDrawingData = [];
                    currentImageData = null;
                    currentTableData = null;
                    return;
                }

                let detailHTML = '';
                if (currentScene.type === 'timeline') {
                    detailHTML = `
                        <div class="input-group">
                            <label for="editDate">æ—¥ä»˜/æ™‚æœŸ:</label>
                            <input type="text" id="editDate" value="${currentScene.data.date || ''}" placeholder="ä¾‹: 2023/01/15, ç´€å…ƒå‰500å¹´, å¤">
                        </div>
                        <div class="input-group">
                            <label for="editEvent">å‡ºæ¥äº‹/å†…å®¹:</label>
                            <textarea id="editEvent" placeholder="ä¾‹: ä¸»äººå…¬ãŒæ–°ã—ã„ã‚¹ã‚­ãƒ«ã‚’ç¿’å¾—ã™ã‚‹">${currentScene.data.event || ''}</textarea>
                        </div>
                        <div class="button-group"><button id="saveSceneDetailsButton">ã‚·ãƒ¼ãƒ³å†…å®¹ã‚’ä¿å­˜</button></div>
                    `;
                } else if (currentScene.type === 'character') {
                    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å…ƒã®åå‰ï¼ˆIDç´ä»˜ã‘ã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
                    const originalCharName = currentProject?.characters.find(c => c.id === currentScene.data.charId)?.name || currentScene.data.charName;
                    
                    detailHTML = `
                        <div class="input-group">
                            <label for="editCharName">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å:</label>
                            <input type="text" id="editCharName" value="${originalCharName || ''}" placeholder="ä¾‹: ã‚¨ãƒ«ã‚¶" ${currentScene.data.charId ? 'disabled' : ''}>
                        </div>
                        <div class="input-group">
                            <label for="editCharTrait">ç‰¹å¾´/æ€§æ ¼:</label>
                            <textarea id="editCharTrait" placeholder="ä¾‹: å†·é™æ²ˆç€ã€é­”åŠ›ãŒé«˜ã„">${currentScene.data.charTrait || ''}</textarea>
                        </div>
                        <div class="input-group">
                            <label for="editCharRole">å½¹å‰²:</label>
                            <input type="text" id="editCharRole" value="${currentScene.data.charRole || ''}" placeholder="ä¾‹: ä¸»äººå…¬ã€æ•µå½¹ã€ã‚µãƒãƒ¼ãƒˆ">
                        </div>
                        <div class="button-group">
                            <button id="saveSceneDetailsButton">ã‚·ãƒ¼ãƒ³å†…å®¹ã‚’ä¿å­˜</button>
                            ${currentScene.data.charId ? `<button id="openCharacterDetailFromSceneButton" data-char-id="${currentScene.data.charId}" class="secondary">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è©³ç´°ã‚’é–‹ã</button>` : ''}
                        </div>
                    `;
                } else if (currentScene.type === 'story') {
                    detailHTML = `
                        <div class="input-group">
                            <label for="editStoryChapter">ç« /ã‚·ãƒ¼ãƒ³:</label>
                            <input type="text" id="editStoryChapter" value="${currentScene.data.storyChapter || ''}" placeholder="ä¾‹: ç¬¬1ç« : å‡ºä¼šã„ã€ã‚·ãƒ¼ãƒ³3: è¨“ç·´">
                        </div>
                        <div class="input-group">
                            <label for="editStorySummary">æ¦‚è¦:</label>
                            <textarea id="editStorySummary" placeholder="ä¾‹: ä¸»äººå…¬ã¨ãƒ’ãƒ­ã‚¤ãƒ³ãŒåˆã‚ã¦å‡ºä¼šã„ã€äº’ã„ã®ç›®æ¨™ã‚’çŸ¥ã‚‹">${currentScene.data.storySummary || ''}</textarea>
                        </div>
                        <div class="input-group">
                            <label for="editStoryConflict">è‘›è—¤/è§£æ±º:</label>
                            <textarea id="editStoryConflict" placeholder="ä¾‹: å†…ãªã‚‹è‘›è—¤ã€æ•µã¨ã®å¯¾æ±ºã€æ–°ãŸãªå‹æƒ…">${currentScene.data.storyConflict || ''}</textarea>
                        </div>
                        <div class="button-group"><button id="saveSceneDetailsButton">ã‚·ãƒ¼ãƒ³å†…å®¹ã‚’ä¿å­˜</button></div>
                    `;
                }
                selectedSceneContent.innerHTML = detailHTML;

                // ã‚·ãƒ¼ãƒ³å†…å®¹ä¿å­˜ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                const saveSceneDetailsButton = document.getElementById('saveSceneDetailsButton');
                if (saveSceneDetailsButton) {
                    saveSceneDetailsButton.addEventListener('click', () => {
                        if (currentScene) {
                            if (currentScene.type === 'timeline') {
                                currentScene.data.date = document.getElementById('editDate').value.trim();
                                currentScene.data.event = document.getElementById('editEvent').value.trim();
                            } else if (currentScene.type === 'character') {
                                // æ—¢å­˜ã‚­ãƒ£ãƒ©ã«ç´ä»˜ã„ã¦ã„ã‚‹å ´åˆã¯åå‰ã¯ç·¨é›†ä¸å¯ã€ç‰¹å¾´ã¨å½¹å‰²ã®ã¿
                                if (!currentScene.data.charId) { // æ–°è¦ä½œæˆã—ãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å ´åˆã®ã¿åå‰ã‚‚ç·¨é›†å¯èƒ½
                                    currentScene.data.charName = document.getElementById('editCharName').value.trim();
                                }
                                currentScene.data.charTrait = document.getElementById('editCharTrait').value.trim();
                                currentScene.data.charRole = document.getElementById('editCharRole').value.trim();
                                // ã‚‚ã—charIdãŒã‚ã‚‹ãªã‚‰ã€å…ƒã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æƒ…å ±ã‚‚æ›´æ–°ã™ã‚‹
                                if (currentScene.data.charId) {
                                    const charToUpdate = currentProject?.characters.find(c => c.id === currentScene.data.charId);
                                    if (charToUpdate) {
                                        // charToUpdate.name = currentScene.data.charName; // ã‚·ãƒ¼ãƒ³ã§ç´ä»˜ã„ãŸæ—¢å­˜ã‚­ãƒ£ãƒ©ã®åå‰ã¯å¤‰æ›´ã—ãªã„
                                        charToUpdate.traits = currentScene.data.charTrait;
                                        charToUpdate.role = currentScene.data.charRole;
                                    }
                                }
                            } else if (currentScene.type === 'story') {
                                currentScene.data.storyChapter = document.getElementById('editStoryChapter').value.trim();
                                currentScene.data.storySummary = document.getElementById('editStorySummary').value.trim();
                                currentScene.data.storyConflict = document.getElementById('editStoryConflict').value.trim();
                            }
                            saveProjects();
                            alert('ã‚·ãƒ¼ãƒ³å†…å®¹ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
                            renderSceneList(); // ã‚·ãƒ¼ãƒ³ãƒªã‚¹ãƒˆã®è¡¨ç¤ºã‚‚æ›´æ–°ï¼ˆåå‰ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆãªã©ï¼‰
                            renderSelectedSceneDetails(); // è©³ç´°ã‚’å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã¦æœ€æ–°ã®çŠ¶æ…‹ã‚’åæ˜ 
                        }
                    });
                }

                // è‡ªå‹•ä¿å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å†è¨­å®š (inputãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ãŸã‚)
                const editDateInput = document.getElementById('editDate');
                const editEventTextarea = document.getElementById('editEvent');
                const editCharNameInput = document.getElementById('editCharName');
                const editCharTraitTextarea = document.getElementById('editCharTrait');
                const editCharRoleInput = document.getElementById('editCharRole');
                const editStoryChapterInput = document.getElementById('editStoryChapter');
                const editStorySummaryTextarea = document.getElementById('editStorySummary');
                const editStoryConflictTextarea = document.getElementById('editStoryConflict');

                // å„inputè¦ç´ ã«è‡ªå‹•ä¿å­˜ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                if (editDateInput) editDateInput.addEventListener('input', scheduleAutoSaveSceneDetails);
                if (editEventTextarea) editEventTextarea.addEventListener('input', scheduleAutoSaveSceneDetails);
                if (editCharNameInput) editCharNameInput.addEventListener('input', scheduleAutoSaveSceneDetails);
                if (editCharTraitTextarea) editCharTraitTextarea.addEventListener('input', scheduleAutoSaveSceneDetails);
                if (editCharRoleInput) editCharRoleInput.addEventListener('input', scheduleAutoSaveSceneDetails);
                if (editStoryChapterInput) editStoryChapterInput.addEventListener('input', scheduleAutoSaveSceneDetails);
                if (editStorySummaryTextarea) editStorySummaryTextarea.addEventListener('input', scheduleAutoSaveSceneDetails);
                if (editStoryConflictTextarea) editStoryConflictTextarea.addEventListener('input', scheduleAutoSaveSceneDetails);


                // æç”»ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã¨æç”»
                currentDrawingData = currentScene.drawings || [];
                drawAllDrawings();

                // ç”»åƒãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã¨è¡¨ç¤º
                currentImageData = currentScene.image || null;
                if (currentImageData && currentImageData.dataUrl) {
                    const img = document.createElement('img');
                    img.src = currentImageData.dataUrl;
                    imagePreviewElement.innerHTML = '';
                    imagePreviewElement.appendChild(img);
                } else {
                    imagePreviewElement.innerHTML = '';
                }

                // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã¨è¡¨ç¤º
                currentTableData = currentScene.table || null;
                if (currentTableData) {
                    renderTablePreview(currentTableData);
                } else {
                    tablePreviewElement.innerHTML = '';
                }

                // ã‚·ãƒ¼ãƒ³å†…ã®ã€Œã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è©³ç´°ã‚’é–‹ãã€ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                const openCharDetailBtn = document.getElementById('openCharacterDetailFromSceneButton');
                if (openCharDetailBtn) {
                    openCharDetailBtn.addEventListener('click', (e) => {
                        const charId = e.target.dataset.charId;
                        if (charId) {
                            selectCharacter(charId); // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒªã‚¹ãƒˆã§é¸æŠçŠ¶æ…‹ã«ã—ã¦ã€è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
                        }
                    });
                }
            }


            // --- é¸æŠãƒ»è¡¨ç¤ºåˆ¶å¾¡ ---
            function selectProject(projectId) {
                currentProjectId = projectId;
                currentSequenceId = null; // ä½œå“ãŒå¤‰ã‚ã£ãŸã‚‰ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
                currentSceneId = null; // ã‚·ãƒ¼ãƒ³é¸æŠã‚‚ãƒªã‚»ãƒƒãƒˆ
                currentCharacterId = null; // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠã‚‚ãƒªã‚»ãƒƒãƒˆ

                const selectedProject = projects.find(p => p.id === currentProjectId);
                currentProjectTitle.textContent = selectedProject ? selectedProject.name : 'ä½œå“ã‚’é¸æŠã—ã¦ãã ã•ã„';
                
                // å„ãƒªã‚¹ãƒˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã€UIã®çŠ¶æ…‹ã‚’æ›´æ–°
                renderProjectList();
                renderCharacterList();
                renderSequenceList();
                renderSceneList(); // ã‚·ãƒ¼ãƒ³ãƒªã‚¹ãƒˆã¯currentSequenceIdãŒnullãªã®ã§ç©ºã«ãªã‚‹ã¯ãš

                // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã‚·ãƒ¼ãƒ³é–¢é€£ã‚’éè¡¨ç¤º
                sceneInputSection.style.display = 'none';
                sceneListSection.style.display = 'none';
                sceneDetailsSection.style.display = 'none';
                currentSequenceTitle.style.display = 'none';
                currentSequenceTitle.textContent = ''; // ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹ã‚¿ã‚¤ãƒˆãƒ«ã‚‚ã‚¯ãƒªã‚¢
                selectedSceneContent.innerHTML = ''; // ã‚·ãƒ¼ãƒ³è©³ç´°ã‚‚ã‚¯ãƒªã‚¢
                clearDrawingCanvas();
                imagePreviewElement.innerHTML = '';
                tablePreviewElement.innerHTML = '';

                // å…¨ä½“æ¦‚è¦ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯è¡¨ç¤º
                overallSummarySection.style.display = 'block';
                characterListSection.style.display = 'block';
                sequenceListSection.style.display = 'block';

                updateUIState();
                populateCharacterSelectForScene(); // ã‚·ãƒ¼ãƒ³è¿½åŠ æ™‚ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠè‚¢ã‚’æ›´æ–°
                drawTimeline(); // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠæ™‚ã‚‚ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’åˆæœŸåŒ–
            }

            function selectCharacter(characterId) {
                currentCharacterId = characterId;
                const currentProject = projects.find(p => p.id === currentProjectId);
                const selectedChar = currentProject?.characters.find(c => c.id === currentCharacterId);

                if (selectedChar) {
                    charDetailNameInput.value = selectedChar.name;
                    charDetailTraitInput.value = selectedChar.traits || '';
                    charDetailRoleInput.value = selectedChar.role || '';
                    charDetailSummaryTextarea.value = selectedChar.details || '';
                    characterDetailModal.style.display = 'flex'; // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º

                    // è‡ªå‹•ä¿å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š (ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‰ã˜ã‚‹æ™‚ã«ã¾ã¨ã‚ã¦è§£é™¤ã•ã‚Œã‚‹ã¹ãã ãŒã€å†è¨­å®šã§ä¸Šæ›¸ãã•ã‚Œã‚‹ãŸã‚å•é¡Œã¯å°‘ãªã„)
                    charDetailNameInput.addEventListener('input', scheduleAutoSaveCharacterDetail);
                    charDetailTraitInput.addEventListener('input', scheduleAutoSaveCharacterDetail);
                    charDetailRoleInput.addEventListener('input', scheduleAutoSaveCharacterDetail);
                    charDetailSummaryTextarea.addEventListener('input', scheduleAutoSaveCharacterDetail);

                }
                renderCharacterList(); // é¸æŠçŠ¶æ…‹ã‚’åæ˜ 
                updateUIState();
            }

            function selectSequence(sequenceId) {
                currentSequenceId = sequenceId;
                currentSceneId = null; // ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹ãŒå¤‰ã‚ã£ãŸã‚‰ã‚·ãƒ¼ãƒ³é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
                const currentProject = projects.find(p => p.id === currentProjectId);
                const selectedSequence = currentProject?.sequences.find(s => s.id === currentSequenceId);
                currentSequenceTitle.textContent = selectedSequence ? selectedSequence.name : '';
                currentSequenceTitle.style.display = 'block';

                // ã‚·ãƒ¼ãƒ³å…¥åŠ›ã¨ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
                sceneInputSection.style.display = 'block';
                sceneListSection.style.display = 'block';
                sceneDetailsSection.style.display = 'none'; // ã‚·ãƒ¼ãƒ³è©³ç´°ã‚’éè¡¨ç¤ºã«
                selectedSceneContent.innerHTML = ''; // ã‚·ãƒ¼ãƒ³è©³ç´°ã‚‚ã‚¯ãƒªã‚¢
                clearDrawingCanvas();
                imagePreviewElement.innerHTML = '';
                tablePreviewElement.innerHTML = '';

                renderSequenceList(); // é¸æŠçŠ¶æ…‹ã‚’åæ˜ 
                renderSceneList(); // ã‚·ãƒ¼ãƒ³ãƒªã‚¹ãƒˆã‚’å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°

                updateUIState();
                drawTimeline(); // ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹ãŒé¸æŠã•ã‚ŒãŸã‚‰ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’å†æç”»
            }

            function selectScene(sceneId) {
                currentSceneId = sceneId;
                renderSelectedSceneDetails(); // ã‚·ãƒ¼ãƒ³è©³ç´°ã‚’è¡¨ç¤º

                // ã‚·ãƒ¼ãƒ³è©³ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
                sceneDetailsSection.style.display = 'block';
                
                renderSceneList(); // é¸æŠçŠ¶æ…‹ã‚’åæ˜ 
                updateUIState();
                drawTimeline(); // ã‚·ãƒ¼ãƒ³ãŒé¸æŠã•ã‚ŒãŸã‚‰ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’å†æç”»ï¼ˆé¸æŠã‚·ãƒ¼ãƒ³ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã®ãŸã‚ï¼‰
            }

            function resetMainContentVisibility() {
                // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã™ã¹ã¦ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹åˆæœŸåŒ–é–¢æ•°
                overallSummarySection.style.display = 'none';
                characterListSection.style.display = 'none';
                sequenceListSection.style.display = 'none';
                sceneInputSection.style.display = 'none';
                sceneListSection.style.display = 'none';
                sceneDetailsSection.style.display = 'none';
                currentProjectTitle.textContent = 'ä½œå“ã‚’é¸æŠã—ã¦ãã ã•ã„';
                currentSequenceTitle.style.display = 'none';
                currentSequenceTitle.textContent = '';
                selectedSceneContent.innerHTML = ''; // ã‚·ãƒ¼ãƒ³è©³ç´°ã‚‚ã‚¯ãƒªã‚¢
                clearDrawingCanvas(); // æç”»ã‚¯ãƒªã‚¢
                imagePreviewElement.innerHTML = ''; // ç”»åƒã‚¯ãƒªã‚¢
                tablePreviewElement.innerHTML = ''; // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¯ãƒªã‚¢
            }

            function updateUIState() {
                // å…¨ã¦ã®ãƒªã‚¹ãƒˆã®é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
                document.querySelectorAll('#project-list li').forEach(li => li.classList.remove('selected'));
                if (currentProjectId) {
                    document.querySelector(`#project-list li[data-id="${currentProjectId}"]`)?.classList.add('selected');
                }
                document.querySelectorAll('#character-list li').forEach(li => li.classList.remove('selected'));
                if (currentCharacterId) {
                    document.querySelector(`#character-list li[data-id="${currentCharacterId}"]`)?.classList.add('selected');
                }
                document.querySelectorAll('#sequence-list li').forEach(li => li.classList.remove('selected'));
                if (currentSequenceId) {
                    document.querySelector(`#sequence-list li[data-id="${currentSequenceId}"]`)?.classList.add('selected');
                }
                document.querySelectorAll('#scene-list li').forEach(li => li.classList.remove('selected'));
                if (currentSceneId) {
                    document.querySelector(`#scene-list li[data-id="${currentSceneId}"]`)?.classList.add('selected');
                }

                // å‰Šé™¤ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹
                deleteProjectButton.disabled = !currentProjectId;
                deleteCharacterButton.disabled = !currentCharacterId; // currentProjectIdã«é–¢ã‚ã‚‰ãšã€ã‚­ãƒ£ãƒ©é¸æŠãŒå¿…é ˆ
                deleteSequenceButton.disabled = !currentSequenceId;
                deleteSceneButton.disabled = !currentSceneId;
            }

            // --- è‡ªå‹•ä¿å­˜é–¢é€£é–¢æ•° ---
            function debounce(func, delay) {
                return function(...args) {
                    clearTimeout(autoSaveTimer);
                    autoSaveTimer = setTimeout(() => {
                        func.apply(this, args);
                    }, delay);
                };
            }

            // ã‚·ãƒ¼ãƒ³è¿½åŠ æ™‚ã®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è‡ªå‹•ä¿å­˜ (ã“ã‚Œã¯ã€Œã‚·ãƒ¼ãƒ³ã‚’è¿½åŠ ã€ãƒœã‚¿ãƒ³ã§ç¢ºå®šã•ã‚Œã‚‹ãŸã‚ã€
            // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã”ã¨ã®è‡ªå‹•ä¿å­˜ã¯ç¾çŠ¶ã¯ä¸è¦ã¨åˆ¤æ–­ã—ã¦ã„ã¾ã™ã€‚ã‚‚ã—å¿…è¦ã§ã‚ã‚Œã°ã€
            // `editDateInput`ãªã©ã®ã‚ˆã†ã«å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚)
            // const scheduleAutoSaveSceneInputs = debounce(() => { /* ... */ }, AUTO_SAVE_DELAY);

            // é¸æŠä¸­ã®ã‚·ãƒ¼ãƒ³è©³ç´°ã®è‡ªå‹•ä¿å­˜
            const scheduleAutoSaveSceneDetails = debounce(() => {
                const currentProject = projects.find(p => p.id === currentProjectId);
                const currentSequence = currentProject?.sequences.find(s => s.id === currentSequenceId);
                const currentScene = currentSequence?.scenes.find(sc => sc.id === currentSceneId);

                if (!currentScene) return;

                let dataChanged = false; // å¤‰æ›´ãŒã‚ã£ãŸã‹ã©ã†ã‹ã‚’è¿½è·¡

                // å„å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰å€¤ã‚’å–å¾—ã—ã€ç¾åœ¨ã®ã‚·ãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿ã¨æ¯”è¼ƒã—ã¦æ›´æ–°
                if (currentScene.type === 'timeline') {
                    const newDate = document.getElementById('editDate').value.trim();
                    const newEvent = document.getElementById('editEvent').value.trim();
                    if (currentScene.data.date !== newDate) { currentScene.data.date = newDate; dataChanged = true; }
                    if (currentScene.data.event !== newEvent) { currentScene.data.event = newEvent; dataChanged = true; }
                } else if (currentScene.type === 'character') {
                    // charIdãŒç´ä»˜ã„ã¦ã„ãªã„ï¼ˆæ–°è¦ä½œæˆã•ã‚ŒãŸã‚·ãƒ¼ãƒ³å†…ã‚­ãƒ£ãƒ©ï¼‰ã®å ´åˆã®ã¿charNameã‚‚æ›´æ–°
                    if (!currentScene.data.charId) {
                        const newCharName = document.getElementById('editCharName').value.trim();
                        if (currentScene.data.charName !== newCharName) { currentScene.data.charName = newCharName; dataChanged = true; }
                    }
                    const newCharTrait = document.getElementById('editCharTrait').value.trim();
                    const newCharRole = document.getElementById('editCharRole').value.trim();
                    if (currentScene.data.charTrait !== newCharTrait) { currentScene.data.charTrait = newCharTrait; dataChanged = true; }
                    if (currentScene.data.charRole !== newCharRole) { currentScene.data.charRole = newCharRole; dataChanged = true; }

                    // ç´ä»˜ã‘ã‚‰ã‚ŒãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®è©³ç´°ã‚‚æ›´æ–°ï¼ˆåå‰ã¯å¤‰æ›´ã—ãªã„ï¼‰
                    if (currentScene.data.charId) {
                        const charToUpdate = currentProject?.characters.find(c => c.id === currentScene.data.charId);
                        if (charToUpdate) {
                            if (charToUpdate.traits !== newCharTrait) { charToUpdate.traits = newCharTrait; dataChanged = true; }
                            if (charToUpdate.role !== newCharRole) { charToUpdate.role = newCharRole; dataChanged = true; }
                        }
                    }
                } else if (currentScene.type === 'story') {
                    const newStoryChapter = document.getElementById('editStoryChapter').value.trim();
                    const newStorySummary = document.getElementById('editStorySummary').value.trim();
                    const newStoryConflict = document.getElementById('editStoryConflict').value.trim();
                    if (currentScene.data.storyChapter !== newStoryChapter) { currentScene.data.storyChapter = newStoryChapter; dataChanged = true; }
                    if (currentScene.data.storySummary !== newStorySummary) { currentScene.data.storySummary = newStorySummary; dataChanged = true; }
                    if (currentScene.data.storyConflict !== newStoryConflict) { currentScene.data.storyConflict = newStoryConflict; dataChanged = true; }
                }

                if (dataChanged) {
                    saveProjects(true); // è‡ªå‹•ä¿å­˜ãƒ•ãƒ©ã‚°ã‚’trueã«
                    renderSceneList(); // ãƒªã‚¹ãƒˆè¡¨ç¤ºãŒå¤‰æ›´ã•ã‚ŒãŸå¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§æ›´æ–°
                }
            }, AUTO_SAVE_DELAY);

            // ä½œå“å…¨ä½“æ¦‚è¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã®è‡ªå‹•ä¿å­˜
            const scheduleAutoSaveOverallSummary = debounce(() => {
                const currentProject = projects.find(p => p.id === currentProjectId);
                if (currentProject) {
                    if (currentProject.overallSummary !== overallSummaryTextarea.value) {
                        currentProject.overallSummary = overallSummaryTextarea.value;
                        saveProjects(true);
                    }
                }
            }, AUTO_SAVE_DELAY);

            // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã®è‡ªå‹•ä¿å­˜
            const scheduleAutoSaveCharacterDetail = debounce(() => {
                const currentProject = projects.find(p => p.id === currentProjectId);
                const selectedChar = currentProject?.characters.find(c => c.id === currentCharacterId);
                if (selectedChar) {
                    let dataChanged = false;
                    const newName = charDetailNameInput.value.trim();
                    const newTrait = charDetailTraitInput.value.trim();
                    const newRole = charDetailRoleInput.value.trim();
                    const newDetails = charDetailSummaryTextarea.value.trim();

                    if (selectedChar.name !== newName) { selectedChar.name = newName; dataChanged = true; }
                    if (selectedChar.traits !== newTrait) { selectedChar.traits = newTrait; dataChanged = true; }
                    if (selectedChar.role !== newRole) { selectedChar.role = newRole; dataChanged = true; }
                    if (selectedChar.details !== newDetails) { selectedChar.details = newDetails; dataChanged = true; }

                    if (dataChanged) {
                        saveProjects(true);
                        renderCharacterList(); // åå‰ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã«å‚™ãˆã¦æ›´æ–°
                        // ã‚·ãƒ¼ãƒ³ãƒªã‚¹ãƒˆã‚‚æ›´æ–°ãŒå¿…è¦ãªå ´åˆãŒã‚ã‚‹
                        if (currentProjectId && currentSequenceId) {
                            renderSceneList();
                            renderSelectedSceneDetails(); // é¸æŠä¸­ã®ã‚·ãƒ¼ãƒ³è©³ç´°ã‚‚æ›´æ–°
                        }
                    }
                }
            }, AUTO_SAVE_DELAY);


            // å„å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è‡ªå‹•ä¿å­˜ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¢ã‚¿ãƒƒãƒ
            // ã“ã‚Œã‚‰ã®è¦ç´ ã¯HTMLãƒ­ãƒ¼ãƒ‰æ™‚ã«å­˜åœ¨ã™ã‚‹ãŸã‚ã€ç›´æ¥ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            dateInput.addEventListener('input', scheduleAutoSaveSceneInputs); // ã‚·ãƒ¼ãƒ³è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ã®å…¥åŠ›
            eventInput.addEventListener('input', scheduleAutoSaveSceneInputs);
            charNameInput.addEventListener('input', scheduleAutoSaveSceneInputs);
            charTraitInput.addEventListener('input', scheduleAutoSaveSceneInputs);
            charRoleInput.addEventListener('input', scheduleAutoSaveSceneInputs);
            storyChapterInput.addEventListener('input', scheduleAutoSaveSceneInputs);
            storySummaryInput.addEventListener('input', scheduleAutoSaveSceneInputs);
            storyConflictInput.addEventListener('input', scheduleAutoSaveSceneInputs);

            // å…¨ä½“æ¦‚è¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«ã‚‚è‡ªå‹•ä¿å­˜ã‚’è¨­å®š
            overallSummaryTextarea.addEventListener('input', scheduleAutoSaveOverallSummary);
            charDetailNameInput.addEventListener('input', scheduleAutoSaveCharacterDetail);
            charDetailTraitInput.addEventListener('input', scheduleAutoSaveCharacterDetail);
            charDetailRoleInput.addEventListener('input', scheduleAutoSaveCharacterDetail);
            charDetailSummaryTextarea.addEventListener('input', scheduleAutoSaveCharacterDetail);


            // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
            addProjectButton.addEventListener('click', () => {
                const projectName = prompt('æ–°ã—ã„ä½œå“ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
                if (projectName) {
                    const newProject = {
                        id: generateId(),
                        name: projectName,
                        overallSummary: '',
                        characters: [],
                        sequences: []
                    };
                    projects.push(newProject);
                    saveProjects();
                    selectProject(newProject.id); // æ–°ã—ãä½œã£ãŸä½œå“ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
                }
            });

            // ä½œå“åç·¨é›†é–¢æ•°
            function editProjectName(projectId) {
                const project = projects.find(p => p.id === projectId);
                if (project) {
                    const newName = prompt(`ä½œå“ã€Œ${project.name}ã€ã®æ–°ã—ã„ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:`, project.name);
                    if (newName !== null && newName.trim() !== '' && newName !== project.name) {
                        project.name = newName.trim();
                        saveProjects();
                        renderProjectList();
                        // é¸æŠä¸­ã®ä½œå“åã‚‚æ›´æ–°
                        if (currentProjectId === projectId) {
                            currentProjectTitle.textContent = project.name;
                        }
                        alert('ä½œå“åã‚’æ›´æ–°ã—ã¾ã—ãŸï¼');
                    } else if (newName === null) {
                        // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸå ´åˆ
                        alert('ä½œå“åã®å¤‰æ›´ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚');
                    } else if (newName.trim() === '') {
                        alert('ä½œå“åã¯ç©ºã«ã§ãã¾ã›ã‚“ã€‚');
                    } else if (newName === project.name) {
                        alert('ä½œå“åã¯å¤‰æ›´ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                    }
                }
            }


            deleteProjectButton.addEventListener('click', () => {
                if (!currentProjectId) {
                    alert('å‰Šé™¤ã™ã‚‹ä½œå“ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                const currentProjectName = projects.find(p => p.id === currentProjectId)?.name;
                if (confirm(`ä½œå“ã€Œ${currentProjectName}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`)) {
                    projects = projects.filter(p => p.id !== currentProjectId);
                    currentProjectId = null;
                    currentSequenceId = null;
                    currentSceneId = null;
                    currentCharacterId = null; 
                    saveProjects();
                    renderProjectList(); // ä½œå“ãƒªã‚¹ãƒˆã‚’å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                    resetMainContentVisibility(); // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å®Œå…¨ã«ãƒªã‚»ãƒƒãƒˆ
                    updateUIState();
                }
            });

            // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¿½åŠ 
            addCharacterButton.addEventListener('click', () => {
                if (!currentProjectId) {
                    alert('å…ˆã«ä½œå“ã‚’é¸æŠã¾ãŸã¯ä½œæˆã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                const charName = prompt('æ–°ã—ã„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
                if (charName) {
                    const currentProject = projects.find(p => p.id === currentProjectId);
                    if (currentProject) {
                        const newCharacter = {
                            id: generateId(),
                            name: charName,
                            traits: '',
                            role: '',
                            details: ''
                        };
                        currentProject.characters.push(newCharacter);
                        saveProjects();
                        renderCharacterList(); // ãƒªã‚¹ãƒˆã‚’æ›´æ–°
                        populateCharacterSelectForScene(); // ã‚·ãƒ¼ãƒ³ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚‚æ›´æ–°
                        selectCharacter(newCharacter.id); // æ–°ã—ã„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸æŠã—ã€è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
                    }
                }
            });

            // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å‰Šé™¤
            deleteCharacterButton.addEventListener('click', () => {
                if (!currentCharacterId) {
                    alert('å‰Šé™¤ã™ã‚‹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                const currentProject = projects.find(p => p.id === currentProjectId);
                const currentCharacterName = currentProject?.characters.find(c => c.id === currentCharacterId)?.name;
                if (confirm(`ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€Œ${currentCharacterName}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`)) {
                    if (currentProject) {
                        currentProject.characters = currentProject.characters.filter(c => c.id !== currentCharacterId);
                        
                        // å‰Šé™¤ã•ã‚ŒãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒã‚·ãƒ¼ãƒ³ã«ç´ä»˜ã„ã¦ã„ãŸå ´åˆã€ã‚·ãƒ¼ãƒ³å†…ã®charIdã‚’ã‚¯ãƒªã‚¢
                        currentProject.sequences.forEach(seq => {
                            seq.scenes.forEach(scene => {
                                if (scene.type === 'character' && scene.data.charId === currentCharacterId) {
                                    delete scene.data.charId; // IDã‚’å‰Šé™¤
                                    // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã€åå‰ã‚„å½¹å‰²ã‚‚ã‚¯ãƒªã‚¢ã™ã‚‹
                                    scene.data.charName = '(å‰Šé™¤æ¸ˆã¿ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼)'; 
                                    scene.data.charTrait = '';
                                    scene.data.charRole = '';
                                }
                            });
                        });

                        currentCharacterId = null; // é¸æŠè§£é™¤
                        saveProjects();
                        renderCharacterList(); // ãƒªã‚¹ãƒˆã‚’æ›´æ–°
                        populateCharacterSelectForScene(); // ã‚·ãƒ¼ãƒ³ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚‚æ›´æ–°
                        // ã‚·ãƒ¼ãƒ³ãƒªã‚¹ãƒˆã‚‚æ›´æ–°ãŒå¿…è¦ãªå ´åˆãŒã‚ã‚‹ï¼ˆå‰Šé™¤ã•ã‚ŒãŸã‚­ãƒ£ãƒ©ãŒä½¿ã‚ã‚Œã¦ã„ãŸã‚·ãƒ¼ãƒ³ã®è¡¨ç¤ºæ›´æ–°ï¼‰
                        if (currentSequenceId) {
                            renderSceneList();
                            renderSelectedSceneDetails(); // ã‚‚ã—é¸æŠä¸­ã®ã‚·ãƒ¼ãƒ³ãŒå‰Šé™¤ã•ã‚ŒãŸã‚­ãƒ£ãƒ©ã®ã‚‚ã®ãªã‚‰ã€è©³ç´°ã‚‚æ›´æ–°
                        }
                        updateUIState();
                        characterDetailModal.style.display = 'none'; // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                    }
                }
            });

            addSequenceButton.addEventListener('click', () => {
                if (!currentProjectId) {
                    alert('å…ˆã«ä½œå“ã‚’é¸æŠã¾ãŸã¯ä½œæˆã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                const sequenceName = prompt('æ–°ã—ã„ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
                if (sequenceName) {
                    const currentProject = projects.find(p => p.id === currentProjectId);
                    if (currentProject) {
                        const newSequence = {
                            id: generateId(),
                            name: sequenceName,
                            scenes: []
                        };
                        currentProject.sequences.push(newSequence);
                        saveProjects();
                        selectSequence(newSequence.id); // æ–°ã—ãä½œã£ãŸã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
                    }
                }
            });

            // ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹åç·¨é›†é–¢æ•°
            function editSequenceName(sequenceId) {
                const currentProject = projects.find(p => p.id === currentProjectId);
                if (!currentProject) return;

                const sequence = currentProject.sequences.find(s => s.id === sequenceId);
                if (sequence) {
                    const newName = prompt(`ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹ã€Œ${sequence.name}ã€ã®æ–°ã—ã„ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:`, sequence.name);
                    if (newName !== null && newName.trim() !== '' && newName !== sequence.name) {
                        sequence.name = newName.trim();
                        saveProjects();
                        renderSequenceList();
                        // é¸æŠä¸­ã®ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹åã‚‚æ›´æ–°
                        if (currentSequenceId === sequenceId) {
                            currentSequenceTitle.textContent = sequence.name;
                        }
                        alert('ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹åã‚’æ›´æ–°ã—ã¾ã—ãŸï¼');
                    } else if (newName === null) {
                        // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸå ´åˆ
                        alert('ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹åã®å¤‰æ›´ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚');
                    } else if (newName.trim() === '') {
                        alert('ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹åã¯ç©ºã«ã§ãã¾ã›ã‚“ã€‚');
                    } else if (newName === sequence.name) {
                        alert('ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹åã¯å¤‰æ›´ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                    }
                }
            }

            deleteSequenceButton.addEventListener('click', () => {
                if (!currentSequenceId) {
                    alert('å‰Šé™¤ã™ã‚‹ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                const currentProject = projects.find(p => p.id === currentProjectId);
                const currentSequenceName = currentProject?.sequences.find(s => s.id === currentSequenceId)?.name;
                if (confirm(`ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹ã€Œ${currentSequenceName}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`)) {
                    if (currentProject) {
                        currentProject.sequences = currentProject.sequences.filter(s => s.id !== currentSequenceId);
                        currentSequenceId = null;
                        currentSceneId = null; // ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹å‰Šé™¤ã§ã‚·ãƒ¼ãƒ³é¸æŠã‚‚ãƒªã‚»ãƒƒãƒˆ
                        saveProjects();
                        renderSequenceList(); // ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹ãƒªã‚¹ãƒˆã‚’å†æç”»
                        
                        // ã‚·ãƒ¼ãƒ³é–¢é€£ã®UIã‚’éè¡¨ç¤ºã«
                        sceneInputSection.style.display = 'none';
                        sceneListSection.style.display = 'none';
                        sceneDetailsSection.style.display = 'none';
                        currentSequenceTitle.style.display = 'none';
                        currentSequenceTitle.textContent = '';
                        selectedSceneContent.innerHTML = '';
                        clearDrawingCanvas();
                        imagePreviewElement.innerHTML = '';
                        tablePreviewElement.innerHTML = '';
                        updateUIState();
                        drawTimeline(); // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚‚æ›´æ–°
                    }
                }
            });

            addSceneButton.addEventListener('click', () => {
                if (!currentProjectId || !currentSequenceId) {
                    alert('å…ˆã«ä½œå“ã¨ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                let newSceneData = {};
                let sceneType = document.querySelector('input[name="plotType"]:checked').value;

                if (sceneType === 'timeline') {
                    const date = dateInput.value.trim();
                    const event = eventInput.value.trim();
                    if (!date || !event) { alert('æ—¥ä»˜ã¨å‡ºæ¥äº‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
                    newSceneData = { date, event };
                } else if (sceneType === 'character') {
                    const selectedCharId = characterSelectForScene.value;
                    let charName = charNameInput.value.trim();
                    let charTrait = charTraitInput.value.trim();
                    let charRole = charRoleInput.value.trim();

                    if (selectedCharId) { // æ—¢å­˜ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸æŠã—ãŸå ´åˆ
                        const currentProject = projects.find(p => p.id === currentProjectId);
                        const selectedChar = currentProject?.characters.find(c => c.id === selectedCharId);
                        if (selectedChar) {
                            newSceneData = {
                                charId: selectedChar.id, // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼IDã‚’ç´ä»˜ã‘
                                charName: selectedChar.name, // åå‰ã¯ã‚·ãƒ¼ãƒ³ã«ã‚‚è¨˜éŒ²ï¼ˆè¡¨ç¤ºç”¨ï¼‰
                                charTrait: selectedChar.traits, // ã‚·ãƒ¼ãƒ³ã«ã‚‚è¨˜éŒ²
                                charRole: selectedChar.role // ã‚·ãƒ¼ãƒ³ã«ã‚‚è¨˜éŒ²
                            };
                        }
                    } else { // æ–°ã—ã„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’è¿½åŠ ã™ã‚‹å ´åˆ
                        if (!charName) { alert('ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
                        newSceneData = { charName, charTrait, charRole };

                        // æ–°ã—ã„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ä½œå“ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒªã‚¹ãƒˆã«ã‚‚è¿½åŠ 
                        const currentProject = projects.find(p => p.id === currentProjectId);
                        if (currentProject) {
                            if (!currentProject.characters) {
                                currentProject.characters = [];
                            }
                            const newCharacter = {
                                id: generateId(),
                                name: charName,
                                traits: charTrait,
                                role: charRole,
                                details: '' // æ–°è¦ä½œæˆæ™‚ã¯ç©º
                            };
                            currentProject.characters.push(newCharacter);
                            newSceneData.charId = newCharacter.id; // ã‚·ãƒ¼ãƒ³ã«ã‚‚IDã‚’ç´ä»˜ã‘
                            saveProjects(); // ã“ã“ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã‚’ä¿å­˜
                            renderCharacterList(); // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒªã‚¹ãƒˆã‚’æ›´æ–°
                            populateCharacterSelectForScene(); // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚‚æ›´æ–°
                        }
                    }
                } else if (sceneType === 'story') {
                    const storyChapter = storyChapterInput.value.trim();
                    const storySummary = storySummaryInput.value.trim();
                    const storyConflict = storyConflictInput.value.trim();
                    if (!storyChapter || !storySummary) { alert('ç« /ã‚·ãƒ¼ãƒ³ã¨æ¦‚è¦ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
                    newSceneData = { storyChapter, storySummary, storyConflict };
                }

                const newScene = {
                    id: generateId(),
                    type: sceneType,
                    data: newSceneData,
                    drawings: [], // è¿½åŠ æ™‚ã¯ç©ºã§åˆæœŸåŒ–
                    image: null,     // è¿½åŠ æ™‚ã¯ç©ºã§åˆæœŸåŒ–
                    table: null      // è¿½åŠ æ™‚ã¯ç©ºã§åˆæœŸåŒ–
                };

                const currentProject = projects.find(p => p.id === currentProjectId);
                const currentSequence = currentProject?.sequences.find(s => s.id === currentSequenceId);
                if (currentSequence) {
                    currentSequence.scenes.push(newScene);
                    saveProjects();
                    renderSceneList(); // ã‚·ãƒ¼ãƒ³ãƒªã‚¹ãƒˆã‚’å†æç”»
                    selectScene(newScene.id); // è¿½åŠ ã—ãŸã‚·ãƒ¼ãƒ³ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
                    clearSceneInputs(); // ã‚·ãƒ¼ãƒ³è¿½åŠ å¾Œã«å…¥åŠ›æ¬„ã¨ä»˜å±ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
                }
            });

            deleteSceneButton.addEventListener('click', () => {
                if (!currentSceneId) {
                    alert('å‰Šé™¤ã™ã‚‹ã‚·ãƒ¼ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                const currentProject = projects.find(p => p.id === currentProjectId);
                const currentSequence = currentProject?.sequences.find(s => s.id === currentSequenceId);
                
                if (currentSequence) {
                    // ã‚·ãƒ¼ãƒ³ã®å‰Šé™¤
                    currentSequence.scenes = currentSequence.scenes.filter(sc => sc.id !== currentSceneId);
                    currentSceneId = null; // å‰Šé™¤å¾Œã«é¸æŠä¸­ã®ã‚·ãƒ¼ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
                    saveProjects();
                    renderSceneList(); // ã‚·ãƒ¼ãƒ³ãƒªã‚¹ãƒˆã‚’å†æç”»

                    // ã‚·ãƒ¼ãƒ³è©³ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤ºã«ã—ã€å†…å®¹ã‚’ã‚¯ãƒªã‚¢
                    sceneDetailsSection.style.display = 'none';
                    selectedSceneContent.innerHTML = '';
                    clearDrawingCanvas();
                    imagePreviewElement.innerHTML = '';
                    tablePreviewElement.innerHTML = '';
                    updateUIState();
                    drawTimeline(); // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚‚æ›´æ–°
                }
            });

            clearSceneInputsButton.addEventListener('click', clearSceneInputs);

            function clearSceneInputs() {
                dateInput.value = '';
                eventInput.value = '';
                charNameInput.value = '';
                charTraitInput.value = '';
                charRoleInput.value = '';
                characterSelectForScene.value = ''; // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚‚ãƒªã‚»ãƒƒãƒˆ
                charNameInput.disabled = false; // æ–°è¦å…¥åŠ›æ¬„ã‚’æœ‰åŠ¹ã«
                charTraitInput.disabled = false;
                charRoleInput.disabled = false;

                storyChapterInput.value = '';
                storySummaryInput.value = '';
                storyConflictInput.value = '';

                // æç”»ãƒ»ç”»åƒãƒ»ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
                currentDrawingData = [];
                clearDrawingCanvas();
                currentImageData = null;
                imagePreviewElement.innerHTML = '';
                currentTableData = null;
                tablePreviewElement.innerHTML = '';
            }

            // ãƒ—ãƒ­ãƒƒãƒˆã‚¿ã‚¤ãƒ—åˆ‡ã‚Šæ›¿ãˆ
            radioButtons.forEach(radio => {
                radio.addEventListener('change', (event) => {
                    const plotType = event.target.value;
                    timelineInputs.style.display = 'none';
                    characterInputs.style.display = 'none';
                    storyInputs.style.display = 'none';
                    if (plotType === 'timeline') {
                        timelineInputs.style.display = 'block';
                    } else if (plotType === 'character') {
                        characterInputs.style.display = 'block';
                        populateCharacterSelectForScene(); // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠè‚¢ã‚’æ›´æ–°
                    } else if (plotType === 'story') {
                        storyInputs.style.display = 'block';
                    }
                    clearSceneInputs(); // å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ åˆ‡ã‚Šæ›¿ãˆæ™‚ã‚‚ã‚¯ãƒªã‚¢
                });
            });

            // ã‚·ãƒ¼ãƒ³ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ—ãƒ­ãƒƒãƒˆå…¥åŠ›æ™‚ã«æ—¢å­˜ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸æŠã™ã‚‹ãŸã‚ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’ç”Ÿæˆ
            function populateCharacterSelectForScene() {
                characterSelectForScene.innerHTML = '<option value="">-- æ–°ã—ã„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ --</option>';
                const currentProject = projects.find(p => p.id === currentProjectId);
                if (currentProject && currentProject.characters) {
                    currentProject.characters.forEach(char => {
                        const option = document.createElement('option');
                        option.value = char.id;
                        option.textContent = char.name;
                        characterSelectForScene.appendChild(option);
                    });
                }
            }

            // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³é¸æŠæ™‚ã€åå‰ãƒ»ç‰¹å¾´ãƒ»å½¹å‰²ã®å…¥åŠ›æ¬„ã‚’ç„¡åŠ¹åŒ–/æœ‰åŠ¹åŒ–
            characterSelectForScene.addEventListener('change', () => {
                const isExistingCharSelected = characterSelectForScene.value !== '';
                charNameInput.disabled = isExistingCharSelected;
                charTraitInput.disabled = isExistingCharSelected;
                charRoleInput.disabled = isExistingCharSelected;

                // æ—¢å­˜ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸æŠã—ãŸå ´åˆã€ãã®æƒ…å ±ã‚’å…¥åŠ›æ¬„ã«è¡¨ç¤ºï¼ˆç·¨é›†ã¯ä¸å¯ã ãŒå‚è€ƒç”¨ï¼‰
                if (isExistingCharSelected) {
                    const currentProject = projects.find(p => p.id === currentProjectId);
                    const selectedChar = currentProject?.characters.find(c => c.id === characterSelectForScene.value);
                    if (selectedChar) {
                        charNameInput.value = selectedChar.name;
                        charTraitInput.value = selectedChar.traits;
                        charRoleInput.value = selectedChar.role;
                    }
                } else {
                    charNameInput.value = '';
                    charTraitInput.value = '';
                    charRoleInput.value = '';
                }
            });


            // --- å…¨ä½“æ¦‚è¦ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ ---
            openOverallSummaryModalButton.addEventListener('click', () => {
                const currentProject = projects.find(p => p.id === currentProjectId);
                if (currentProject) {
                    overallSummaryTextarea.value = currentProject.overallSummary || '';
                    overallSummaryModal.style.display = 'flex'; // Flexboxã§ä¸­å¤®è¡¨ç¤º
                }
            });

            closeOverallSummaryModalButton.addEventListener('click', () => {
                overallSummaryModal.style.display = 'none';
            });

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            overallSummaryModal.addEventListener('click', (event) => {
                if (event.target === overallSummaryModal) {
                    overallSummaryModal.style.display = 'none';
                }
            });

            saveOverallSummaryButton.addEventListener('click', () => {
                const currentProject = projects.find(p => p.id === currentProjectId);
                if (currentProject) {
                    currentProject.overallSummary = overallSummaryTextarea.value;
                    saveProjects();
                    alert('å…¨ä½“æ¦‚è¦ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
                    overallSummaryModal.style.display = 'none';
                }
            });

            // --- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ ---
            // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒªã‚¹ãƒˆã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã¯renderCharacterListå†…ã§è¨­å®š
            closeCharacterDetailModalButton.addEventListener('click', () => {
                characterDetailModal.style.display = 'none';
                currentCharacterId = null; // é¸æŠè§£é™¤
                updateUIState();
                renderCharacterList(); // é¸æŠè§£é™¤ã‚’UIã«åæ˜ 
            });

            characterDetailModal.addEventListener('click', (event) => {
                if (event.target === characterDetailModal) {
                    characterDetailModal.style.display = 'none';
                    currentCharacterId = null; // é¸æŠè§£é™¤
                    updateUIState();
                    renderCharacterList(); // é¸æŠè§£é™¤ã‚’UIã«åæ˜ 
                }
            });

            saveCharacterDetailButton.addEventListener('click', () => {
                const currentProject = projects.find(p => p.id === currentProjectId);
                const selectedChar = currentProject?.characters.find(c => c.id === currentCharacterId);
                if (selectedChar) {
                    selectedChar.name = charDetailNameInput.value.trim();
                    selectedChar.traits = charDetailTraitInput.value.trim();
                    selectedChar.role = charDetailRoleInput.value.trim();
                    selectedChar.details = charDetailSummaryTextarea.value.trim();
                    saveProjects();
                    alert('ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è©³ç´°ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
                    characterDetailModal.style.display = 'none';
                    renderCharacterList(); // ãƒªã‚¹ãƒˆè¡¨ç¤ºã‚’æ›´æ–°
                    populateCharacterSelectForScene(); // ã‚·ãƒ¼ãƒ³ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚‚æ›´æ–°
                    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã€ã‚·ãƒ¼ãƒ³ãƒªã‚¹ãƒˆã®è¡¨ç¤ºã‚‚æ›´æ–°ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
                    if (currentProjectId && currentSequenceId) { // ç¾åœ¨ä½œå“ã¨ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹ãŒé¸æŠã•ã‚Œã¦ã„ã‚Œã°
                        renderSceneList();
                        renderSelectedSceneDetails(); // é¸æŠä¸­ã®ã‚·ãƒ¼ãƒ³è©³ç´°ã‚‚æ›´æ–°
                    }
                }
            });


            // --- æç”»æ©Ÿèƒ½ ---
            function clearDrawingCanvas() {
                drawingContext.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
            }

            function drawAllDrawings() {
                clearDrawingCanvas();
                drawingContext.lineCap = 'round'; // ç·šç«¯ã®ã‚¹ã‚¿ã‚¤ãƒ«
                drawingContext.lineJoin = 'round'; // ç·šçµåˆéƒ¨ã®ã‚¹ã‚¿ã‚¤ãƒ«

                currentDrawingData.forEach(path => {
                    drawingContext.beginPath();
                    drawingContext.strokeStyle = path.color;
                    drawingContext.lineWidth = path.thickness;
                    if (path.points.length > 0) {
                        drawingContext.moveTo(path.points[0].x, path.points[0].y);
                        for(let i = 1; i < path.points.length; i++) {
                            drawingContext.lineTo(path.points[i].x, path.points[i].y);
                        }
                    }
                    drawingContext.stroke();
                });
            }

            drawingModeButton.addEventListener('click', () => {
                isDrawingMode = !isDrawingMode;
                drawingModeButton.textContent = isDrawingMode ? 'æç”»ãƒ¢ãƒ¼ãƒ‰çµ‚äº†' : 'æç”»ãƒ¢ãƒ¼ãƒ‰é–‹å§‹';
                drawingModeButton.classList.toggle('danger', isDrawingMode);
                drawingCanvas.style.cursor = isDrawingMode ? 'crosshair' : 'default';
                if (!currentSceneId && isDrawingMode) {
                    alert('ã‚·ãƒ¼ãƒ³ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚æç”»ã¯ä¸€æ™‚çš„ã§ã€ã‚·ãƒ¼ãƒ³ã«ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚ã‚·ãƒ¼ãƒ³ã‚’é¸æŠã—ã¦ã‹ã‚‰æç”»ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚');
                    isDrawingMode = false; // ã‚·ãƒ¼ãƒ³ãŒãªã„å ´åˆã¯æç”»ãƒ¢ãƒ¼ãƒ‰ã‚’å¼·åˆ¶çµ‚äº†
                    drawingModeButton.textContent = 'æç”»ãƒ¢ãƒ¼ãƒ‰é–‹å§‹';
                    drawingModeButton.classList.remove('danger');
                    drawingCanvas.style.cursor = 'default';
                    return;
                } else if (isDrawingMode) {
                     alert('æç”»ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚');
                } else {
                    alert('æç”»ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†ã—ã¾ã—ãŸã€‚');
                }
            });

            drawingCanvas.addEventListener('mousedown', (e) => {
                if (!isDrawingMode || !currentSceneId) return;
                isDrawing = true;
                const rect = drawingCanvas.getBoundingClientRect();
                lastX = e.clientX - rect.left;
                lastY = e.clientY - rect.top;
                drawingPath = [{ x: lastX, y: lastY }];
            });

            drawingCanvas.addEventListener('mousemove', (e) => {
                if (!isDrawing || !isDrawingMode || !currentSceneId) return;
                const rect = drawingCanvas.getBoundingClientRect();
                const currentX = e.clientX - rect.left;
                const currentY = e.clientY - rect.top;

                drawingContext.beginPath();
                drawingContext.moveTo(lastX, lastY);
                drawingContext.lineTo(currentX, currentY);
                drawingContext.strokeStyle = lineColorInput.value;
                drawingContext.lineWidth = lineThicknessInput.value;
                drawingContext.stroke();

                drawingPath.push({ x: currentX, y: currentY });
                lastX = currentX;
                lastY = currentY;
            });

            drawingCanvas.addEventListener('mouseup', () => {
                if (isDrawing && isDrawingMode && currentSceneId) {
                    currentDrawingData.push({
                        points: drawingPath,
                        color: lineColorInput.value,
                        thickness: lineThicknessInput.value
                    });
                    isDrawing = false;
                    // ã‚·ãƒ¼ãƒ³ãŒé¸æŠã•ã‚Œã¦ã„ã‚Œã°ã€æç”»ãƒ‡ãƒ¼ã‚¿ã‚’ã‚·ãƒ¼ãƒ³ã«ä¿å­˜
                    const currentProject = projects.find(p => p.id === currentProjectId);
                    const currentSequence = currentProject?.sequences.find(s => s.id === currentSequenceId);
                    const currentScene = currentSequence?.scenes.find(sc => sc.id === currentSceneId);
                    if (currentScene) {
                        currentScene.drawings = currentDrawingData;
                        saveProjects(true); // è‡ªå‹•ä¿å­˜
                    }
                }
            });

            // ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹å‘ã‘ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ
            drawingCanvas.addEventListener('touchstart', (e) => {
                if (!isDrawingMode || !currentSceneId) return;
                e.preventDefault(); // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãªã©ã‚’é˜²ã
                isDrawing = true;
                const rect = drawingCanvas.getBoundingClientRect();
                lastX = e.touches[0].clientX - rect.left;
                lastY = e.touches[0].clientY - rect.top;
                drawingPath = [{ x: lastX, y: lastY }];
            });

            drawingCanvas.addEventListener('touchmove', (e) => {
                if (!isDrawing || !isDrawingMode || !currentSceneId) return;
                e.preventDefault(); // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãªã©ã‚’é˜²ã
                const rect = drawingCanvas.getBoundingClientRect();
                const currentX = e.touches[0].clientX - rect.left;
                const currentY = e.touches[0].clientY - rect.top;

                drawingContext.beginPath();
                drawingContext.moveTo(lastX, lastY);
                drawingContext.lineTo(currentX, currentY);
                drawingContext.strokeStyle = lineColorInput.value;
                drawingContext.lineWidth = lineThicknessInput.value;
                drawingContext.stroke();

                drawingPath.push({ x: currentX, y: currentY });
                lastX = currentX;
                lastY = currentY;
            });

            drawingCanvas.addEventListener('touchend', () => {
                if (isDrawing && isDrawingMode && currentSceneId) {
                    currentDrawingData.push({
                        points: drawingPath,
                        color: lineColorInput.value,
                        thickness: lineThicknessInput.value
                    });
                    isDrawing = false;
                    const currentProject = projects.find(p => p.id === currentProjectId);
                    const currentSequence = currentProject?.sequences.find(s => s.id === currentSequenceId);
                    const currentScene = currentSequence?.scenes.find(sc => sc.id === currentSceneId);
                    if (currentScene) {
                        currentScene.drawings = currentDrawingData;
                        saveProjects(true); // è‡ªå‹•ä¿å­˜
                    }
                }
            });

            clearDrawingButton.addEventListener('click', () => {
                if (confirm('æç”»ã‚’å…¨ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                    clearDrawingCanvas();
                    currentDrawingData = [];
                    const currentProject = projects.find(p => p.id === currentProjectId);
                    const currentSequence = currentProject?.sequences.find(s => s.id === currentSequenceId);
                    const currentScene = currentSequence?.scenes.find(sc => sc.id === currentSceneId);
                    if (currentScene) {
                        currentScene.drawings = currentDrawingData; // ç©ºã®é…åˆ—ã‚’ä¿å­˜
                        saveProjects(); // æ‰‹å‹•ä¿å­˜ãªã®ã§ã‚¢ãƒ©ãƒ¼ãƒˆã¯æ®‹ã™
                        alert('æç”»ã‚’ã‚¯ãƒªã‚¢ã—ã¦ä¿å­˜ã—ã¾ã—ãŸã€‚');
                    } else {
                        alert('æç”»ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚'); // ã‚·ãƒ¼ãƒ³ãŒé¸æŠã•ã‚Œã¦ã„ãªãã¦ã‚‚Canvasã¯ã‚¯ãƒªã‚¢
                    }
                }
            });


            // --- ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ ---
            imageUploadInput.addEventListener('change', (event) => {
                if (!currentSceneId) {
                    alert('ç”»åƒã‚’ä¿å­˜ã™ã‚‹ã«ã¯ã‚·ãƒ¼ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    imageUploadInput.value = ''; // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
                    return;
                }
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        currentImageData = { dataUrl: e.target.result, name: file.name };
                        const img = document.createElement('img');
                        img.src = currentImageData.dataUrl;
                        imagePreviewElement.innerHTML = '';
                        imagePreviewElement.appendChild(img);

                        // ã‚·ãƒ¼ãƒ³ãŒé¸æŠã•ã‚Œã¦ã„ã‚Œã°ã€ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’ã‚·ãƒ¼ãƒ³ã«ä¿å­˜
                        const currentProject = projects.find(p => p.id === currentProjectId);
                        const currentSequence = currentProject?.sequences.find(s => s.id === currentSequenceId);
                        const currentScene = currentSequence?.scenes.find(sc => sc.id === currentSceneId);
                        if (currentScene) {
                            currentScene.image = currentImageData;
                            saveProjects(); // ç”»åƒã¯è‡ªå‹•ä¿å­˜ã—ãªã„ï¼ˆæ‰‹å‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†æ™‚ã®ã¿ï¼‰
                            alert('ç”»åƒã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
                        }
                    };
                    reader.readAsDataURL(file);
                } else { // ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œãšã«å¤‰æ›´ã•ã‚ŒãŸï¼ˆä¾‹ãˆã°ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸï¼‰å ´åˆ
                    currentImageData = null;
                    imagePreviewElement.innerHTML = '';
                    const currentProject = projects.find(p => p.id === currentProjectId);
                    const currentSequence = currentProject?.sequences.find(s => s.id === currentSequenceId);
                    const currentScene = currentSequence?.scenes.find(sc => sc.id === currentSceneId);
                    if (currentScene) {
                        delete currentScene.image; // ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
                        saveProjects(); // æ‰‹å‹•ä¿å­˜
                        alert('ç”»åƒã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
                    }
                }
            });

            // --- ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ ---
            function renderTablePreview(data) {
                if (!data || data.length === 0) {
                    tablePreviewElement.innerHTML = '';
                    return;
                }
                const table = document.createElement('table');
                table.innerHTML = ''; // ã‚¯ãƒªã‚¢

                data.forEach((row, rowIndex) => {
                    const tr = document.createElement('tr');
                    row.forEach((cell, colIndex) => {
                        const td = document.createElement('td');
                        td.textContent = cell;
                        td.contentEditable = true; // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ç·¨é›†å¯èƒ½ã«ã™ã‚‹
                        td.dataset.rowIndex = rowIndex;
                        td.dataset.colIndex = colIndex;
                        td.addEventListener('blur', (e) => { // blurã‚¤ãƒ™ãƒ³ãƒˆã§è‡ªå‹•ä¿å­˜
                            // ç·¨é›†å†…å®¹ã‚’currentTableDataã«åæ˜ 
                            currentTableData[parseInt(e.target.dataset.rowIndex)][parseInt(e.target.dataset.colIndex)] = e.target.textContent;
                            // ã‚·ãƒ¼ãƒ³ãŒé¸æŠã•ã‚Œã¦ã„ã‚Œã°ã€ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚·ãƒ¼ãƒ³ã«ä¿å­˜
                            const currentProject = projects.find(p => p.id === currentProjectId);
                            const currentSequence = currentProject?.sequences.find(s => s.id === currentSequenceId);
                            const currentScene = currentSequence?.scenes.find(sc => sc.id === currentSceneId);
                            if (currentScene) {
                                currentScene.table = currentTableData;
                                saveProjects(true); // è‡ªå‹•ä¿å­˜
                            }
                        });
                        tr.appendChild(td);
                    });
                    table.appendChild(tr);
                });
                tablePreviewElement.innerHTML = '';
                tablePreviewElement.appendChild(table);
            }

            createTableButton.addEventListener('click', () => {
                if (!currentSceneId) {
                    alert('ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä¿å­˜ã™ã‚‹ã«ã¯ã‚·ãƒ¼ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                const rows = parseInt(tableRowsInput.value) || 3;
                const cols = parseInt(tableColsInput.value) || 3;
                if (rows > 0 && cols > 0) {
                    currentTableData = Array.from({ length: rows }, () => Array(cols).fill(''));
                    renderTablePreview(currentTableData);
                    // ã‚·ãƒ¼ãƒ³ãŒé¸æŠã•ã‚Œã¦ã„ã‚Œã°ã€ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚·ãƒ¼ãƒ³ã«ä¿å­˜
                    const currentProject = projects.find(p => p.id === currentProjectId);
                    const currentSequence = currentProject?.sequences.find(s => s.id === currentSequenceId);
                    const currentScene = currentSequence?.scenes.find(sc => sc.id === currentSceneId);
                    if (currentScene) {
                        currentScene.table = currentTableData;
                        saveProjects(); // æ‰‹å‹•ä¿å­˜ãªã®ã§ã‚¢ãƒ©ãƒ¼ãƒˆã¯æ®‹ã™
                        alert('ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆãƒ»ä¿å­˜ã—ã¾ã—ãŸã€‚');
                    }
                } else {
                    alert('è¡Œæ•°ã¨åˆ—æ•°ã¯1ä»¥ä¸Šã§æŒ‡å®šã—ã¦ãã ã•ã„ã€‚');
                }
            });

            // --- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æç”» ---
            function drawTimeline() {
                timelineContext.clearRect(0, 0, timelineCanvas.width, timelineCanvas.height);
                timelineContext.font = '12px Arial';
                timelineContext.fillStyle = '#333';
                timelineContext.textAlign = 'center';
                timelineContext.strokeStyle = '#ccc';
                timelineContext.lineWidth = 1;

                const currentProject = projects.find(p => p.id === currentProjectId);
                const currentSequence = currentProject?.sequences.find(s => s.id === currentSequenceId);

                if (!currentSequence || currentSequence.scenes.length === 0) {
                    timelineContext.fillText('ã“ã®ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹ã«ã¯ã‚·ãƒ¼ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', timelineCanvas.width / 2, timelineCanvas.height / 2);
                    return;
                }

                // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è»¸ã®æç”»
                const startX = 50;
                const endX = timelineCanvas.width - 50;
                const lineY = timelineCanvas.height / 2;
                timelineContext.beginPath();
                timelineContext.moveTo(startX, lineY);
                timelineContext.lineTo(endX, lineY);
                timelineContext.stroke();

                // å„ã‚·ãƒ¼ãƒ³ã‚’ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ä¸Šã«é…ç½®
                const sceneCount = currentSequence.scenes.length;
                // ã‚·ãƒ¼ãƒ³ãŒ1ã¤ã®å ´åˆã¯é–“éš”ã‚’0ã«ã™ã‚‹ (ç·šä¸Šã«1ç‚¹ã ã‘æç”»)
                const spacing = (sceneCount > 1) ? (endX - startX) / (sceneCount - 1) : 0; 

                currentSequence.scenes.forEach((scene, index) => {
                    const x = startX + (index * spacing);
                    const y = lineY;

                    // ç›®ç››ã‚Š
                    timelineContext.beginPath();
                    timelineContext.moveTo(x, y - 5);
                    timelineContext.lineTo(x, y + 5);
                    timelineContext.stroke();

                    // ã‚·ãƒ¼ãƒ³åï¼ˆãƒ‡ãƒ¼ã‚¿ã«å¿œã˜ã¦è¡¨ç¤ºã‚’èª¿æ•´ï¼‰
                    let sceneLabel = '';
                    if (scene.type === 'timeline' && scene.data.date) {
                        sceneLabel = scene.data.date;
                    } else if (scene.type === 'character') {
                        // ã‚·ãƒ¼ãƒ³ãŒæŒã¤charNameã‚’ä½¿ç”¨ã€ã¾ãŸã¯charIdã‹ã‚‰ä½œå“ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åã‚’å–å¾—
                        sceneLabel = scene.data.charName || (currentProject?.characters.find(c => c.id === scene.data.charId)?.name || `ğŸ‘¤ ã‚·ãƒ¼ãƒ³${index + 1}`);
                    } else if (scene.type === 'story' && scene.data.storyChapter) {
                        sceneLabel = scene.data.storyChapter;
                    } else {
                        sceneLabel = `ã‚·ãƒ¼ãƒ³ ${index + 1}`;
                    }

                    // ãƒ†ã‚­ã‚¹ãƒˆã‚’å›è»¢ã•ã›ã¦è¡¨ç¤º
                    timelineContext.save();
                    timelineContext.translate(x, y + 15);
                    timelineContext.rotate(Math.PI / 6); // 30åº¦å›è»¢
                    timelineContext.fillText(sceneLabel, 0, 0);
                    timelineContext.restore();

                    // é¸æŠä¸­ã®ã‚·ãƒ¼ãƒ³ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                    if (scene.id === currentSceneId) {
                        timelineContext.beginPath();
                        timelineContext.arc(x, y, 8, 0, Math.PI * 2);
                        timelineContext.fillStyle = '#3498db';
                        timelineContext.fill();
                        timelineContext.strokeStyle = '#2980b9';
                        timelineContext.lineWidth = 2;
                        timelineContext.stroke();
                    }
                });
            }

            timelineDisplayModeButton.addEventListener('click', () => {
                // ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿æç”»
                if (currentProjectId && currentSequenceId) {
                    drawTimeline();
                } else {
                    alert('ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯ã€ä½œå“ã¨ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                }
            });

            // --- ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½ ---
            function addDragAndDropListeners(listElement) {
                listElement.querySelectorAll('li').forEach(item => {
                    item.addEventListener('dragstart', handleDragStart);
                    item.addEventListener('dragenter', handleDragEnter);
                    item.addEventListener('dragover', handleDragOver);
                    item.addEventListener('dragleave', handleDragLeave);
                    item.addEventListener('drop', handleDrop);
                    item.addEventListener('dragend', handleDragEnd);
                });
            }

            function handleDragStart(e) {
                draggedItem = e.target;
                dragType = draggedItem.dataset.type; // project, character, sequence, scene
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', draggedItem.dataset.id); // ãƒ‰ãƒ©ãƒƒã‚°ã™ã‚‹è¦ç´ ã®IDã‚’ã‚»ãƒƒãƒˆ
                e.dataTransfer.setData('text/dragtype', dragType); // ãƒ‰ãƒ©ãƒƒã‚°ã™ã‚‹è¦ç´ ã®ã‚¿ã‚¤ãƒ—ã‚’ã‚»ãƒƒãƒˆ

                setTimeout(() => {
                    draggedItem.classList.add('dragging'); // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®è¦ç´ ã‚’åŠé€æ˜ã«ã™ã‚‹
                }, 0); // DOMãŒæ›´æ–°ã•ã‚Œã‚‹ã®ã‚’å¾…ã¤
            }

            function handleDragEnter(e) {
                e.preventDefault(); // ãƒ‰ãƒ­ãƒƒãƒ—ã‚’è¨±å¯ã™ã‚‹ãŸã‚ã«å¿…è¦
                // draggedItemãŒnullï¼ˆãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹å‰ï¼‰ã¾ãŸã¯è‡ªåˆ†è‡ªèº«ã§ã‚ã‚‹å ´åˆã¯å‡¦ç†ã—ãªã„
                if (!draggedItem || e.target === draggedItem || e.target.dataset.type !== dragType) return;
                
                // ãƒ‰ãƒ­ãƒƒãƒ—å¯¾è±¡ã®è¦ç´ ãŒãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
                let targetLi = e.target.closest('li[draggable="true"]');
                if (targetLi && targetLi.dataset.type === dragType) {
                    // ä»–ã®ã‚¢ã‚¤ãƒ†ãƒ ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ã‚¯ãƒªã‚¢
                    document.querySelectorAll('.drag-over, .drag-over-bottom').forEach(item => {
                        item.classList.remove('drag-over', 'drag-over-bottom');
                    });

                    // ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ä½ç½®ã‚’åˆ¤å®šï¼ˆä¸ŠåŠåˆ†ãªã‚‰ä¸Šã€ä¸‹åŠåˆ†ãªã‚‰ä¸‹ï¼‰
                    const rect = targetLi.getBoundingClientRect();
                    const offset = e.clientY - rect.top;
                    if (offset < rect.height / 2) {
                        targetLi.classList.add('drag-over'); // ä¸Šã«æŒ¿å…¥
                    } else {
                        targetLi.classList.add('drag-over-bottom'); // ä¸‹ã«æŒ¿å…¥
                    }
                }
            }

            function handleDragOver(e) {
                e.preventDefault(); // ãƒ‰ãƒ­ãƒƒãƒ—ã‚’è¨±å¯ã™ã‚‹ãŸã‚ã«å¿…è¦
                e.dataTransfer.dropEffect = 'move'; // ãƒã‚¦ã‚¹ã‚«ãƒ¼ã‚½ãƒ«ã‚’ç§»å‹•ã®ã‚¢ã‚¤ã‚³ãƒ³ã«ã™ã‚‹

                // ãƒ‰ãƒ­ãƒƒãƒ—å¯¾è±¡ã®è¦ç´ ãŒãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
                let targetLi = e.target.closest('li[draggable="true"]');
                if (targetLi && targetLi.dataset.type === dragType) {
                    // ä»–ã®ã‚¢ã‚¤ãƒ†ãƒ ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ã‚¯ãƒªã‚¢
                    document.querySelectorAll('.drag-over, .drag-over-bottom').forEach(item => {
                        item.classList.remove('drag-over', 'drag-over-bottom');
                    });

                    // ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ä½ç½®ã‚’åˆ¤å®šï¼ˆä¸ŠåŠåˆ†ãªã‚‰ä¸Šã€ä¸‹åŠåˆ†ãªã‚‰ä¸‹ï¼‰
                    const rect = targetLi.getBoundingClientRect();
                    const offset = e.clientY - rect.top;
                    if (offset < rect.height / 2) {
                        targetLi.classList.add('drag-over'); // ä¸Šã«æŒ¿å…¥
                    } else {
                        targetLi.classList.add('drag-over-bottom'); // ä¸‹ã«æŒ¿å…¥
                    }
                }
            }

            function handleDragLeave(e) {
                e.target.classList.remove('drag-over', 'drag-over-bottom'); // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ã‹ã‚‰å‡ºãŸã‚‰ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è§£é™¤
            }

            function handleDrop(e) {
                e.preventDefault();
                // ãƒ‰ãƒ­ãƒƒãƒ—æ™‚ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è§£é™¤
                document.querySelectorAll('.drag-over, .drag-over-bottom').forEach(item => {
                    item.classList.remove('drag-over', 'drag-over-bottom');
                });

                if (draggedItem && draggedItem !== e.target) {
                    const dropTargetId = e.target.dataset.id;
                    const dropTargetType = e.target.dataset.type;
                    const draggedId = e.dataTransfer.getData('text/plain');
                    const receivedDragType = e.dataTransfer.getData('text/dragtype');

                    if (dragType !== receivedDragType || dragType !== dropTargetType) {
                        // ç•°ãªã‚‹ç¨®é¡ã®ã‚¢ã‚¤ãƒ†ãƒ é–“ã§ã®ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã¯è¨±å¯ã—ãªã„
                        console.warn('ç•°ãªã‚‹ç¨®é¡ã®ã‚¢ã‚¤ãƒ†ãƒ é–“ã§ã®ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã¯è¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                        return;
                    }

                    let listArray;
                    let renderFunction;
                    let targetObject;
                    let draggedObject;

                    // ãƒªã‚¹ãƒˆã®ç¨®é¡ã«å¿œã˜ã¦é©åˆ‡ãªé…åˆ—ã¨ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–¢æ•°ã‚’é¸æŠ
                    if (dragType === 'project') {
                        listArray = projects;
                        renderFunction = renderProjectList;
                    } else if (dragType === 'character') {
                        const currentProject = projects.find(p => p.id === currentProjectId);
                        if (!currentProject) return;
                        listArray = currentProject.characters;
                        renderFunction = renderCharacterList;
                    } else if (dragType === 'sequence') {
                        const currentProject = projects.find(p => p.id === currentProjectId);
                        if (!currentProject) return;
                        listArray = currentProject.sequences;
                        renderFunction = renderSequenceList;
                    } else if (dragType === 'scene') {
                        const currentProject = projects.find(p => p.id === currentProjectId);
                        const currentSequence = currentProject?.sequences.find(s => s.id === currentSequenceId);
                        if (!currentSequence) return;
                        listArray = currentSequence.scenes;
                        renderFunction = renderSceneList;
                    } else {
                        return; // æœªçŸ¥ã®ã‚¿ã‚¤ãƒ—
                    }

                    // ãƒ‰ãƒ©ãƒƒã‚°ã•ã‚ŒãŸè¦ç´ ã¨ãƒ‰ãƒ­ãƒƒãƒ—å…ˆã®è¦ç´ ã‚’é…åˆ—ã‹ã‚‰è¦‹ã¤ã‘ã‚‹
                    draggedObject = listArray.find(item => item.id === draggedId);
                    targetObject = listArray.find(item => item.id === dropTargetId);

                    if (draggedObject && targetObject) {
                        const draggedIndex = listArray.indexOf(draggedObject);
                        let targetIndex = listArray.indexOf(targetObject);

                        // è¦ç´ ã‚’é…åˆ—ã‹ã‚‰å‰Šé™¤
                        listArray.splice(draggedIndex, 1);

                        // ãƒ‰ãƒ­ãƒƒãƒ—ä½ç½®ã«å¿œã˜ã¦æŒ¿å…¥ä½ç½®ã‚’èª¿æ•´
                        const rect = e.target.getBoundingClientRect();
                        const offset = e.clientY - rect.top;
                        if (offset > rect.height / 2) {
                            // ãƒ‰ãƒ­ãƒƒãƒ—å¯¾è±¡ã®ä¸‹ã«æŒ¿å…¥ã™ã‚‹å ´åˆ
                            listArray.splice(targetIndex + 1, 0, draggedObject);
                        } else {
                            // ãƒ‰ãƒ­ãƒƒãƒ—å¯¾è±¡ã®ä¸Šã«æŒ¿å…¥ã™ã‚‹å ´åˆ
                            listArray.splice(targetIndex, 0, draggedObject);
                        }
                        
                        saveProjects(); // å¤‰æ›´ã‚’ä¿å­˜
                        renderFunction(); // ãƒªã‚¹ãƒˆã‚’å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°

                        // ç¾åœ¨é¸æŠä¸­ã®ã‚¢ã‚¤ãƒ†ãƒ ãŒä¸¦ã¹æ›¿ãˆå¾Œã‚‚é¸æŠçŠ¶æ…‹ã‚’ç¶­æŒã™ã‚‹ã‚ˆã†ã«èª¿æ•´
                        // ã‚‚ã—ãƒ‰ãƒ©ãƒƒã‚°ã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ ãŒé¸æŠä¸­ã ã£ãŸå ´åˆã€å†åº¦é¸æŠã—ç›´ã™ã“ã¨ã§ãƒã‚¤ãƒ©ã‚¤ãƒˆãŒç¶­æŒã•ã‚Œã‚‹
                        if (dragType === 'project' && draggedId === currentProjectId) selectProject(draggedId);
                        if (dragType === 'character' && draggedId === currentCharacterId) selectCharacter(draggedId);
                        if (dragType === 'sequence' && draggedId === currentSequenceId) selectSequence(draggedId);
                        if (dragType === 'scene' && draggedId === currentSceneId) selectScene(draggedId);
                        else updateUIState(); // ãã‚Œä»¥å¤–ã®å ´åˆã¯é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°

                        if (dragType === 'scene' && currentSequenceId) {
                            drawTimeline(); // ã‚·ãƒ¼ãƒ³ãŒä¸¦ã¹æ›¿ãˆã‚‰ã‚ŒãŸã‚‰ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’å†æç”»
                        }
                    }
                }
            }

            function handleDragEnd(e) {
                draggedItem.classList.remove('dragging'); // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®è¦ç´ ã‹ã‚‰åŠé€æ˜ã‚’è§£é™¤
                document.querySelectorAll('.drag-over, .drag-over-bottom').forEach(item => {
                    item.classList.remove('drag-over', 'drag-over-bottom'); // æ®‹ã£ã¦ã„ã‚‹ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è§£é™¤
                });
                draggedItem = null;
                dragType = null;
            }

            // --- åˆæœŸåŒ– ---
            loadProjects(); // ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«ä¿å­˜ã•ã‚ŒãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’èª­ã¿è¾¼ã‚€

            // æœ€å¾Œã«é¸æŠã•ã‚Œã¦ã„ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãªã©ã‚’è¨˜æ†¶ãƒ»å¾©å…ƒã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ (ç°¡æ˜“ç‰ˆ)
            // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ã€ã‚‚ã—ä»¥å‰ã«é¸æŠã•ã‚Œã¦ã„ãŸä½œå“ãŒã‚ã‚Œã°ãã‚Œã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
            const lastSelectedProjectId = localStorage.getItem('lastSelectedProjectId');
            if (lastSelectedProjectId && projects.some(p => p.id === lastSelectedProjectId)) {
                selectProject(lastSelectedProjectId);
            } else if (projects.length > 0) {
                selectProject(projects[0].id); // ä»¥å‰ã®é¸æŠãŒãªã‘ã‚Œã°æœ€åˆã®ä½œå“ã‚’é¸æŠ
            } else {
                resetMainContentVisibility(); // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒä¸€ã¤ã‚‚ãªã„å ´åˆã¯UIã‚’åˆæœŸçŠ¶æ…‹ã«
            }
            updateUIState(); // UIã®åˆæœŸçŠ¶æ…‹ã‚’æ›´æ–°
        });
    </script>
</body>
</html>
