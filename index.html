<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ—ãƒ­ãƒƒãƒˆãƒ¡ãƒ¼ã‚«ãƒ¼ PRO</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #app {
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            padding: 30px;
            width: 90%;
            max-width: 1000px; /* å°‘ã—åºƒã‚ã« */
            margin-bottom: 30px;
            display: flex; /* Flexboxã§ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
            gap: 20px;
        }
        #sidebar {
            width: 250px;
            padding-right: 20px;
            border-right: 1px solid #eee;
            flex-shrink: 0; /* ç¸®ã¾ãªã„ */
        }
        #main-content {
            flex-grow: 1; /* æ®‹ã‚Šã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’åŸ‹ã‚ã‚‹ */
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 25px;
            font-size: 2.2em;
        }
        h2 {
            color: #34495e;
            margin-top: 20px;
            margin-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 8px;
            font-size: 1.6em;
        }
        h3 {
             color: #4a637d;
             margin-top: 15px;
             margin-bottom: 10px;
             font-size: 1.3em;
        }
        .section-title { /* æ—¢å­˜ã®section-titleã¯h2, h3ãªã©ã«ç½®ãæ›ãˆ */
            color: #34495e;
            margin-top: 30px;
            margin-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 8px;
            font-size: 1.5em;
        }
        .input-group {
            margin-bottom: 18px;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        .input-group input[type="text"],
        .input-group input[type="number"],
        .input-group textarea,
        .input-group select {
            width: calc(100% - 20px);
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
            box-sizing: border-box;
            background-color: #fafafa;
        }
        .input-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap; /* ãƒœã‚¿ãƒ³ã®æŠ˜ã‚Šè¿”ã— */
        }
        button {
            background-color: #3498db;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s ease, transform 0.1s ease;
            white-space: nowrap; /* ãƒœã‚¿ãƒ³å†…ã®ãƒ†ã‚­ã‚¹ãƒˆæ”¹è¡Œé˜²æ­¢ */
        }
        button:hover {
            background-color: #2980b9;
            transform: translateY(-1px);
        }
        button:active {
            transform: translateY(0);
        }
        button.secondary {
            background-color: #95a5a6;
        }
        button.secondary:hover {
            background-color: #7f8c8d;
        }
        button.danger {
            background-color: #e74c3c;
        }
        button.danger:hover {
            background-color: #c0392b;
        }
        #plot-output { /* ä½¿ç”¨ã—ãªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒæ®‹ã—ã¦ãŠãã¾ã™ */
            background-color: #ecf0f1;
            border: 1px dashed #bdc3c7;
            padding: 25px;
            min-height: 200px;
            margin-top: 30px;
            border-radius: 8px;
            font-size: 1.1em;
            line-height: 1.8;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .list-container {
            list-style: none;
            padding: 0;
            max-height: 300px; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã«ã™ã‚‹ */
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 5px;
            background-color: #fcfcfc;
        }
        .list-container li {
            background-color: #f9f9f9;
            border-bottom: 1px solid #eee;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .list-container li:last-child {
            border-bottom: none;
        }
        .list-container li:hover {
            background-color: #eaf3f9;
        }
        .list-container li.selected {
            background-color: #dbe9f5;
            font-weight: bold;
            color: #2c3e50;
        }
        .list-container li span {
            flex-grow: 1;
            margin-right: 15px;
        }
        .list-container li button {
            padding: 6px 12px;
            font-size: 0.8em;
            margin-left: 8px;
            box-shadow: none; /* ãƒªã‚¹ãƒˆå†…ãƒœã‚¿ãƒ³ã®å½±ã‚’ãªãã™ */
        }

        .plot-type-options {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .plot-type-options label {
            background-color: #e0e0e0;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .plot-type-options label:hover {
            background-color: #d0d0d0;
        }
        .plot-type-options input[type="radio"] {
            display: none;
        }
        .plot-type-options input[type="radio"]:checked + label {
            background-color: #3498db;
            color: white;
            font-weight: bold;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚° */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border: 1px solid #888;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
        }
        #overallSummaryTextarea, #charDetailSummaryTextarea {
            width: calc(100% - 20px);
            min-height: 200px;
            margin-bottom: 15px;
        }
        #charDetailInputs label, #charDetailInputs input {
            margin-bottom: 10px;
        }
        #charDetailInputs input {
            width: calc(100% - 10px);
        }

        /* æç”»ãƒ»ç”»åƒãƒ»ãƒ†ãƒ¼ãƒ–ãƒ«é–¢é€£ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #drawingCanvas, #timelineCanvas {
            border: 1px solid #bdc3c7;
            background-color: white;
            display: block;
            margin-top: 15px;
            border-radius: 5px;
        }
        #imagePreviewElement img {
            max-width: 100%;
            height: auto;
            border: 1px solid #eee;
            border-radius: 5px;
            display: block;
            margin-top: 15px;
        }
        #tablePreviewElement table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        #tablePreviewElement th, #tablePreviewElement td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
            word-wrap: break-word; /* é•·ã„å˜èªã®æŠ˜ã‚Šè¿”ã— */
        }
        #tablePreviewElement td[contenteditable="true"]:focus {
            outline: 2px solid #3498db;
        }
        #tablePreviewElement th {
            background-color: #e9ecef;
        }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆä»»æ„ï¼‰ */
        .list-container::-webkit-scrollbar,
        body::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .list-container::-webkit-scrollbar-thumb,
        body::-webkit-scrollbar-thumb {
            background-color: #ccc;
            border-radius: 4px;
        }
        .list-container::-webkit-scrollbar-track,
        body::-webkit-scrollbar-track {
            background-color: #f1f1f1;
        }

        /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ */
        #characterSelectForScene {
            width: calc(100% - 20px);
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
            box-sizing: border-box;
            background-color: #fafafa;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="sidebar">
            <h1>ãƒ—ãƒ­ãƒƒãƒˆãƒ¡ãƒ¼ã‚«ãƒ¼ PRO</h1>
            <div class="section">
                <h2>ä½œå“ãƒªã‚¹ãƒˆ</h2>
                <ul id="project-list" class="list-container">
                    </ul>
                <div class="button-group">
                    <button id="addProjectButton">æ–°ã—ã„ä½œå“</button>
                    <button id="deleteProjectButton" class="danger secondary">ä½œå“ã‚’å‰Šé™¤</button>
                </div>
            </div>

            <div class="section" id="overall-summary-section" style="display:none;">
                <h2>ä½œå“æ¦‚è¦</h2>
                <div class="button-group">
                    <button id="openOverallSummaryModal">æ¦‚è¦ãƒ¡ãƒ¢ã‚’é–‹ã</button>
                </div>
            </div>

            <div class="section" id="character-list-section" style="display:none;">
                <h2>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒªã‚¹ãƒˆ</h2>
                <ul id="character-list" class="list-container">
                    </ul>
                <div class="button-group">
                    <button id="addCharacterButton">æ–°ã—ã„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼</button>
                    <button id="deleteCharacterButton" class="danger secondary">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’å‰Šé™¤</button>
                </div>
            </div>

            <div class="section" id="sequence-list-section" style="display:none;">
                <h2>ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹ãƒªã‚¹ãƒˆ</h2>
                <ul id="sequence-list" class="list-container">
                    </ul>
                <div class="button-group">
                    <button id="addSequenceButton">æ–°ã—ã„ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹</button>
                    <button id="deleteSequenceButton" class="danger secondary">ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹ã‚’å‰Šé™¤</button>
                </div>
            </div>
        </div>

        <div id="main-content">
            <h2 id="current-project-title">ä½œå“ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
            <h3 id="current-sequence-title" style="display:none;"></h3>

            <div class="section" id="scene-input-section" style="display:none;">
                <h3>ã‚·ãƒ¼ãƒ³å…¥åŠ›</h3>
                <div class="plot-type-options">
                    <input type="radio" id="typeTimeline" name="plotType" value="timeline" checked>
                    <label for="typeTimeline">æ™‚ç³»åˆ—ãƒ—ãƒ­ãƒƒãƒˆ</label>

                    <input type="radio" id="typeCharacter" name="plotType" value="character">
                    <label for="typeCharacter">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ—ãƒ­ãƒƒãƒˆ</label>

                    <input type="radio" id="typeStory" name="plotType" value="story">
                    <label for="typeStory">ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ—ãƒ­ãƒƒãƒˆ</label>
                </div>

                <div id="timelinePlotInputs">
                    <div class="input-group">
                        <label for="date">æ—¥ä»˜/æ™‚æœŸ:</label>
                        <input type="text" id="date" placeholder="ä¾‹: 2023/01/15, ç´€å…ƒå‰500å¹´, å¤">
                    </div>
                    <div class="input-group">
                        <label for="event">å‡ºæ¥äº‹/å†…å®¹:</label>
                        <textarea id="event" placeholder="ä¾‹: ä¸»äººå…¬ãŒæ–°ã—ã„ã‚¹ã‚­ãƒ«ã‚’ç¿’å¾—ã™ã‚‹"></textarea>
                    </div>
                </div>

                <div id="characterPlotInputs" style="display: none;">
                    <div class="input-group">
                        <label for="characterSelectForScene">æ—¢å­˜ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸æŠ:</label>
                        <select id="characterSelectForScene">
                            <option value="">-- æ–°ã—ã„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ --</option>
                            </select>
                    </div>
                    <div class="input-group">
                        <label for="charName">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å (æ–°è¦ã®å ´åˆ):</label>
                        <input type="text" id="charName" placeholder="ä¾‹: ã‚¨ãƒ«ã‚¶">
                    </div>
                    <div class="input-group">
                        <label for="charTrait">ç‰¹å¾´/æ€§æ ¼:</label>
                        <textarea id="charTrait" placeholder="ä¾‹: å†·é™æ²ˆç€ã€é­”åŠ›ãŒé«˜ã„"></textarea>
                    </div>
                    <div class="input-group">
                        <label for="charRole">å½¹å‰²:</label>
                        <input type="text" id="charRole" placeholder="ä¾‹: ä¸»äººå…¬ã€æ•µå½¹ã€ã‚µãƒãƒ¼ãƒˆ">
                    </div>
                </div>

                <div id="storyPlotInputs" style="display: none;">
                    <div class="input-group">
                        <label for="storyChapter">ç« /ã‚·ãƒ¼ãƒ³:</label>
                        <input type="text" id="storyChapter" placeholder="ä¾‹: ç¬¬1ç« : å‡ºä¼šã„ã€ã‚·ãƒ¼ãƒ³3: è¨“ç·´">
                    </div>
                    <div class="input-group">
                        <label for="storySummary">æ¦‚è¦:</label>
                        <textarea id="storySummary" placeholder="ä¾‹: ä¸»äººå…¬ã¨ãƒ’ãƒ­ã‚¤ãƒ³ãŒåˆã‚ã¦å‡ºä¼šã„ã€äº’ã„ã®ç›®æ¨™ã‚’çŸ¥ã‚‹"></textarea>
                    </div>
                    <div class="input-group">
                        <label for="storyConflict">è‘›è—¤/è§£æ±º:</label>
                        <textarea id="storyConflict" placeholder="ä¾‹: å†…ãªã‚‹è‘›è—¤ã€æ•µã¨ã®å¯¾æ±ºã€æ–°ãŸãªå‹æƒ…"></textarea>
                    </div>
                </div>

                <div class="button-group">
                    <button id="addSceneButton">ã‚·ãƒ¼ãƒ³ã‚’è¿½åŠ </button>
                    <button id="clearSceneInputs" class="secondary">å…¥åŠ›ã‚¯ãƒªã‚¢</button>
                </div>
            </div>

            <div class="section" id="scene-list-section" style="display:none;">
                <h3>ã‚·ãƒ¼ãƒ³ãƒªã‚¹ãƒˆ</h3>
                <ul id="scene-list" class="list-container">
                    </ul>
                <div class="button-group">
                    <button id="deleteSceneButton" class="danger secondary">ã‚·ãƒ¼ãƒ³ã‚’å‰Šé™¤</button>
                </div>
            </div>

            <div class="section" id="scene-details-section" style="display:none;">
                <h3>é¸æŠä¸­ã®ã‚·ãƒ¼ãƒ³è©³ç´°</h3>
                <div id="selected-scene-content">
                    </div>

                <div class="section-title">ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æç”»</div>
                <div class="button-group">
                    <button id="timelineDisplayMode">ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ</button>
                </div>
                <canvas id="timelineCanvas" width="800" height="200"></canvas>

                <div class="section-title">è‡ªç”±æç”»</div>
                <div class="button-group">
                    <button id="drawingModeButton">æç”»ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ</button>
                    <label for="lineThickness">å¤ªã•:</label>
                    <input type="range" id="lineThickness" min="1" max="20" value="5">
                    <label for="lineColor">è‰²:</label>
                    <input type="color" id="lineColor" value="#000000">
                    <button id="clearDrawingButton" class="secondary">ã‚¯ãƒªã‚¢</button>
                </div>
                <canvas id="drawingCanvas" width="800" height="400"></canvas>

                <div class="section-title">ç”»åƒ</div>
                <div class="input-group">
                    <label for="imageUpload">ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰:</label>
                    <input type="file" id="imageUpload" accept="image/*">
                </div>
                <div id="imagePreviewElement"></div>

                <div class="section-title">ãƒ†ãƒ¼ãƒ–ãƒ«</div>
                <div class="input-group">
                    <label>ãƒ†ãƒ¼ãƒ–ãƒ«ã‚µã‚¤ã‚º:</label>
                    <input type="number" id="tableRowsInput" value="3" min="1" max="100" style="width: 80px;"> è¡Œ
                    <input type="number" id="tableColsInput" value="3" min="1" max="100" style="width: 80px; margin-left: 10px;"> åˆ—
                </div>
                <div class="button-group">
                    <button id="createTableButton">ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ</button>
                </div>
                <div id="tablePreviewElement"></div>
            </div>
        </div>
    </div>

    <div id="overallSummaryModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>ä½œå“å…¨ä½“æ¦‚è¦</h2>
            <textarea id="overallSummaryTextarea" placeholder="ä½œå“å…¨ä½“ã®ã‚ã‚‰ã™ã˜ã‚„è¨­å®šãªã©ã‚’ã“ã“ã«è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚"></textarea>
            <div class="button-group">
                <button id="saveOverallSummaryButton">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div id="characterDetailModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è©³ç´°</h2>
            <div id="charDetailInputs">
                <div class="input-group">
                    <label for="charDetailName">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å:</label>
                    <input type="text" id="charDetailName" placeholder="ä¾‹: ã‚¨ãƒ«ã‚¶">
                </div>
                <div class="input-group">
                    <label for="charDetailTrait">ç‰¹å¾´/æ€§æ ¼:</label>
                    <input type="text" id="charDetailTrait" placeholder="ä¾‹: å†·é™æ²ˆç€ã€é­”åŠ›ãŒé«˜ã„">
                </div>
                <div class="input-group">
                    <label for="charDetailRole">å½¹å‰²:</label>
                    <input type="text" id="charDetailRole" placeholder="ä¾‹: ä¸»äººå…¬ã€æ•µå½¹ã€ã‚µãƒãƒ¼ãƒˆ">
                </div>
                <div class="input-group">
                    <label for="charDetailSummaryTextarea">è©³ç´°ãƒ¡ãƒ¢:</label>
                    <textarea id="charDetailSummaryTextarea" placeholder="ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®èƒŒæ™¯ã€ç”Ÿã„ç«‹ã¡ã€èƒ½åŠ›ã€äººé–“é–¢ä¿‚ãªã©ã€è©³ç´°ãªæƒ…å ±ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚"></textarea>
                </div>
            </div>
            <div class="button-group">
                <button id="saveCharacterDetailButton">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- UIè¦ç´ ã®å–å¾— ---
            const projectList = document.getElementById('project-list');
            const addProjectButton = document.getElementById('addProjectButton');
            const deleteProjectButton = document.getElementById('deleteProjectButton');
            const overallSummarySection = document.getElementById('overall-summary-section');
            const openOverallSummaryModalButton = document.getElementById('openOverallSummaryModal');
            const overallSummaryModal = document.getElementById('overallSummaryModal');
            const closeOverallSummaryModalButton = overallSummaryModal.querySelector('.close-button');
            const overallSummaryTextarea = document.getElementById('overallSummaryTextarea');
            const saveOverallSummaryButton = document.getElementById('saveOverallSummaryButton');

            const characterListSection = document.getElementById('character-list-section'); // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒªã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³
            const characterList = document.getElementById('character-list'); // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒªã‚¹ãƒˆ
            const addCharacterButton = document.getElementById('addCharacterButton'); // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¿½åŠ ãƒœã‚¿ãƒ³
            const deleteCharacterButton = document.getElementById('deleteCharacterButton'); // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å‰Šé™¤ãƒœã‚¿ãƒ³
            const characterDetailModal = document.getElementById('characterDetailModal'); // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«
            const closeCharacterDetailModalButton = characterDetailModal.querySelector('.close-button');
            const charDetailNameInput = document.getElementById('charDetailName'); // è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®åå‰å…¥åŠ›
            const charDetailTraitInput = document.getElementById('charDetailTrait'); // è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ç‰¹å¾´å…¥åŠ›
            const charDetailRoleInput = document.getElementById('charDetailRole'); // è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®å½¹å‰²å…¥åŠ›
            const charDetailSummaryTextarea = document.getElementById('charDetailSummaryTextarea'); // è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ãƒ¡ãƒ¢å…¥åŠ›
            const saveCharacterDetailButton = document.getElementById('saveCharacterDetailButton'); // è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ä¿å­˜ãƒœã‚¿ãƒ³

            const sequenceListSection = document.getElementById('sequence-list-section');
            const sequenceList = document.getElementById('sequence-list');
            const addSequenceButton = document.getElementById('addSequenceButton');
            const deleteSequenceButton = document.getElementById('deleteSequenceButton');

            const sceneInputSection = document.getElementById('scene-input-section');
            const sceneListSection = document.getElementById('scene-list-section');
            const sceneDetailsSection = document.getElementById('scene-details-section');
            const sceneList = document.getElementById('scene-list');
            const addSceneButton = document.getElementById('addSceneButton');
            const deleteSceneButton = document.getElementById('deleteSceneButton');
            const selectedSceneContent = document.getElementById('selected-scene-content');

            const currentProjectTitle = document.getElementById('current-project-title');
            const currentSequenceTitle = document.getElementById('current-sequence-title');

            // --- æ—¢å­˜ã®ãƒ—ãƒ­ãƒƒãƒˆå…¥åŠ›UIè¦ç´  ---
            const radioButtons = document.querySelectorAll('input[name="plotType"]');
            const timelineInputs = document.getElementById('timelinePlotInputs');
            const characterInputs = document.getElementById('characterPlotInputs'); // ã‚·ãƒ¼ãƒ³è¿½åŠ æ™‚ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å…¥åŠ›
            const storyInputs = document.getElementById('storyPlotInputs');

            const dateInput = document.getElementById('date');
            const eventInput = document.getElementById('event');
            const charNameInput = document.getElementById('charName'); // ã‚·ãƒ¼ãƒ³è¿½åŠ æ™‚ç”¨
            const charTraitInput = document.getElementById('charTrait'); // ã‚·ãƒ¼ãƒ³è¿½åŠ æ™‚ç”¨
            const charRoleInput = document.getElementById('charRole'); // ã‚·ãƒ¼ãƒ³è¿½åŠ æ™‚ç”¨
            const characterSelectForScene = document.getElementById('characterSelectForScene'); // ã‚·ãƒ¼ãƒ³è¿½åŠ æ™‚ã®æ—¢å­˜ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠ
            const storyChapterInput = document.getElementById('storyChapter');
            const storySummaryInput = document.getElementById('storySummary');
            const storyConflictInput = document.getElementById('storyConflict');
            const clearSceneInputsButton = document.getElementById('clearSceneInputs');

            // --- æç”»ãƒ»ç”»åƒãƒ»ãƒ†ãƒ¼ãƒ–ãƒ«UIè¦ç´  ---
            const timelineCanvas = document.getElementById('timelineCanvas');
            const timelineContext = timelineCanvas.getContext('2d');
            const timelineDisplayModeButton = document.getElementById('timelineDisplayMode');

            const drawingCanvas = document.getElementById('drawingCanvas');
            const drawingContext = drawingCanvas.getContext('2d');
            const drawingModeButton = document.getElementById('drawingModeButton');
            const lineThicknessInput = document.getElementById('lineThickness');
            const lineColorInput = document.getElementById('lineColor');
            const clearDrawingButton = document.getElementById('clearDrawingButton');

            const imageUploadInput = document.getElementById('imageUpload');
            const imagePreviewElement = document.getElementById('imagePreviewElement');

            const tableRowsInput = document.getElementById('tableRowsInput');
            const tableColsInput = document.getElementById('tableColsInput');
            const createTableButton = document.getElementById('createTableButton');
            const tablePreviewElement = document.getElementById('tablePreviewElement');

            // --- ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ« ---
            let projects = []; // å…¨ã¦ã®ä½œå“ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
            let currentProjectId = null;
            let currentSequenceId = null;
            let currentSceneId = null; // é¸æŠä¸­ã®ã‚·ãƒ¼ãƒ³ID
            let currentCharacterId = null; // é¸æŠä¸­ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ID (æ–°ã—ã„æ©Ÿèƒ½)

            // æç”»ãƒ»ç”»åƒãƒ»ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿
            let isDrawingMode = false;
            let drawingPath = [];
            let currentDrawingData = []; // ç¾åœ¨ã®ã‚·ãƒ¼ãƒ³ã®æç”»ãƒ‘ã‚¹
            let currentImageData = null; // ç¾åœ¨ã®ã‚·ãƒ¼ãƒ³ã®ç”»åƒ
            let currentTableData = null; // ç¾åœ¨ã®ã‚·ãƒ¼ãƒ³ã®ãƒ†ãƒ¼ãƒ–ãƒ«

            // æç”»é–¢é€£
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;

            // --- ãƒ‡ãƒ¼ã‚¿ç®¡ç†é–¢æ•° ---
            function generateId() {
                return '_' + Math.random().toString(36).substr(2, 9);
            }

            function saveProjects() {
                localStorage.setItem('plotMakerProjects', JSON.stringify(projects));
            }

            function loadProjects() {
                const savedProjects = localStorage.getItem('plotMakerProjects');
                projects = savedProjects ? JSON.parse(savedProjects) : [];
                renderProjectList();
            }

            // --- UIãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–¢æ•° ---
            function renderProjectList() {
                projectList.innerHTML = '';
                if (projects.length === 0) {
                    projectList.innerHTML = '<li>ä½œå“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œæ–°ã—ã„ä½œå“ã€ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚</li>';
                    return;
                }
                projects.forEach(project => {
                    const listItem = document.createElement('li');
                    listItem.textContent = project.name;
                    listItem.dataset.id = project.id;
                    if (project.id === currentProjectId) {
                        listItem.classList.add('selected');
                    }
                    listItem.addEventListener('click', () => selectProject(project.id));
                    projectList.appendChild(listItem);
                });
            }

            function renderCharacterList() {
                characterList.innerHTML = '';
                const currentProject = projects.find(p => p.id === currentProjectId);
                if (!currentProject || !currentProject.characters || currentProject.characters.length === 0) {
                    characterList.innerHTML = '<li>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</li>';
                    return;
                }
                currentProject.characters.forEach(char => {
                    const listItem = document.createElement('li');
                    listItem.textContent = char.name;
                    listItem.dataset.id = char.id;
                    if (char.id === currentCharacterId) {
                        listItem.classList.add('selected');
                    }
                    listItem.addEventListener('click', () => selectCharacter(char.id));
                    characterList.appendChild(listItem);
                });
            }

            function renderSequenceList() {
                sequenceList.innerHTML = '';
                const currentProject = projects.find(p => p.id === currentProjectId);
                if (!currentProject || currentProject.sequences.length === 0) {
                    sequenceList.innerHTML = '<li>ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œæ–°ã—ã„ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹ã€ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚</li>';
                    return;
                }
                currentProject.sequences.forEach(seq => {
                    const listItem = document.createElement('li');
                    listItem.textContent = seq.name;
                    listItem.dataset.id = seq.id;
                    if (seq.id === currentSequenceId) {
                        listItem.classList.add('selected');
                    }
                    listItem.addEventListener('click', () => selectSequence(seq.id));
                    sequenceList.appendChild(listItem);
                });
            }

            function renderSceneList() {
                sceneList.innerHTML = '';
                const currentProject = projects.find(p => p.id === currentProjectId);
                const currentSequence = currentProject ? currentProject.sequences.find(s => s.id === currentSequenceId) : null;

                if (!currentSequence || currentSequence.scenes.length === 0) {
                    sceneList.innerHTML = '<li>ã‚·ãƒ¼ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œã‚·ãƒ¼ãƒ³ã‚’è¿½åŠ ã€ã—ã¦ãã ã•ã„ã€‚</li>';
                    return;
                }
                currentSequence.scenes.forEach(scene => {
                    const listItem = document.createElement('li');
                    let displayTitle = '';
                    if (scene.type === 'timeline') {
                        displayTitle = `[${scene.data.date || 'æ—¥ä»˜ãªã—'}] ${scene.data.event?.substring(0, 30) || 'å‡ºæ¥äº‹ãªã—'}...`;
                    } else if (scene.type === 'character') {
                        // ä½œå“ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒªã‚¹ãƒˆã‹ã‚‰åå‰ã‚’å–å¾—ã€è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°ã‚·ãƒ¼ãƒ³ã®charNameã‚’ä½¿ç”¨
                        const charName = currentProject?.characters.find(c => c.id === scene.data.charId)?.name || scene.data.charName;
                        displayTitle = `ğŸ‘¤ ${charName || 'ä¸æ˜'} (${scene.data.charRole || 'å½¹å‰²ä¸æ˜'})`;
                    } else if (scene.type === 'story') {
                        displayTitle = `ğŸ“– ${scene.data.storyChapter || 'ç« ãªã—'}: ${scene.data.storySummary?.substring(0, 30) || 'æ¦‚è¦ãªã—'}...`;
                    }
                    listItem.textContent = displayTitle;
                    listItem.dataset.id = scene.id;
                    if (scene.id === currentSceneId) {
                        listItem.classList.add('selected');
                    }
                    listItem.addEventListener('click', () => selectScene(scene.id));
                    sceneList.appendChild(listItem);
                });
            }

            function renderSelectedSceneDetails() {
                const currentProject = projects.find(p => p.id === currentProjectId);
                const currentSequence = currentProject ? currentProject.sequences.find(s => s.id === currentSequenceId) : null;
                const currentScene = currentSequence ? currentSequence.scenes.find(sc => sc.id === currentSceneId) : null;

                selectedSceneContent.innerHTML = '';
                if (!currentScene) {
                    selectedSceneContent.textContent = 'ã‚·ãƒ¼ãƒ³ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚';
                    // æç”»ãƒ»ç”»åƒãƒ»ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¨ãƒªã‚¢ã‚‚ã‚¯ãƒªã‚¢
                    clearDrawingCanvas();
                    imagePreviewElement.innerHTML = '';
                    tablePreviewElement.innerHTML = '';
                    currentDrawingData = [];
                    currentImageData = null;
                    currentTableData = null;
                    return;
                }

                let detailText = '';
                if (currentScene.type === 'timeline') {
                    detailText = `
                        <strong>æ—¥ä»˜/æ™‚æœŸ:</strong> ${currentScene.data.date || 'æœªè¨­å®š'}<br>
                        <strong>å‡ºæ¥äº‹/å†…å®¹:</strong> ${currentScene.data.event || 'æœªè¨­å®š'}
                    `;
                } else if (currentScene.type === 'character') {
                    const charName = currentScene.data.charId ?
                                     (currentProject.characters.find(c => c.id === currentScene.data.charId)?.name || currentScene.data.charName) :
                                     currentScene.data.charName;
                    detailText = `
                        <strong>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å:</strong> ${charName || 'æœªè¨­å®š'}<br>
                        <strong>ç‰¹å¾´/æ€§æ ¼:</strong> ${currentScene.data.charTrait || 'æœªè¨­å®š'}<br>
                        <strong>å½¹å‰²:</strong> ${currentScene.data.charRole || 'æœªè¨­å®š'}
                        ${currentScene.data.charId ? `<br><button id="openCharacterDetailFromSceneButton" data-char-id="${currentScene.data.charId}">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è©³ç´°ã‚’é–‹ã</button>` : ''}
                    `;
                } else if (currentScene.type === 'story') {
                    detailText = `
                        <strong>ç« /ã‚·ãƒ¼ãƒ³:</strong> ${currentScene.data.storyChapter || 'æœªè¨­å®š'}<br>
                        <strong>æ¦‚è¦:</strong> ${currentScene.data.storySummary || 'æœªè¨­å®š'}<br>
                        <strong>è‘›è—¤/è§£æ±º:</strong> ${currentScene.data.storyConflict || 'æœªè¨­å®š'}
                    `;
                }
                selectedSceneContent.innerHTML = detailText;

                // æç”»ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã¨æç”»
                currentDrawingData = currentScene.drawings || [];
                drawAllDrawings();

                // ç”»åƒãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã¨è¡¨ç¤º
                currentImageData = currentScene.image || null;
                if (currentImageData && currentImageData.dataUrl) {
                    const img = document.createElement('img');
                    img.src = currentImageData.dataUrl;
                    imagePreviewElement.innerHTML = '';
                    imagePreviewElement.appendChild(img);
                } else {
                    imagePreviewElement.innerHTML = '';
                }

                // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã¨è¡¨ç¤º
                currentTableData = currentScene.table || null;
                if (currentTableData) {
                    renderTablePreview(currentTableData);
                } else {
                    tablePreviewElement.innerHTML = '';
                }

                // ã‚·ãƒ¼ãƒ³å†…ã®ã€Œã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è©³ç´°ã‚’é–‹ãã€ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                const openCharDetailBtn = document.getElementById('openCharacterDetailFromSceneButton');
                if (openCharDetailBtn) {
                    openCharDetailBtn.addEventListener('click', (e) => {
                        const charId = e.target.dataset.charId;
                        if (charId) {
                            selectCharacter(charId); // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒªã‚¹ãƒˆã§é¸æŠçŠ¶æ…‹ã«ã—ã¦ã€è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
                        }
                    });
                }
            }


            // --- é¸æŠãƒ»è¡¨ç¤ºåˆ¶å¾¡ ---
            function selectProject(projectId) {
                currentProjectId = projectId;
                currentSequenceId = null; // ä½œå“ãŒå¤‰ã‚ã£ãŸã‚‰ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
                currentSceneId = null; // ã‚·ãƒ¼ãƒ³é¸æŠã‚‚ãƒªã‚»ãƒƒãƒˆ
                currentCharacterId = null; // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠã‚‚ãƒªã‚»ãƒƒãƒˆ

                const selectedProject = projects.find(p => p.id === currentProjectId);
                currentProjectTitle.textContent = selectedProject ? selectedProject.name : 'ä½œå“ã‚’é¸æŠã—ã¦ãã ã•ã„';
                
                // å…¨ä½“æ¦‚è¦ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
                overallSummarySection.style.display = 'block';

                // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒªã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
                characterListSection.style.display = 'block';
                renderCharacterList(); // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒªã‚¹ãƒˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°

                // ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
                sequenceListSection.style.display = 'block';
                renderSequenceList();
                
                // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã‚·ãƒ¼ãƒ³é–¢é€£ã‚’éè¡¨ç¤º
                sceneInputSection.style.display = 'none';
                sceneListSection.style.display = 'none';
                sceneDetailsSection.style.display = 'none';
                currentSequenceTitle.style.display = 'none';
                currentSequenceTitle.textContent = ''; // ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹ã‚¿ã‚¤ãƒˆãƒ«ã‚‚ã‚¯ãƒªã‚¢

                updateUIState();
                populateCharacterSelectForScene(); // ã‚·ãƒ¼ãƒ³è¿½åŠ æ™‚ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠè‚¢ã‚’æ›´æ–°
            }

            function selectCharacter(characterId) {
                currentCharacterId = characterId;
                const currentProject = projects.find(p => p.id === currentProjectId);
                const selectedChar = currentProject?.characters.find(c => c.id === currentCharacterId);

                if (selectedChar) {
                    charDetailNameInput.value = selectedChar.name;
                    charDetailTraitInput.value = selectedChar.traits || '';
                    charDetailRoleInput.value = selectedChar.role || '';
                    charDetailSummaryTextarea.value = selectedChar.details || '';
                    characterDetailModal.style.display = 'flex'; // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
                }
                updateUIState();
            }

            function selectSequence(sequenceId) {
                currentSequenceId = sequenceId;
                currentSceneId = null; // ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹ãŒå¤‰ã‚ã£ãŸã‚‰ã‚·ãƒ¼ãƒ³é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
                const currentProject = projects.find(p => p.id === currentProjectId);
                const selectedSequence = currentProject?.sequences.find(s => s.id === currentSequenceId);
                currentSequenceTitle.textContent = selectedSequence ? selectedSequence.name : '';
                currentSequenceTitle.style.display = 'block';

                // ã‚·ãƒ¼ãƒ³å…¥åŠ›ã¨ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
                sceneInputSection.style.display = 'block';
                sceneListSection.style.display = 'block';
                renderSceneList();

                // ã‚·ãƒ¼ãƒ³è©³ç´°ã‚’éè¡¨ç¤º
                sceneDetailsSection.style.display = 'none';
                selectedSceneContent.innerHTML = '';

                updateUIState();
                drawTimeline(); // ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹ãŒé¸æŠã•ã‚ŒãŸã‚‰ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’å†æç”»
            }

            function selectScene(sceneId) {
                currentSceneId = sceneId;
                renderSelectedSceneDetails(); // ã‚·ãƒ¼ãƒ³è©³ç´°ã‚’è¡¨ç¤º

                // ã‚·ãƒ¼ãƒ³è©³ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
                sceneDetailsSection.style.display = 'block';
                
                updateUIState();
                drawTimeline(); // ã‚·ãƒ¼ãƒ³ãŒé¸æŠã•ã‚ŒãŸã‚‰ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’å†æç”»ï¼ˆé¸æŠã‚·ãƒ¼ãƒ³ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã®ãŸã‚ï¼‰
            }

            function resetMainContentVisibility() {
                // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã™ã¹ã¦ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹åˆæœŸåŒ–é–¢æ•°
                overallSummarySection.style.display = 'none';
                characterListSection.style.display = 'none';
                sequenceListSection.style.display = 'none';
                sceneInputSection.style.display = 'none';
                sceneListSection.style.display = 'none';
                sceneDetailsSection.style.display = 'none';
                currentProjectTitle.textContent = 'ä½œå“ã‚’é¸æŠã—ã¦ãã ã•ã„';
                currentSequenceTitle.style.display = 'none';
                currentSequenceTitle.textContent = '';
                selectedSceneContent.innerHTML = ''; // ã‚·ãƒ¼ãƒ³è©³ç´°ã‚‚ã‚¯ãƒªã‚¢
                clearDrawingCanvas(); // æç”»ã‚¯ãƒªã‚¢
                imagePreviewElement.innerHTML = ''; // ç”»åƒã‚¯ãƒªã‚¢
                tablePreviewElement.innerHTML = ''; // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¯ãƒªã‚¢
            }

            function updateUIState() {
                // ãƒªã‚¹ãƒˆã®é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
                document.querySelectorAll('#project-list li').forEach(li => li.classList.remove('selected'));
                if (currentProjectId) {
                    document.querySelector(`#project-list li[data-id="${currentProjectId}"]`)?.classList.add('selected');
                }
                document.querySelectorAll('#character-list li').forEach(li => li.classList.remove('selected')); // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒªã‚¹ãƒˆ
                if (currentCharacterId) {
                    document.querySelector(`#character-list li[data-id="${currentCharacterId}"]`)?.classList.add('selected');
                }
                document.querySelectorAll('#sequence-list li').forEach(li => li.classList.remove('selected'));
                if (currentSequenceId) {
                    document.querySelector(`#sequence-list li[data-id="${currentSequenceId}"]`)?.classList.add('selected');
                }
                document.querySelectorAll('#scene-list li').forEach(li => li.classList.remove('selected'));
                if (currentSceneId) {
                    document.querySelector(`#scene-list li[data-id="${currentSceneId}"]`)?.classList.add('selected');
                }

                // å‰Šé™¤ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹
                deleteProjectButton.disabled = !currentProjectId;
                deleteCharacterButton.disabled = !currentProjectId || !currentCharacterId; // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å‰Šé™¤ãƒœã‚¿ãƒ³
                deleteSequenceButton.disabled = !currentSequenceId;
                deleteSceneButton.disabled = !currentSceneId;
            }

            // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
            addProjectButton.addEventListener('click', () => {
                const projectName = prompt('æ–°ã—ã„ä½œå“ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
                if (projectName) {
                    const newProject = {
                        id: generateId(),
                        name: projectName,
                        overallSummary: '',
                        characters: [], // æ–°è¦ä½œå“ã«ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é…åˆ—ã‚’åˆæœŸåŒ–
                        sequences: []
                    };
                    projects.push(newProject);
                    saveProjects();
                    selectProject(newProject.id); // æ–°ã—ãä½œã£ãŸä½œå“ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
                }
            });

            deleteProjectButton.addEventListener('click', () => {
                if (!currentProjectId) return;
                const currentProjectName = projects.find(p => p.id === currentProjectId)?.name;
                if (confirm(`ä½œå“ã€Œ${currentProjectName}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`)) {
                    projects = projects.filter(p => p.id !== currentProjectId);
                    currentProjectId = null;
                    currentSequenceId = null;
                    currentSceneId = null;
                    currentCharacterId = null; 
                    saveProjects();
                    renderProjectList(); // ä½œå“ãƒªã‚¹ãƒˆã‚’å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                    resetMainContentVisibility(); // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å®Œå…¨ã«ãƒªã‚»ãƒƒãƒˆ
                    updateUIState();
                }
            });

            // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¿½åŠ 
            addCharacterButton.addEventListener('click', () => {
                if (!currentProjectId) {
                    alert('å…ˆã«ä½œå“ã‚’é¸æŠã¾ãŸã¯ä½œæˆã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                const charName = prompt('æ–°ã—ã„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
                if (charName) {
                    const currentProject = projects.find(p => p.id === currentProjectId);
                    if (currentProject) {
                        if (!currentProject.characters) { // äº’æ›æ€§ã®ãŸã‚åˆæœŸåŒ–
                            currentProject.characters = [];
                        }
                        const newCharacter = {
                            id: generateId(),
                            name: charName,
                            traits: '',
                            role: '',
                            details: ''
                        };
                        currentProject.characters.push(newCharacter);
                        saveProjects();
                        renderCharacterList(); // ãƒªã‚¹ãƒˆã‚’æ›´æ–°
                        populateCharacterSelectForScene(); // ã‚·ãƒ¼ãƒ³ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚‚æ›´æ–°
                        selectCharacter(newCharacter.id); // æ–°ã—ã„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸æŠã—ã€è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
                    }
                }
            });

            // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å‰Šé™¤
            deleteCharacterButton.addEventListener('click', () => {
                if (!currentProjectId || !currentCharacterId) return;
                const currentProject = projects.find(p => p.id === currentProjectId);
                const currentCharacterName = currentProject?.characters.find(c => c.id === currentCharacterId)?.name;
                if (confirm(`ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€Œ${currentCharacterName}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`)) {
                    if (currentProject) {
                        currentProject.characters = currentProject.characters.filter(c => c.id !== currentCharacterId);
                        currentCharacterId = null;
                        saveProjects();
                        renderCharacterList(); // ãƒªã‚¹ãƒˆã‚’æ›´æ–°
                        populateCharacterSelectForScene(); // ã‚·ãƒ¼ãƒ³ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚‚æ›´æ–°
                        updateUIState();
                        characterDetailModal.style.display = 'none'; // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                    }
                }
            });

            addSequenceButton.addEventListener('click', () => {
                if (!currentProjectId) {
                    alert('å…ˆã«ä½œå“ã‚’é¸æŠã¾ãŸã¯ä½œæˆã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                const sequenceName = prompt('æ–°ã—ã„ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
                if (sequenceName) {
                    const currentProject = projects.find(p => p.id === currentProjectId);
                    if (currentProject) {
                        const newSequence = {
                            id: generateId(),
                            name: sequenceName,
                            scenes: []
                        };
                        currentProject.sequences.push(newSequence);
                        saveProjects();
                        selectSequence(newSequence.id); // æ–°ã—ãä½œã£ãŸã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
                    }
                }
            });

            deleteSequenceButton.addEventListener('click', () => {
                if (!currentProjectId || !currentSequenceId) return;
                const currentProject = projects.find(p => p.id === currentProjectId);
                const currentSequenceName = currentProject?.sequences.find(s => s.id === currentSequenceId)?.name;
                if (confirm(`ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹ã€Œ${currentSequenceName}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`)) {
                    if (currentProject) {
                        currentProject.sequences = currentProject.sequences.filter(s => s.id !== currentSequenceId);
                        currentSequenceId = null;
                        currentSceneId = null; // ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹å‰Šé™¤ã§ã‚·ãƒ¼ãƒ³é¸æŠã‚‚ãƒªã‚»ãƒƒãƒˆ
                        saveProjects();
                        renderSequenceList(); // ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹ãƒªã‚¹ãƒˆã‚’å†æç”»
                        // ã‚·ãƒ¼ãƒ³é–¢é€£ã®UIã‚’éè¡¨ç¤ºã«
                        sceneInputSection.style.display = 'none';
                        sceneListSection.style.display = 'none';
                        sceneDetailsSection.style.display = 'none';
                        currentSequenceTitle.style.display = 'none';
                        currentSequenceTitle.textContent = '';
                        selectedSceneContent.innerHTML = '';
                        clearDrawingCanvas();
                        imagePreviewElement.innerHTML = '';
                        tablePreviewElement.innerHTML = '';
                        updateUIState();
                    }
                }
            });

            addSceneButton.addEventListener('click', () => {
                if (!currentProjectId || !currentSequenceId) {
                    alert('å…ˆã«ä½œå“ã¨ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                let newSceneData = {};
                let sceneType = document.querySelector('input[name="plotType"]:checked').value;

                if (sceneType === 'timeline') {
                    const date = dateInput.value.trim();
                    const event = eventInput.value.trim();
                    if (!date || !event) { alert('æ—¥ä»˜ã¨å‡ºæ¥äº‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
                    newSceneData = { date, event };
                } else if (sceneType === 'character') {
                    const selectedCharId = characterSelectForScene.value;
                    let charName = charNameInput.value.trim();
                    let charTrait = charTraitInput.value.trim();
                    let charRole = charRoleInput.value.trim();

                    if (selectedCharId) { // æ—¢å­˜ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸æŠã—ãŸå ´åˆ
                        const currentProject = projects.find(p => p.id === currentProjectId);
                        const selectedChar = currentProject?.characters.find(c => c.id === selectedCharId);
                        if (selectedChar) {
                            newSceneData = {
                                charId: selectedChar.id, // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼IDã‚’ç´ä»˜ã‘
                                charName: selectedChar.name, // åå‰ã¯ã‚·ãƒ¼ãƒ³ã«ã‚‚è¨˜éŒ²
                                charTrait: selectedChar.traits,
                                charRole: selectedChar.role
                            };
                        }
                    } else { // æ–°ã—ã„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’è¿½åŠ ã™ã‚‹å ´åˆ
                        if (!charName) { alert('ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
                        newSceneData = { charName, charTrait, charRole };

                        // æ–°ã—ã„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ä½œå“ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒªã‚¹ãƒˆã«ã‚‚è¿½åŠ 
                        const currentProject = projects.find(p => p.id === currentProjectId);
                        if (currentProject) {
                            if (!currentProject.characters) {
                                currentProject.characters = [];
                            }
                            const newCharacter = {
                                id: generateId(),
                                name: charName,
                                traits: charTrait,
                                role: charRole,
                                details: '' // æ–°è¦ä½œæˆæ™‚ã¯ç©º
                            };
                            currentProject.characters.push(newCharacter);
                            newSceneData.charId = newCharacter.id; // ã‚·ãƒ¼ãƒ³ã«ã‚‚IDã‚’ç´ä»˜ã‘
                            saveProjects(); // ã“ã“ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã‚’ä¿å­˜
                            renderCharacterList(); // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒªã‚¹ãƒˆã‚’æ›´æ–°
                            populateCharacterSelectForScene(); // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚‚æ›´æ–°
                        }
                    }
                } else if (sceneType === 'story') {
                    const storyChapter = storyChapterInput.value.trim();
                    const storySummary = storySummaryInput.value.trim();
                    const storyConflict = storyConflictInput.value.trim();
                    if (!storyChapter || !storySummary) { alert('ç« /ã‚·ãƒ¼ãƒ³ã¨æ¦‚è¦ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
                    newSceneData = { storyChapter, storySummary, storyConflict };
                }

                const newScene = {
                    id: generateId(),
                    type: sceneType,
                    data: newSceneData,
                    drawings: currentDrawingData, // ç¾åœ¨ã®æç”»ãƒ‡ãƒ¼ã‚¿ã‚’ç´ä»˜ã‘
                    image: currentImageData,     // ç¾åœ¨ã®ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’ç´ä»˜ã‘
                    table: currentTableData      // ç¾åœ¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ç´ä»˜ã‘
                };

                const currentProject = projects.find(p => p.id === currentProjectId);
                const currentSequence = currentProject?.sequences.find(s => s.id === currentSequenceId);
                if (currentSequence) {
                    currentSequence.scenes.push(newScene);
                    saveProjects();
                    renderSceneList(); // ã‚·ãƒ¼ãƒ³ãƒªã‚¹ãƒˆã‚’å†æç”»
                    selectScene(newScene.id); // è¿½åŠ ã—ãŸã‚·ãƒ¼ãƒ³ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
                    clearSceneInputs();
                }
            });

            deleteSceneButton.addEventListener('click', () => {
                if (!currentProjectId || !currentSequenceId || !currentSceneId) return;
                const currentProject = projects.find(p => p.id === currentProjectId);
                const currentSequence = currentProject?.sequences.find(s => s.id === currentSequenceId);
                
                if (currentSequence) {
                    // ã‚·ãƒ¼ãƒ³ã®å‰Šé™¤
                    currentSequence.scenes = currentSequence.scenes.filter(sc => sc.id !== currentSceneId);
                    currentSceneId = null; // å‰Šé™¤å¾Œã«é¸æŠä¸­ã®ã‚·ãƒ¼ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
                    saveProjects();
                    renderSceneList(); // ã‚·ãƒ¼ãƒ³ãƒªã‚¹ãƒˆã‚’å†æç”»

                    // ã‚·ãƒ¼ãƒ³è©³ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤ºã«ã—ã€å†…å®¹ã‚’ã‚¯ãƒªã‚¢
                    sceneDetailsSection.style.display = 'none';
                    selectedSceneContent.innerHTML = '';
                    clearDrawingCanvas();
                    imagePreviewElement.innerHTML = '';
                    tablePreviewElement.innerHTML = '';
                    updateUIState();
                }
            });

            clearSceneInputsButton.addEventListener('click', clearSceneInputs);

            function clearSceneInputs() {
                dateInput.value = '';
                eventInput.value = '';
                charNameInput.value = '';
                charTraitInput.value = '';
                charRoleInput.value = '';
                characterSelectForScene.value = ''; // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚‚ãƒªã‚»ãƒƒãƒˆ
                storyChapterInput.value = '';
                storySummaryInput.value = '';
                storyConflictInput.value = '';

                // æç”»ãƒ»ç”»åƒãƒ»ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
                currentDrawingData = [];
                clearDrawingCanvas();
                currentImageData = null;
                imagePreviewElement.innerHTML = '';
                currentTableData = null;
                tablePreviewElement.innerHTML = '';
            }

            // ãƒ—ãƒ­ãƒƒãƒˆã‚¿ã‚¤ãƒ—åˆ‡ã‚Šæ›¿ãˆ
            radioButtons.forEach(radio => {
                radio.addEventListener('change', (event) => {
                    const plotType = event.target.value;
                    timelineInputs.style.display = 'none';
                    characterInputs.style.display = 'none';
                    storyInputs.style.display = 'none';
                    if (plotType === 'timeline') {
                        timelineInputs.style.display = 'block';
                    } else if (plotType === 'character') {
                        characterInputs.style.display = 'block';
                        populateCharacterSelectForScene(); // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠè‚¢ã‚’æ›´æ–°
                    } else if (plotType === 'story') {
                        storyInputs.style.display = 'block';
                    }
                    clearSceneInputs(); // å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ åˆ‡ã‚Šæ›¿ãˆæ™‚ã‚‚ã‚¯ãƒªã‚¢
                });
            });

            // ã‚·ãƒ¼ãƒ³ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ—ãƒ­ãƒƒãƒˆå…¥åŠ›æ™‚ã«æ—¢å­˜ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸æŠã™ã‚‹ãŸã‚ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’ç”Ÿæˆ
            function populateCharacterSelectForScene() {
                characterSelectForScene.innerHTML = '<option value="">-- æ–°ã—ã„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ --</option>';
                const currentProject = projects.find(p => p.id === currentProjectId);
                if (currentProject && currentProject.characters) {
                    currentProject.characters.forEach(char => {
                        const option = document.createElement('option');
                        option.value = char.id;
                        option.textContent = char.name;
                        characterSelectForScene.appendChild(option);
                    });
                }
            }

            // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³é¸æŠæ™‚ã€åå‰ãƒ»ç‰¹å¾´ãƒ»å½¹å‰²ã®å…¥åŠ›æ¬„ã‚’ç„¡åŠ¹åŒ–/æœ‰åŠ¹åŒ–
            characterSelectForScene.addEventListener('change', () => {
                const isExistingCharSelected = characterSelectForScene.value !== '';
                charNameInput.disabled = isExistingCharSelected;
                charTraitInput.disabled = isExistingCharSelected;
                charRoleInput.disabled = isExistingCharSelected;

                // æ—¢å­˜ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸æŠã—ãŸå ´åˆã€ãã®æƒ…å ±ã‚’å…¥åŠ›æ¬„ã«è¡¨ç¤ºï¼ˆç·¨é›†ã¯ä¸å¯ã ãŒå‚è€ƒç”¨ï¼‰
                if (isExistingCharSelected) {
                    const currentProject = projects.find(p => p.id === currentProjectId);
                    const selectedChar = currentProject?.characters.find(c => c.id === characterSelectForScene.value);
                    if (selectedChar) {
                        charNameInput.value = selectedChar.name;
                        charTraitInput.value = selectedChar.traits;
                        charRoleInput.value = selectedChar.role;
                    }
                } else {
                    charNameInput.value = '';
                    charTraitInput.value = '';
                    charRoleInput.value = '';
                }
            });


            // --- å…¨ä½“æ¦‚è¦ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ ---
            openOverallSummaryModalButton.addEventListener('click', () => {
                const currentProject = projects.find(p => p.id === currentProjectId);
                if (currentProject) {
                    overallSummaryTextarea.value = currentProject.overallSummary || '';
                    overallSummaryModal.style.display = 'flex'; // Flexboxã§ä¸­å¤®è¡¨ç¤º
                }
            });

            closeOverallSummaryModalButton.addEventListener('click', () => {
                overallSummaryModal.style.display = 'none';
            });

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            overallSummaryModal.addEventListener('click', (event) => {
                if (event.target === overallSummaryModal) {
                    overallSummaryModal.style.display = 'none';
                }
            });

            saveOverallSummaryButton.addEventListener('click', () => {
                const currentProject = projects.find(p => p.id === currentProjectId);
                if (currentProject) {
                    currentProject.overallSummary = overallSummaryTextarea.value;
                    saveProjects();
                    alert('å…¨ä½“æ¦‚è¦ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
                    overallSummaryModal.style.display = 'none';
                }
            });

            // --- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ ---
            // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒªã‚¹ãƒˆã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã¯renderCharacterListå†…ã§è¨­å®š
            closeCharacterDetailModalButton.addEventListener('click', () => {
                characterDetailModal.style.display = 'none';
                currentCharacterId = null; // é¸æŠè§£é™¤
                updateUIState();
            });

            characterDetailModal.addEventListener('click', (event) => {
                if (event.target === characterDetailModal) {
                    characterDetailModal.style.display = 'none';
                    currentCharacterId = null; // é¸æŠè§£é™¤
                    updateUIState();
                }
            });

            saveCharacterDetailButton.addEventListener('click', () => {
                const currentProject = projects.find(p => p.id === currentProjectId);
                const selectedChar = currentProject?.characters.find(c => c.id === currentCharacterId);
                if (selectedChar) {
                    selectedChar.name = charDetailNameInput.value.trim();
                    selectedChar.traits = charDetailTraitInput.value.trim();
                    selectedChar.role = charDetailRoleInput.value.trim();
                    selectedChar.details = charDetailSummaryTextarea.value.trim();
                    saveProjects();
                    alert('ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è©³ç´°ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
                    characterDetailModal.style.display = 'none';
                    renderCharacterList(); // ãƒªã‚¹ãƒˆè¡¨ç¤ºã‚’æ›´æ–°
                    populateCharacterSelectForScene(); // ã‚·ãƒ¼ãƒ³ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚‚æ›´æ–°
                    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã€ã‚·ãƒ¼ãƒ³ãƒªã‚¹ãƒˆã®è¡¨ç¤ºã‚‚æ›´æ–°ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
                    if (currentProjectId && currentSequenceId) { // ç¾åœ¨ä½œå“ã¨ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹ãŒé¸æŠã•ã‚Œã¦ã„ã‚Œã°
                        renderSceneList();
                        renderSelectedSceneDetails(); // é¸æŠä¸­ã®ã‚·ãƒ¼ãƒ³è©³ç´°ã‚‚æ›´æ–°
                    }
                }
            });


            // --- æç”»æ©Ÿèƒ½ ---
            function clearDrawingCanvas() {
                drawingContext.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
            }

            function drawAllDrawings() {
                clearDrawingCanvas();
                drawingContext.lineCap = 'round'; // ç·šç«¯ã®ã‚¹ã‚¿ã‚¤ãƒ«
                drawingContext.lineJoin = 'round'; // ç·šçµåˆéƒ¨ã®ã‚¹ã‚¿ã‚¤ãƒ«

                currentDrawingData.forEach(path => {
                    drawingContext.beginPath();
                    drawingContext.strokeStyle = path.color;
                    drawingContext.lineWidth = path.thickness;
                    if (path.points.length > 0) {
                        drawingContext.moveTo(path.points[0].x, path.points[0].y);
                        for(let i = 1; i < path.points.length; i++) {
                            drawingContext.lineTo(path.points[i].x, path.points[i].y);
                        }
                    }
                    drawingContext.stroke();
                });
            }

            drawingModeButton.addEventListener('click', () => {
                isDrawingMode = !isDrawingMode;
                drawingModeButton.textContent = isDrawingMode ? 'æç”»ãƒ¢ãƒ¼ãƒ‰çµ‚äº†' : 'æç”»ãƒ¢ãƒ¼ãƒ‰é–‹å§‹';
                drawingModeButton.classList.toggle('danger', isDrawingMode);
                drawingCanvas.style.cursor = isDrawingMode ? 'crosshair' : 'default';
                if (!currentSceneId && isDrawingMode) {
                    alert('ã‚·ãƒ¼ãƒ³ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚æç”»ã¯ä¸€æ™‚çš„ã§ã€ã‚·ãƒ¼ãƒ³ã«ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚');
                } else {
                    alert(isDrawingMode ? 'æç”»ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚' : 'æç”»ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†ã—ã¾ã—ãŸã€‚');
                }
            });

            drawingCanvas.addEventListener('mousedown', (e) => {
                if (!isDrawingMode) return;
                isDrawing = true;
                const rect = drawingCanvas.getBoundingClientRect();
                lastX = e.clientX - rect.left;
                lastY = e.clientY - rect.top;
                drawingPath = [{ x: lastX, y: lastY }];
            });

            drawingCanvas.addEventListener('mousemove', (e) => {
                if (!isDrawing || !isDrawingMode) return;
                const rect = drawingCanvas.getBoundingClientRect();
                const currentX = e.clientX - rect.left;
                const currentY = e.clientY - rect.top;

                drawingContext.beginPath();
                drawingContext.moveTo(lastX, lastY);
                drawingContext.lineTo(currentX, currentY);
                drawingContext.strokeStyle = lineColorInput.value;
                drawingContext.lineWidth = lineThicknessInput.value;
                drawingContext.stroke();

                drawingPath.push({ x: currentX, y: currentY });
                lastX = currentX;
                lastY = currentY;
            });

            drawingCanvas.addEventListener('mouseup', () => {
                if (isDrawing && isDrawingMode) {
                    currentDrawingData.push({
                        points: drawingPath,
                        color: lineColorInput.value,
                        thickness: lineThicknessInput.value
                    });
                    isDrawing = false;
                    // ã‚·ãƒ¼ãƒ³ãŒé¸æŠã•ã‚Œã¦ã„ã‚Œã°ã€æç”»ãƒ‡ãƒ¼ã‚¿ã‚’ã‚·ãƒ¼ãƒ³ã«ä¿å­˜
                    const currentProject = projects.find(p => p.id === currentProjectId);
                    const currentSequence = currentProject?.sequences.find(s => s.id === currentSequenceId);
                    const currentScene = currentSequence?.scenes.find(sc => sc.id === currentSceneId);
                    if (currentScene) {
                        currentScene.drawings = currentDrawingData;
                        saveProjects();
                        // alert('æç”»ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚'); // ä¿å­˜ã®ãŸã³ã«ã‚¢ãƒ©ãƒ¼ãƒˆã¯ã†ã‚‹ã•ã„ã®ã§ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
                    } else {
                        // alert('ã‚·ãƒ¼ãƒ³ãŒé¸æŠã•ã‚Œã¦ã„ãªã„ãŸã‚ã€æç”»ã¯ä¸€æ™‚çš„ã§ã™ã€‚ã‚·ãƒ¼ãƒ³ã‚’é¸æŠã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚');
                    }
                }
            });

            // ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹å‘ã‘ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ
            drawingCanvas.addEventListener('touchstart', (e) => {
                if (!isDrawingMode) return;
                e.preventDefault(); // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãªã©ã‚’é˜²ã
                isDrawing = true;
                const rect = drawingCanvas.getBoundingClientRect();
                lastX = e.touches[0].clientX - rect.left;
                lastY = e.touches[0].clientY - rect.top;
                drawingPath = [{ x: lastX, y: lastY }];
            });

            drawingCanvas.addEventListener('touchmove', (e) => {
                if (!isDrawing || !isDrawingMode) return;
                e.preventDefault(); // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãªã©ã‚’é˜²ã
                const rect = drawingCanvas.getBoundingClientRect();
                const currentX = e.touches[0].clientX - rect.left;
                const currentY = e.touches[0].clientY - rect.top;

                drawingContext.beginPath();
                drawingContext.moveTo(lastX, lastY);
                drawingContext.lineTo(currentX, currentY);
                drawingContext.strokeStyle = lineColorInput.value;
                drawingContext.lineWidth = lineThicknessInput.value;
                drawingContext.stroke();

                drawingPath.push({ x: currentX, y: currentY });
                lastX = currentX;
                lastY = currentY;
            });

            drawingCanvas.addEventListener('touchend', () => {
                if (isDrawing && isDrawingMode) {
                    currentDrawingData.push({
                        points: drawingPath,
                        color: lineColorInput.value,
                        thickness: lineThicknessInput.value
                    });
                    isDrawing = false;
                    const currentProject = projects.find(p => p.id === currentProjectId);
                    const currentSequence = currentProject?.sequences.find(s => s.id === currentSequenceId);
                    const currentScene = currentSequence?.scenes.find(sc => sc.id === currentSceneId);
                    if (currentScene) {
                        currentScene.drawings = currentDrawingData;
                        saveProjects();
                        // alert('æç”»ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
                    } else {
                        // alert('ã‚·ãƒ¼ãƒ³ãŒé¸æŠã•ã‚Œã¦ã„ãªã„ãŸã‚ã€æç”»ã¯ä¸€æ™‚çš„ã§ã™ã€‚ã‚·ãƒ¼ãƒ³ã‚’é¸æŠã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚');
                    }
                }
            });

            clearDrawingButton.addEventListener('click', () => {
                if (confirm('æç”»ã‚’å…¨ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                    clearDrawingCanvas();
                    currentDrawingData = [];
                    const currentProject = projects.find(p => p.id === currentProjectId);
                    const currentSequence = currentProject?.sequences.find(s => s.id === currentSequenceId);
                    const currentScene = currentSequence?.scenes.find(sc => sc.id === currentSceneId);
                    if (currentScene) {
                        currentScene.drawings = currentDrawingData;
                        saveProjects();
                        alert('æç”»ã‚’ã‚¯ãƒªã‚¢ã—ã¦ä¿å­˜ã—ã¾ã—ãŸã€‚');
                    } else {
                        alert('æç”»ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚');
                    }
                }
            });


            // --- ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ ---
            imageUploadInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        currentImageData = { dataUrl: e.target.result, name: file.name };
                        const img = document.createElement('img');
                        img.src = currentImageData.dataUrl;
                        imagePreviewElement.innerHTML = '';
                        imagePreviewElement.appendChild(img);

                        // ã‚·ãƒ¼ãƒ³ãŒé¸æŠã•ã‚Œã¦ã„ã‚Œã°ã€ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’ã‚·ãƒ¼ãƒ³ã«ä¿å­˜
                        const currentProject = projects.find(p => p.id === currentProjectId);
                        const currentSequence = currentProject?.sequences.find(s => s.id === currentSequenceId);
                        const currentScene = currentSequence?.scenes.find(sc => sc.id === currentSceneId);
                        if (currentScene) {
                            currentScene.image = currentImageData;
                            saveProjects();
                            alert('ç”»åƒã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
                        } else {
                            alert('ã‚·ãƒ¼ãƒ³ãŒé¸æŠã•ã‚Œã¦ã„ãªã„ãŸã‚ã€ç”»åƒã¯ä¸€æ™‚çš„ã§ã™ã€‚ã‚·ãƒ¼ãƒ³ã‚’é¸æŠã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚');
                        }
                    };
                    reader.readAsDataURL(file);
                } else {
                    currentImageData = null;
                    imagePreviewElement.innerHTML = '';
                    const currentProject = projects.find(p => p.id === currentProjectId);
                    const currentSequence = currentProject?.sequences.find(s => s.id === currentSequenceId);
                    const currentScene = currentSequence?.scenes.find(sc => sc.id === currentSceneId);
                    if (currentScene) {
                        delete currentScene.image; // ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
                        saveProjects();
                        alert('ç”»åƒã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
                    }
                }
            });

            // --- ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ ---
            function renderTablePreview(data) {
                if (!data || data.length === 0) {
                    tablePreviewElement.innerHTML = '';
                    return;
                }
                const table = document.createElement('table');
                table.innerHTML = ''; // ã‚¯ãƒªã‚¢

                data.forEach((row, rowIndex) => {
                    const tr = document.createElement('tr');
                    row.forEach((cell, colIndex) => {
                        const td = document.createElement('td');
                        td.textContent = cell;
                        td.contentEditable = true; // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ç·¨é›†å¯èƒ½ã«ã™ã‚‹
                        td.dataset.rowIndex = rowIndex;
                        td.dataset.colIndex = colIndex;
                        td.addEventListener('blur', (e) => {
                            // ç·¨é›†å†…å®¹ã‚’currentTableDataã«åæ˜ 
                            currentTableData[parseInt(e.target.dataset.rowIndex)][parseInt(e.target.dataset.colIndex)] = e.target.textContent;
                            // ã‚·ãƒ¼ãƒ³ãŒé¸æŠã•ã‚Œã¦ã„ã‚Œã°ã€ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚·ãƒ¼ãƒ³ã«ä¿å­˜
                            const currentProject = projects.find(p => p.id === currentProjectId);
                            const currentSequence = currentProject?.sequences.find(s => s.id === currentSequenceId);
                            const currentScene = currentSequence?.scenes.find(sc => sc.id === currentSceneId);
                            if (currentScene) {
                                currentScene.table = currentTableData;
                                saveProjects();
                                // console.log('ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚'); // ãƒ‡ãƒãƒƒã‚°ç”¨
                            }
                        });
                        tr.appendChild(td);
                    });
                    table.appendChild(tr);
                });
                tablePreviewElement.innerHTML = '';
                tablePreviewElement.appendChild(table);
            }

            createTableButton.addEventListener('click', () => {
                const rows = parseInt(tableRowsInput.value) || 3;
                const cols = parseInt(tableColsInput.value) || 3;
                if (rows > 0 && cols > 0) {
                    currentTableData = Array.from({ length: rows }, () => Array(cols).fill(''));
                    renderTablePreview(currentTableData);
                    // ã‚·ãƒ¼ãƒ³ãŒé¸æŠã•ã‚Œã¦ã„ã‚Œã°ã€ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚·ãƒ¼ãƒ³ã«ä¿å­˜
                    const currentProject = projects.find(p => p.id === currentProjectId);
                    const currentSequence = currentProject?.sequences.find(s => s.id === currentSequenceId);
                    const currentScene = currentSequence?.scenes.find(sc => sc.id === currentSceneId);
                    if (currentScene) {
                        currentScene.table = currentTableData;
                        saveProjects();
                        alert('ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆãƒ»ä¿å­˜ã—ã¾ã—ãŸã€‚');
                    } else {
                        alert('ã‚·ãƒ¼ãƒ³ãŒé¸æŠã•ã‚Œã¦ã„ãªã„ãŸã‚ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ä¸€æ™‚çš„ã§ã™ã€‚ã‚·ãƒ¼ãƒ³ã‚’é¸æŠã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚');
                    }
                } else {
                    alert('è¡Œæ•°ã¨åˆ—æ•°ã¯1ä»¥ä¸Šã§æŒ‡å®šã—ã¦ãã ã•ã„ã€‚');
                }
            });

            // --- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æç”» ---
            function drawTimeline() {
                timelineContext.clearRect(0, 0, timelineCanvas.width, timelineCanvas.height);
                timelineContext.font = '12px Arial';
                timelineContext.fillStyle = '#333';
                timelineContext.textAlign = 'center';
                timelineContext.strokeStyle = '#ccc';
                timelineContext.lineWidth = 1;

                const currentProject = projects.find(p => p.id === currentProjectId);
                const currentSequence = currentProject?.sequences.find(s => s.id === currentSequenceId);

                if (!currentSequence || currentSequence.scenes.length === 0) {
                    timelineContext.fillText('ã“ã®ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹ã«ã¯ã‚·ãƒ¼ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', timelineCanvas.width / 2, timelineCanvas.height / 2);
                    return;
                }

                // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è»¸ã®æç”»
                const startX = 50;
                const endX = timelineCanvas.width - 50;
                const lineY = timelineCanvas.height / 2;
                timelineContext.beginPath();
                timelineContext.moveTo(startX, lineY);
                timelineContext.lineTo(endX, lineY);
                timelineContext.stroke();

                // å„ã‚·ãƒ¼ãƒ³ã‚’ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ä¸Šã«é…ç½®
                const sceneCount = currentSequence.scenes.length;
                // ã‚·ãƒ¼ãƒ³ãŒ1ã¤ã®å ´åˆã¯é–“éš”ã‚’0ã«ã™ã‚‹ (ç·šä¸Šã«1ç‚¹ã ã‘æç”»)
                const spacing = (sceneCount > 1) ? (endX - startX) / (sceneCount - 1) : 0; 

                currentSequence.scenes.forEach((scene, index) => {
                    const x = startX + (index * spacing);
                    const y = lineY;

                    // ç›®ç››ã‚Š
                    timelineContext.beginPath();
                    timelineContext.moveTo(x, y - 5);
                    timelineContext.lineTo(x, y + 5);
                    timelineContext.stroke();

                    // ã‚·ãƒ¼ãƒ³åï¼ˆãƒ‡ãƒ¼ã‚¿ã«å¿œã˜ã¦è¡¨ç¤ºã‚’èª¿æ•´ï¼‰
                    let sceneLabel = '';
                    if (scene.type === 'timeline' && scene.data.date) {
                        sceneLabel = scene.data.date;
                    } else if (scene.type === 'character') {
                        // ã‚·ãƒ¼ãƒ³ãŒæŒã¤charNameã‚’ä½¿ç”¨ã€ã¾ãŸã¯charIdã‹ã‚‰ä½œå“ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åã‚’å–å¾—
                        sceneLabel = scene.data.charName || (currentProject?.characters.find(c => c.id === scene.data.charId)?.name || `ğŸ‘¤ ã‚·ãƒ¼ãƒ³${index + 1}`);
                    } else if (scene.type === 'story' && scene.data.storyChapter) {
                        sceneLabel = scene.data.storyChapter;
                    } else {
                        sceneLabel = `ã‚·ãƒ¼ãƒ³ ${index + 1}`;
                    }

                    // ãƒ†ã‚­ã‚¹ãƒˆã‚’å›è»¢ã•ã›ã¦è¡¨ç¤º
                    timelineContext.save();
                    timelineContext.translate(x, y + 15);
                    timelineContext.rotate(Math.PI / 6); // 30åº¦å›è»¢
                    timelineContext.fillText(sceneLabel, 0, 0);
                    timelineContext.restore();

                    // é¸æŠä¸­ã®ã‚·ãƒ¼ãƒ³ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                    if (scene.id === currentSceneId) {
                        timelineContext.beginPath();
                        timelineContext.arc(x, y, 8, 0, Math.PI * 2);
                        timelineContext.fillStyle = '#3498db';
                        timelineContext.fill();
                        timelineContext.strokeStyle = '#2980b9';
                        timelineContext.lineWidth = 2;
                        timelineContext.stroke();
                    }
                });
            }

            timelineDisplayModeButton.addEventListener('click', () => {
                // ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿æç”»
                if (currentProjectId && currentSequenceId) {
                    drawTimeline();
                } else {
                    alert('ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯ã€ä½œå“ã¨ã‚·ãƒ¼ã‚¯ã‚¨ãƒ³ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                }
            });


            // --- åˆæœŸåŒ– ---
            loadProjects(); // ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«ä¿å­˜ã•ã‚ŒãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’èª­ã¿è¾¼ã‚€
            if (projects.length > 0) {
                // æœ€å¾Œã«é¸æŠã•ã‚Œã¦ã„ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãªã©ã‚’è¨˜æ†¶ãƒ»å¾©å…ƒã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ãŒã‚ã‚Œã°ã‚ˆã‚Šè‰¯ã„
                // ä»Šå›ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æœ€åˆã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ
                // projects[0]ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿selectProjectã‚’å‘¼ã³å‡ºã™
                if (projects[0]) {
                    selectProject(projects[0].id);
                }
            } else {
                resetMainContentVisibility(); // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒä¸€ã¤ã‚‚ãªã„å ´åˆã¯UIã‚’åˆæœŸçŠ¶æ…‹ã«
            }
            updateUIState(); // UIã®åˆæœŸçŠ¶æ…‹ã‚’æ›´æ–°
        });
    </script>
</body>
</html>
