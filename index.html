<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>プロットメーカー PRO</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #app {
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            padding: 30px;
            width: 90%;
            max-width: 1000px; /* 少し広めに */
            margin-bottom: 30px;
            display: flex; /* Flexboxでレイアウト */
            gap: 20px;
        }
        #sidebar {
            width: 250px;
            padding-right: 20px;
            border-right: 1px solid #eee;
            flex-shrink: 0; /* 縮まない */
        }
        #main-content {
            flex-grow: 1; /* 残りのスペースを埋める */
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }

        /* サイドバー */
        #project-list, #sequence-list, #scene-list {
            list-style: none;
            padding: 0;
            margin: 15px 0;
            max-height: 250px; /* スクロール可能にするため */
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 5px;
            background-color: #fcfcfc;
        }
        #project-list li, #sequence-list li, #scene-list li {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #project-list li:last-child, #sequence-list li:last-child, #scene-list li:last-child {
            border-bottom: none;
        }
        #project-list li.selected, #sequence-list li.selected, #scene-list li.selected {
            background-color: #e0f7fa;
            font-weight: bold;
            color: #00796b;
        }
        #project-list li:hover:not(.selected), #sequence-list li:hover:not(.selected), #scene-list li:hover:not(.selected) {
            background-color: #f0f0f0;
        }

        /* ボタン */
        button {
            background-color: #4CAF50; /* Green */
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 10px;
            transition: background-color 0.2s ease;
        }
        button:hover {
            background-color: #45a049;
        }
        button.delete-btn {
            background-color: #f44336; /* Red */
            margin-left: 10px;
        }
        button.delete-btn:hover {
            background-color: #da190b;
        }
        button.small-btn {
            padding: 5px 8px;
            font-size: 0.8rem;
            margin-top: 0;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        /* フォーム */
        input[type="text"], textarea {
            width: calc(100% - 20px);
            padding: 10px;
            margin-top: 5px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
            color: #555;
        }

        /* メインコンテンツの表示/非表示 */
        #project-detail, #sequence-detail, #scene-detail, #empty-state {
            display: none;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
            background-color: #fdfdfd;
        }
        #empty-state {
            text-align: center;
            color: #777;
            font-size: 1.1rem;
            margin-top: 50px;
        }
        #project-detail.active, #sequence-detail.active, #scene-detail.active, #empty-state.active {
            display: block;
        }

        /* ドラッグ＆ドロップ */
        .draggable {
            cursor: grab;
        }
        .dragging {
            opacity: 0.5;
        }
        .drag-over {
            border-top: 2px solid #00796b;
        }
        .drag-over-bottom {
            border-bottom: 2px solid #00796b;
        }

        /* タイムライン表示 */
        #timeline-container {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
            min-height: 100px;
            display: flex;
            flex-wrap: wrap; /* シーンが折り返して表示されるように */
            gap: 10px;
            align-items: center;
        }
        .timeline-scene {
            background-color: #bbdefb;
            border: 1px solid #81d4fa;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.9em;
            white-space: nowrap; /* タイムライン上では改行しない */
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px; /* シーン幅を制限 */
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .timeline-scene:hover {
            background-color: #90caf9;
        }
        .timeline-arrow {
            font-size: 1.2em;
            color: #616161;
        }

        /* レスポンシブデザイン */
        @media (max-width: 768px) {
            #app {
                flex-direction: column;
                padding: 15px;
            }
            #sidebar {
                width: 100%;
                padding-right: 0;
                border-right: none;
                border-bottom: 1px solid #eee;
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <h1>プロットメーカー PRO</h1>
    <div id="app">
        <div id="sidebar">
            <h2>作品リスト</h2>
            <div class="button-group">
                <button onclick="addNewProject()">新しい作品</button>
            </div>
            <ul id="project-list">
                </ul>

            <div id="current-project-info" style="margin-top: 20px;">
                </div>

            <h2>シーケンスリスト</h2>
            <div class="button-group">
                <button onclick="addNewSequence()">新しいシーケンス</button>
            </div>
            <ul id="sequence-list">
                </ul>

            <h2>シーンリスト</h2>
            <div class="button-group">
                <button onclick="addNewScene()">新しいシーン</button>
            </div>
            <ul id="scene-list">
                </ul>
        </div>

        <div id="main-content">
            <div id="empty-state" class="active">
                <p>左のリストから作品を選択するか、新しい作品を作成してください。</p>
            </div>

            <div id="project-detail">
                <h2>作品詳細</h2>
                <label for="project-name">作品名:</label>
                <input type="text" id="project-name" oninput="updateProjectDetail('name')">
                <label for="project-summary">あらすじ:</label>
                <textarea id="project-summary" oninput="updateProjectDetail('summary')"></textarea>
                <div class="button-group">
                    <button class="delete-btn" onclick="deleteProject()">作品を削除</button>
                </div>
            </div>

            <div id="sequence-detail">
                <h2>シーケンス詳細</h2>
                <label for="sequence-name">シーケンス名:</label>
                <input type="text" id="sequence-name" oninput="updateSequenceDetail('name')">
                <label for="sequence-summary">概要:</label>
                <textarea id="sequence-summary" oninput="updateSequenceDetail('summary')"></textarea>
                <div class="button-group">
                    <button class="delete-btn" onclick="deleteSequence()">シーケンスを削除</button>
                </div>
            </div>

            <div id="scene-detail">
                <h2>シーン詳細</h2>
                <label for="scene-name">シーン名:</label>
                <input type="text" id="scene-name" oninput="updateSceneDetail('name')">
                <label for="scene-summary">概要:</label>
                <textarea id="scene-summary" oninput="updateSceneDetail('summary')"></textarea>
                <label for="scene-characters">登場人物:</label>
                <textarea id="scene-characters" oninput="updateSceneDetail('characters')"></textarea>
                <label for="scene-setting">場所・設定:</label>
                <textarea id="scene-setting" oninput="updateSceneDetail('setting')"></textarea>
                <label for="scene-plot">プロット:</label>
                <textarea id="scene-plot" oninput="updateSceneDetail('plot')"></textarea>
                <div class="button-group">
                    <button class="delete-btn" onclick="deleteScene()">シーンを削除</button>
                </div>
            </div>

            <h3>時系列</h3>
            <div id="timeline-container">
                <p id="no-timeline-scenes" style="color: #777; display: none;">選択中のシーケンスにシーンがありません。</p>
            </div>
        </div>
    </div>

    <script>
        let projects = [];
        let selectedProjectId = null;
        let selectedSequenceId = null;
        let selectedSceneId = null;

        // ドラッグ＆ドロップ用変数
        let draggedItem = null;
        let dragType = null; // 'project', 'sequence', 'scene'

        // localStorageからデータを読み込む
        function loadProjects() {
            const savedProjects = localStorage.getItem('projects');
            if (savedProjects) {
                projects = JSON.parse(savedProjects);
            }
        }

        // localStorageにデータを保存する
        function saveProjects() {
            localStorage.setItem('projects', JSON.stringify(projects));
        }

        // UIの状態をリセット
        function resetMainContentVisibility() {
            document.querySelectorAll('#main-content > div').forEach(div => {
                div.classList.remove('active');
            });
            document.getElementById('empty-state').classList.add('active');
            document.getElementById('current-project-info').innerHTML = '';
            document.getElementById('sequence-list').innerHTML = '';
            document.getElementById('scene-list').innerHTML = '';
            document.getElementById('timeline-container').innerHTML = '<p id="no-timeline-scenes" style="color: #777; display: none;">選択中のシーケンスにシーンがありません。</p>';
        }

        // UIの状態を更新（サイドバーのリスト表示、詳細エリアの表示）
        function updateUIState() {
            renderProjectList();
            if (selectedProjectId) {
                const project = projects.find(p => p.id === selectedProjectId);
                document.getElementById('current-project-info').innerHTML = `<h3>選択中の作品: ${project ? project.name : 'なし'}</h3>`;
                renderSequenceList();
                renderSceneList();
                if (selectedSceneId) {
                    selectScene(selectedSceneId); // シーンが選択されていればシーン詳細を表示
                } else if (selectedSequenceId) {
                    selectSequence(selectedSequenceId); // シーケンスが選択されていればシーケンス詳細を表示
                } else {
                    selectProject(selectedProjectId); // 作品が選択されていれば作品詳細を表示
                }
            } else {
                resetMainContentVisibility();
            }
            drawTimeline(); // タイムラインも常に更新
        }

        // --- 作品関連の関数 ---
        function addNewProject() {
            const newProject = {
                id: Date.now().toString(),
                name: '新しい作品',
                summary: '',
                sequences: []
            };
            projects.push(newProject);
            saveProjects();
            selectProject(newProject.id);
            updateUIState();
        }

        function renderProjectList() {
            const projectList = document.getElementById('project-list');
            projectList.innerHTML = '';
            projects.forEach(project => {
                const li = document.createElement('li');
                li.className = 'draggable';
                li.textContent = project.name;
                li.setAttribute('data-id', project.id);
                li.setAttribute('data-type', 'project');
                if (project.id === selectedProjectId) {
                    li.classList.add('selected');
                }
                li.onclick = (e) => {
                    e.stopPropagation(); // ドラッグ開始との競合を避ける
                    selectProject(project.id);
                };

                // ドラッグイベントリスナー
                li.setAttribute('draggable', 'true');
                li.addEventListener('dragstart', handleDragStart);
                li.addEventListener('dragover', handleDragOver);
                li.addEventListener('dragleave', handleDragLeave);
                li.addEventListener('drop', handleDrop);

                projectList.appendChild(li);
            });
        }

        function selectProject(id) {
            selectedProjectId = id;
            selectedSequenceId = null; // 作品が変わったらシーケンス選択を解除
            selectedSceneId = null; // 作品が変わったらシーン選択を解除
            localStorage.setItem('lastSelectedProjectId', id); // 選択中の作品を記憶
            updateUIState();

            const project = projects.find(p => p.id === id);
            if (project) {
                document.getElementById('project-detail').classList.add('active');
                document.getElementById('empty-state').classList.remove('active');
                document.getElementById('sequence-detail').classList.remove('active');
                document.getElementById('scene-detail').classList.remove('active');
                document.getElementById('project-name').value = project.name;
                document.getElementById('project-summary').value = project.summary;
            }
        }

        function updateProjectDetail(field) {
            if (!selectedProjectId) return;
            const project = projects.find(p => p.id === selectedProjectId);
            if (project) {
                if (field === 'name') {
                    project.name = document.getElementById('project-name').value;
                } else if (field === 'summary') {
                    project.summary = document.getElementById('project-summary').value;
                }
                saveProjects();
                updateUIState(); // リストの表示を更新
            }
        }

        function deleteProject() {
            if (!selectedProjectId) return;
            if (confirm('この作品を完全に削除してもよろしいですか？')) {
                projects = projects.filter(p => p.id !== selectedProjectId);
                saveProjects();
                selectedProjectId = null;
                selectedSequenceId = null;
                selectedSceneId = null;
                localStorage.removeItem('lastSelectedProjectId');
                updateUIState();
            }
        }

        // --- シーケンス関連の関数 ---
        function addNewSequence() {
            if (!selectedProjectId) {
                alert('先に作品を選択してください。');
                return;
            }
            const project = projects.find(p => p.id === selectedProjectId);
            if (project) {
                const newSequence = {
                    id: Date.now().toString(),
                    name: '新しいシーケンス',
                    summary: '',
                    scenes: []
                };
                project.sequences.push(newSequence);
                saveProjects();
                selectSequence(newSequence.id);
                updateUIState();
            }
        }

        function renderSequenceList() {
            const sequenceList = document.getElementById('sequence-list');
            sequenceList.innerHTML = '';
            const project = projects.find(p => p.id === selectedProjectId);
            if (project && project.sequences.length > 0) {
                project.sequences.forEach(sequence => {
                    const li = document.createElement('li');
                    li.className = 'draggable';
                    li.textContent = sequence.name;
                    li.setAttribute('data-id', sequence.id);
                    li.setAttribute('data-type', 'sequence');
                    if (sequence.id === selectedSequenceId) {
                        li.classList.add('selected');
                    }
                    li.onclick = (e) => {
                        e.stopPropagation();
                        selectSequence(sequence.id);
                    };

                    // ドラッグイベントリスナー
                    li.setAttribute('draggable', 'true');
                    li.addEventListener('dragstart', handleDragStart);
                    li.addEventListener('dragover', handleDragOver);
                    li.addEventListener('dragleave', handleDragLeave);
                    li.addEventListener('drop', handleDrop);

                    sequenceList.appendChild(li);
                });
            } else {
                sequenceList.innerHTML = '<li style="color: #777;">シーケンスがありません</li>';
            }
        }

        function selectSequence(id) {
            selectedSequenceId = id;
            selectedSceneId = null; // シーケンスが変わったらシーン選択を解除
            updateUIState();

            const project = projects.find(p => p.id === selectedProjectId);
            const sequence = project ? project.sequences.find(s => s.id === id) : null;
            if (sequence) {
                document.getElementById('sequence-detail').classList.add('active');
                document.getElementById('empty-state').classList.remove('active');
                document.getElementById('project-detail').classList.remove('active');
                document.getElementById('scene-detail').classList.remove('active');
                document.getElementById('sequence-name').value = sequence.name;
                document.getElementById('sequence-summary').value = sequence.summary;
            }
        }

        function updateSequenceDetail(field) {
            if (!selectedProjectId || !selectedSequenceId) return;
            const project = projects.find(p => p.id === selectedProjectId);
            const sequence = project ? project.sequences.find(s => s.id === selectedSequenceId) : null;
            if (sequence) {
                if (field === 'name') {
                    sequence.name = document.getElementById('sequence-name').value;
                } else if (field === 'summary') {
                    sequence.summary = document.getElementById('sequence-summary').value;
                }
                saveProjects();
                updateUIState();
            }
        }

        function deleteSequence() {
            if (!selectedProjectId || !selectedSequenceId) return;
            if (confirm('このシーケンスを完全に削除してもよろしいですか？')) {
                const project = projects.find(p => p.id === selectedProjectId);
                if (project) {
                    project.sequences = project.sequences.filter(s => s.id !== selectedSequenceId);
                    saveProjects();
                    selectedSequenceId = null;
                    selectedSceneId = null;
                    updateUIState();
                }
            }
        }

        // --- シーン関連の関数 ---
        function addNewScene() {
            if (!selectedSequenceId) {
                alert('先にシーケンスを選択してください。');
                return;
            }
            const project = projects.find(p => p.id === selectedProjectId);
            const sequence = project ? project.sequences.find(s => s.id === selectedSequenceId) : null;
            if (sequence) {
                const newScene = {
                    id: Date.now().toString(),
                    name: '新しいシーン',
                    summary: '',
                    characters: '',
                    setting: '',
                    plot: ''
                };
                sequence.scenes.push(newScene);
                saveProjects();
                selectScene(newScene.id);
                updateUIState();
            }
        }

        function renderSceneList() {
            const sceneList = document.getElementById('scene-list');
            sceneList.innerHTML = '';
            const project = projects.find(p => p.id === selectedProjectId);
            const sequence = project ? project.sequences.find(s => s.id === selectedSequenceId) : null;
            if (sequence && sequence.scenes.length > 0) {
                sequence.scenes.forEach(scene => {
                    const li = document.createElement('li');
                    li.className = 'draggable';
                    li.textContent = scene.name;
                    li.setAttribute('data-id', scene.id);
                    li.setAttribute('data-type', 'scene');
                    if (scene.id === selectedSceneId) {
                        li.classList.add('selected');
                    }
                    li.onclick = (e) => {
                        e.stopPropagation();
                        selectScene(scene.id);
                    };

                    // ドラッグイベントリスナー
                    li.setAttribute('draggable', 'true');
                    li.addEventListener('dragstart', handleDragStart);
                    li.addEventListener('dragover', handleDragOver);
                    li.addEventListener('dragleave', handleDragLeave);
                    li.addEventListener('drop', handleDrop);

                    sceneList.appendChild(li);
                });
            } else {
                sceneList.innerHTML = '<li style="color: #777;">シーンがありません</li>';
            }
        }

        function selectScene(id) {
            selectedSceneId = id;
            updateUIState();

            const project = projects.find(p => p.id === selectedProjectId);
            const sequence = project ? project.sequences.find(s => s.id === selectedSequenceId) : null;
            const scene = sequence ? sequence.scenes.find(sc => sc.id === id) : null;

            if (scene) {
                document.getElementById('scene-detail').classList.add('active');
                document.getElementById('empty-state').classList.remove('active');
                document.getElementById('project-detail').classList.remove('active');
                document.getElementById('sequence-detail').classList.remove('active');

                document.getElementById('scene-name').value = scene.name;
                document.getElementById('scene-summary').value = scene.summary;
                document.getElementById('scene-characters').value = scene.characters;
                document.getElementById('scene-setting').value = scene.setting;
                document.getElementById('scene-plot').value = scene.plot;
            }
        }

        function updateSceneDetail(field) {
            if (!selectedProjectId || !selectedSequenceId || !selectedSceneId) return;
            const project = projects.find(p => p.id === selectedProjectId);
            const sequence = project ? project.sequences.find(s => s.id === selectedSequenceId) : null;
            const scene = sequence ? sequence.scenes.find(sc => sc.id === selectedSceneId) : null;
            if (scene) {
                if (field === 'name') {
                    scene.name = document.getElementById('scene-name').value;
                } else if (field === 'summary') {
                    scene.summary = document.getElementById('scene-summary').value;
                } else if (field === 'characters') {
                    scene.characters = document.getElementById('scene-characters').value;
                } else if (field === 'setting') {
                    scene.setting = document.getElementById('scene-setting').value;
                } else if (field === 'plot') {
                    scene.plot = document.getElementById('scene-plot').value;
                }
                saveProjects();
                updateUIState();
            }
        }

        function deleteScene() {
            if (!selectedProjectId || !selectedSequenceId || !selectedSceneId) return;
            if (confirm('このシーンを完全に削除してもよろしいですか？')) {
                const project = projects.find(p => p.id === selectedProjectId);
                const sequence = project ? project.sequences.find(s => s.id === selectedSequenceId) : null;
                if (sequence) {
                    sequence.scenes = sequence.scenes.filter(sc => sc.id !== selectedSceneId);
                    saveProjects();
                    selectedSceneId = null;
                    updateUIState();
                }
            }
        }

        // --- タイムライン描画関数 ---
        function drawTimeline() {
            const timelineContainer = document.getElementById('timeline-container');
            timelineContainer.innerHTML = ''; // 一度クリア

            const project = projects.find(p => p.id === selectedProjectId);
            const sequence = project ? project.sequences.find(s => s.id === selectedSequenceId) : null;

            if (sequence && sequence.scenes.length > 0) {
                document.getElementById('no-timeline-scenes').style.display = 'none';
                sequence.scenes.forEach((scene, index) => {
                    const sceneDiv = document.createElement('div');
                    sceneDiv.className = 'timeline-scene';
                    sceneDiv.textContent = scene.name;
                    sceneDiv.title = scene.name; // ホバーで名前を表示
                    sceneDiv.setAttribute('data-id', scene.id); // シーンIDをデータ属性として追加
                    sceneDiv.onclick = () => selectScene(scene.id); // クリックでシーン詳細へ
                    timelineContainer.appendChild(sceneDiv);

                    if (index < sequence.scenes.length - 1) {
                        const arrowDiv = document.createElement('div');
                        arrowDiv.className = 'timeline-arrow';
                        arrowDiv.textContent = '➡️'; // または他の矢印記号
                        timelineContainer.appendChild(arrowDiv);
                    }
                });
            } else {
                document.getElementById('no-timeline-scenes').style.display = 'block';
            }
        }


        // --- ドラッグ＆ドロップ関連の関数 ---
        function handleDragStart(e) {
            draggedItem = e.target;
            dragType = draggedItem.getAttribute('data-type');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', draggedItem.getAttribute('data-id'));
            draggedItem.classList.add('dragging'); // ドラッグ中の要素を半透明にする
        }

        function handleDragOver(e) {
            e.preventDefault();
            const targetItem = e.target.closest('li.draggable'); // ドラッグ対象がli要素であることを確認
            if (!targetItem || draggedItem === targetItem || targetItem.getAttribute('data-type') !== dragType) {
                return;
            }

            const boundingBox = targetItem.getBoundingClientRect();
            const offset = boundingBox.y + (boundingBox.height / 2);

            document.querySelectorAll('.drag-over, .drag-over-bottom').forEach(item => {
                item.classList.remove('drag-over', 'drag-over-bottom');
            });

            if (e.clientY < offset) {
                targetItem.classList.add('drag-over');
            } else {
                targetItem.classList.add('drag-over-bottom');
            }
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDragLeave(e) {
            e.target.classList.remove('drag-over', 'drag-over-bottom');
        }

        function handleDrop(e) {
            e.preventDefault();
            const targetItem = e.target.closest('li.draggable'); // ドロップ先がli要素であることを確認
            if (!targetItem || draggedItem === targetItem || targetItem.getAttribute('data-type') !== dragType) {
                return;
            }

            const draggedId = draggedItem.getAttribute('data-id');
            const targetId = targetItem.getAttribute('data-id');

            let list;
            let currentList;
            let parentObject; // project or sequence

            if (dragType === 'project') {
                list = projects;
                currentList = projects;
            } else if (dragType === 'sequence') {
                parentObject = projects.find(p => p.id === selectedProjectId);
                if (!parentObject) return;
                list = parentObject.sequences;
                currentList = parentObject.sequences;
            } else if (dragType === 'scene') {
                const project = projects.find(p => p.id === selectedProjectId);
                parentObject = project ? project.sequences.find(s => s.id === selectedSequenceId) : null;
                if (!parentObject) return;
                list = parentObject.scenes;
                currentList = parentObject.scenes;
            } else {
                return; // 未知のdragType
            }

            const draggedIndex = list.findIndex(item => item.id === draggedId);
            const targetIndex = list.findIndex(item => item.id === targetId);

            if (draggedIndex === -1 || targetIndex === -1) {
                return;
            }

            const [removed] = currentList.splice(draggedIndex, 1);

            const boundingBox = targetItem.getBoundingClientRect();
            const offset = boundingBox.y + (boundingBox.height / 2);

            if (e.clientY < offset) {
                // ドロップ位置がターゲットの上半分 (前に挿入)
                currentList.splice(targetIndex, 0, removed);
            } else {
                // ドロップ位置がターゲットの下半分 (後ろに挿入)
                // ターゲットが元々ドラッグされた要素より前にある場合、spliceのインデックスを調整
                if (draggedIndex < targetIndex) {
                    currentList.splice(targetIndex, 0, removed);
                } else {
                    currentList.splice(targetIndex + 1, 0, removed);
                }
            }

            saveProjects();
            updateUIState(); // UIを再描画して変更を反映

            if (draggedItem) { // draggedItem が null でないことを確認
                draggedItem.classList.remove('dragging'); // ドラッグ中の要素から半透明を解除
            }
            document.querySelectorAll('.drag-over, .drag-over-bottom').forEach(item => {
                item.classList.remove('drag-over', 'drag-over-bottom'); // 残っているハイライトを解除
            });
            draggedItem = null;
            dragType = null;
        }

        // --- 初期化 ---
        document.addEventListener('DOMContentLoaded', () => {
            loadProjects(); // アプリ起動時に保存されたプロジェクトを読み込む

            // 最後に選択されていたプロジェクトなどを記憶・復元するロジック (簡易版)
            const lastSelectedProjectId = localStorage.getItem('lastSelectedProjectId');
            if (lastSelectedProjectId && projects.some(p => p.id === lastSelectedProjectId)) {
                selectedProjectId = lastSelectedProjectId;
                const project = projects.find(p => p.id === selectedProjectId);
                if (project && project.sequences.length > 0) {
                    // 最後のシーケンスとシーンを選択状態にする（例）
                    selectedSequenceId = project.sequences[project.sequences.length - 1].id;
                    const sequence = project.sequences.find(s => s.id === selectedSequenceId);
                    if (sequence && sequence.scenes.length > 0) {
                        selectedSceneId = sequence.scenes[sequence.scenes.length - 1].id;
                    }
                }
            } else if (projects.length > 0) {
                selectedProjectId = projects[0].id; // 以前の選択がなければ最初の作品を選択
                const project = projects[0];
                if (project && project.sequences.length > 0) {
                    selectedSequenceId = project.sequences[0].id;
                    const sequence = project.sequences[0];
                    if (sequence && sequence.scenes.length > 0) {
                        selectedSceneId = sequence.scenes[0].id;
                    }
                }
            }

            updateUIState(); // UIの初期状態を更新
        });
    </script>
</body>
</html>
