<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>プロットメーカー PRO</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #app {
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            padding: 30px;
            width: 90%;
            max-width: 1000px; /* 少し広めに */
            margin-bottom: 30px;
            display: flex; /* Flexboxでレイアウト */
            gap: 20px;
        }
        #sidebar {
            width: 250px;
            padding-right: 20px;
            border-right: 1px solid #eee;
            flex-shrink: 0; /* 縮まない */
        }
        #main-content {
            flex-grow: 1; /* 残りのスペースを埋める */
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 25px;
            font-size: 2.2em;
        }
        h2 {
            color: #34495e;
            margin-top: 20px;
            margin-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 8px;
            font-size: 1.6em;
        }
        h3 {
             color: #4a637d;
             margin-top: 15px;
             margin-bottom: 10px;
             font-size: 1.3em;
        }
        .section-title { /* 既存のsection-titleはh2, h3などに置き換え */
            color: #34495e;
            margin-top: 30px;
            margin-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 8px;
            font-size: 1.5em;
        }
        .input-group {
            margin-bottom: 18px;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        .input-group input[type="text"],
        .input-group input[type="number"],
        .input-group textarea,
        .input-group select {
            width: calc(100% - 20px);
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
            box-sizing: border-box;
            background-color: #fafafa;
        }
        .input-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap; /* ボタンの折り返し */
        }
        button {
            background-color: #3498db;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s ease, transform 0.1s ease;
            white-space: nowrap; /* ボタン内のテキスト改行防止 */
        }
        button:hover {
            background-color: #2980b9;
            transform: translateY(-1px);
        }
        button:active {
            transform: translateY(0);
        }
        button.secondary {
            background-color: #95a5a6;
        }
        button.secondary:hover {
            background-color: #7f8c8d;
        }
        button.danger {
            background-color: #e74c3c;
        }
        button.danger:hover {
            background-color: #c0392b;
        }
        #plot-output { /* 使用しないかもしれませんが残しておきます */
            background-color: #ecf0f1;
            border: 1px dashed #bdc3c7;
            padding: 25px;
            min-height: 200px;
            margin-top: 30px;
            border-radius: 8px;
            font-size: 1.1em;
            line-height: 1.8;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .list-container {
            list-style: none;
            padding: 0;
            max-height: 300px; /* スクロール可能にする */
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 5px;
            background-color: #fcfcfc;
        }
        .list-container li {
            background-color: #f9f9f9;
            border-bottom: 1px solid #eee;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .list-container li:last-child {
            border-bottom: none;
        }
        .list-container li:hover {
            background-color: #eaf3f9;
        }
        .list-container li.selected {
            background-color: #dbe9f5;
            font-weight: bold;
            color: #2c3e50;
        }
        .list-container li span {
            flex-grow: 1;
            margin-right: 15px;
        }
        .list-container li button {
            padding: 6px 12px;
            font-size: 0.8em;
            margin-left: 8px;
            box-shadow: none; /* リスト内ボタンの影をなくす */
        }

        .plot-type-options {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .plot-type-options label {
            background-color: #e0e0e0;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .plot-type-options label:hover {
            background-color: #d0d0d0;
        }
        .plot-type-options input[type="radio"] {
            display: none;
        }
        .plot-type-options input[type="radio"]:checked + label {
            background-color: #3498db;
            color: white;
            font-weight: bold;
        }

        /* モーダルダイアログ */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border: 1px solid #888;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
        }
        #overallSummaryTextarea, #charDetailSummaryTextarea {
            width: calc(100% - 20px);
            min-height: 200px;
            margin-bottom: 15px;
        }
        #charDetailInputs label, #charDetailInputs input {
            margin-bottom: 10px;
        }
        #charDetailInputs input {
            width: calc(100% - 10px);
        }

        /* 描画・画像・テーブル関連のスタイル */
        #drawingCanvas, #timelineCanvas {
            border: 1px solid #bdc3c7;
            background-color: white;
            display: block;
            margin-top: 15px;
            border-radius: 5px;
        }
        #imagePreviewElement img {
            max-width: 100%;
            height: auto;
            border: 1px solid #eee;
            border-radius: 5px;
            display: block;
            margin-top: 15px;
        }
        #tablePreviewElement table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        #tablePreviewElement th, #tablePreviewElement td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
            word-wrap: break-word; /* 長い単語の折り返し */
        }
        #tablePreviewElement td[contenteditable="true"]:focus {
            outline: 2px solid #3498db;
        }
        #tablePreviewElement th {
            background-color: #e9ecef;
        }

        /* スクロールバーのスタイル（任意） */
        .list-container::-webkit-scrollbar,
        body::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .list-container::-webkit-scrollbar-thumb,
        body::-webkit-scrollbar-thumb {
            background-color: #ccc;
            border-radius: 4px;
        }
        .list-container::-webkit-scrollbar-track,
        body::-webkit-scrollbar-track {
            background-color: #f1f1f1;
        }

        /* キャラクター選択ドロップダウン */
        #characterSelectForScene {
            width: calc(100% - 20px);
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
            box-sizing: border-box;
            background-color: #fafafa;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="sidebar">
            <h1>プロットメーカー PRO</h1>
            <div class="section">
                <h2>作品リスト</h2>
                <ul id="project-list" class="list-container">
                    </ul>
                <div class="button-group">
                    <button id="addProjectButton">新しい作品</button>
                    <button id="deleteProjectButton" class="danger secondary">作品を削除</button>
                </div>
            </div>

            <div class="section" id="overall-summary-section" style="display:none;">
                <h2>作品概要</h2>
                <div class="button-group">
                    <button id="openOverallSummaryModal">概要メモを開く</button>
                </div>
            </div>

            <div class="section" id="character-list-section" style="display:none;">
                <h2>キャラクターリスト</h2>
                <ul id="character-list" class="list-container">
                    </ul>
                <div class="button-group">
                    <button id="addCharacterButton">新しいキャラクター</button>
                    <button id="deleteCharacterButton" class="danger secondary">キャラクターを削除</button>
                </div>
            </div>

            <div class="section" id="sequence-list-section" style="display:none;">
                <h2>シークエンスリスト</h2>
                <ul id="sequence-list" class="list-container">
                    </ul>
                <div class="button-group">
                    <button id="addSequenceButton">新しいシークエンス</button>
                    <button id="deleteSequenceButton" class="danger secondary">シークエンスを削除</button>
                </div>
            </div>
        </div>

        <div id="main-content">
            <h2 id="current-project-title">作品を選択してください</h2>
            <h3 id="current-sequence-title" style="display:none;"></h3>

            <div class="section" id="scene-input-section" style="display:none;">
                <h3>シーン入力</h3>
                <div class="plot-type-options">
                    <input type="radio" id="typeTimeline" name="plotType" value="timeline" checked>
                    <label for="typeTimeline">時系列プロット</label>

                    <input type="radio" id="typeCharacter" name="plotType" value="character">
                    <label for="typeCharacter">キャラクタープロット</label>

                    <input type="radio" id="typeStory" name="plotType" value="story">
                    <label for="typeStory">ストーリープロット</label>
                </div>

                <div id="timelinePlotInputs">
                    <div class="input-group">
                        <label for="date">日付/時期:</label>
                        <input type="text" id="date" placeholder="例: 2023/01/15, 紀元前500年, 夏">
                    </div>
                    <div class="input-group">
                        <label for="event">出来事/内容:</label>
                        <textarea id="event" placeholder="例: 主人公が新しいスキルを習得する"></textarea>
                    </div>
                </div>

                <div id="characterPlotInputs" style="display: none;">
                    <div class="input-group">
                        <label for="characterSelectForScene">既存キャラクターを選択:</label>
                        <select id="characterSelectForScene">
                            <option value="">-- 新しいキャラクター --</option>
                            </select>
                    </div>
                    <div class="input-group">
                        <label for="charName">キャラクター名 (新規の場合):</label>
                        <input type="text" id="charName" placeholder="例: エルザ">
                    </div>
                    <div class="input-group">
                        <label for="charTrait">特徴/性格:</label>
                        <textarea id="charTrait" placeholder="例: 冷静沈着、魔力が高い"></textarea>
                    </div>
                    <div class="input-group">
                        <label for="charRole">役割:</label>
                        <input type="text" id="charRole" placeholder="例: 主人公、敵役、サポート">
                    </div>
                </div>

                <div id="storyPlotInputs" style="display: none;">
                    <div class="input-group">
                        <label for="storyChapter">章/シーン:</label>
                        <input type="text" id="storyChapter" placeholder="例: 第1章: 出会い、シーン3: 訓練">
                    </div>
                    <div class="input-group">
                        <label for="storySummary">概要:</label>
                        <textarea id="storySummary" placeholder="例: 主人公とヒロインが初めて出会い、互いの目標を知る"></textarea>
                    </div>
                    <div class="input-group">
                        <label for="storyConflict">葛藤/解決:</label>
                        <textarea id="storyConflict" placeholder="例: 内なる葛藤、敵との対決、新たな友情"></textarea>
                    </div>
                </div>

                <div class="button-group">
                    <button id="addSceneButton">シーンを追加</button>
                    <button id="clearSceneInputs" class="secondary">入力クリア</button>
                </div>
            </div>

            <div class="section" id="scene-list-section" style="display:none;">
                <h3>シーンリスト</h3>
                <ul id="scene-list" class="list-container">
                    </ul>
                <div class="button-group">
                    <button id="deleteSceneButton" class="danger secondary">シーンを削除</button>
                </div>
            </div>

            <div class="section" id="scene-details-section" style="display:none;">
                <h3>選択中のシーン詳細</h3>
                <div id="selected-scene-content">
                    </div>

                <div class="section-title">タイムライン描画</div>
                <div class="button-group">
                    <button id="timelineDisplayMode">タイムライン表示モード切り替え</button>
                </div>
                <canvas id="timelineCanvas" width="800" height="200"></canvas>

                <div class="section-title">自由描画</div>
                <div class="button-group">
                    <button id="drawingModeButton">描画モード切り替え</button>
                    <label for="lineThickness">太さ:</label>
                    <input type="range" id="lineThickness" min="1" max="20" value="5">
                    <label for="lineColor">色:</label>
                    <input type="color" id="lineColor" value="#000000">
                    <button id="clearDrawingButton" class="secondary">クリア</button>
                </div>
                <canvas id="drawingCanvas" width="800" height="400"></canvas>

                <div class="section-title">画像</div>
                <div class="input-group">
                    <label for="imageUpload">画像をアップロード:</label>
                    <input type="file" id="imageUpload" accept="image/*">
                </div>
                <div id="imagePreviewElement"></div>

                <div class="section-title">テーブル</div>
                <div class="input-group">
                    <label>テーブルサイズ:</label>
                    <input type="number" id="tableRowsInput" value="3" min="1" max="100" style="width: 80px;"> 行
                    <input type="number" id="tableColsInput" value="3" min="1" max="100" style="width: 80px; margin-left: 10px;"> 列
                </div>
                <div class="button-group">
                    <button id="createTableButton">テーブル作成</button>
                </div>
                <div id="tablePreviewElement"></div>
            </div>
        </div>
    </div>

    <div id="overallSummaryModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>作品全体概要</h2>
            <textarea id="overallSummaryTextarea" placeholder="作品全体のあらすじや設定などをここに記述してください。"></textarea>
            <div class="button-group">
                <button id="saveOverallSummaryButton">保存</button>
            </div>
        </div>
    </div>

    <div id="characterDetailModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>キャラクター詳細</h2>
            <div id="charDetailInputs">
                <div class="input-group">
                    <label for="charDetailName">キャラクター名:</label>
                    <input type="text" id="charDetailName" placeholder="例: エルザ">
                </div>
                <div class="input-group">
                    <label for="charDetailTrait">特徴/性格:</label>
                    <input type="text" id="charDetailTrait" placeholder="例: 冷静沈着、魔力が高い">
                </div>
                <div class="input-group">
                    <label for="charDetailRole">役割:</label>
                    <input type="text" id="charDetailRole" placeholder="例: 主人公、敵役、サポート">
                </div>
                <div class="input-group">
                    <label for="charDetailSummaryTextarea">詳細メモ:</label>
                    <textarea id="charDetailSummaryTextarea" placeholder="キャラクターの背景、生い立ち、能力、人間関係など、詳細な情報を記述してください。"></textarea>
                </div>
            </div>
            <div class="button-group">
                <button id="saveCharacterDetailButton">保存</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- UI要素の取得 ---
            const projectList = document.getElementById('project-list');
            const addProjectButton = document.getElementById('addProjectButton');
            const deleteProjectButton = document.getElementById('deleteProjectButton');
            const overallSummarySection = document.getElementById('overall-summary-section');
            const openOverallSummaryModalButton = document.getElementById('openOverallSummaryModal');
            const overallSummaryModal = document.getElementById('overallSummaryModal');
            const closeOverallSummaryModalButton = overallSummaryModal.querySelector('.close-button');
            const overallSummaryTextarea = document.getElementById('overallSummaryTextarea');
            const saveOverallSummaryButton = document.getElementById('saveOverallSummaryButton');

            const characterListSection = document.getElementById('character-list-section'); // キャラクターリストセクション
            const characterList = document.getElementById('character-list'); // キャラクターリスト
            const addCharacterButton = document.getElementById('addCharacterButton'); // キャラクター追加ボタン
            const deleteCharacterButton = document.getElementById('deleteCharacterButton'); // キャラクター削除ボタン
            const characterDetailModal = document.getElementById('characterDetailModal'); // キャラクター詳細モーダル
            const closeCharacterDetailModalButton = characterDetailModal.querySelector('.close-button');
            const charDetailNameInput = document.getElementById('charDetailName'); // 詳細モーダル内の名前入力
            const charDetailTraitInput = document.getElementById('charDetailTrait'); // 詳細モーダル内の特徴入力
            const charDetailRoleInput = document.getElementById('charDetailRole'); // 詳細モーダル内の役割入力
            const charDetailSummaryTextarea = document.getElementById('charDetailSummaryTextarea'); // 詳細モーダル内のメモ入力
            const saveCharacterDetailButton = document.getElementById('saveCharacterDetailButton'); // 詳細モーダル内の保存ボタン

            const sequenceListSection = document.getElementById('sequence-list-section');
            const sequenceList = document.getElementById('sequence-list');
            const addSequenceButton = document.getElementById('addSequenceButton');
            const deleteSequenceButton = document.getElementById('deleteSequenceButton');

            const sceneInputSection = document.getElementById('scene-input-section');
            const sceneListSection = document.getElementById('scene-list-section');
            const sceneDetailsSection = document.getElementById('scene-details-section');
            const sceneList = document.getElementById('scene-list');
            const addSceneButton = document.getElementById('addSceneButton');
            const deleteSceneButton = document.getElementById('deleteSceneButton');
            const selectedSceneContent = document.getElementById('selected-scene-content');

            const currentProjectTitle = document.getElementById('current-project-title');
            const currentSequenceTitle = document.getElementById('current-sequence-title');

            // --- 既存のプロット入力UI要素 ---
            const radioButtons = document.querySelectorAll('input[name="plotType"]');
            const timelineInputs = document.getElementById('timelinePlotInputs');
            const characterInputs = document.getElementById('characterPlotInputs'); // シーン追加時のキャラクター入力
            const storyInputs = document.getElementById('storyPlotInputs');

            const dateInput = document.getElementById('date');
            const eventInput = document.getElementById('event');
            const charNameInput = document.getElementById('charName'); // シーン追加時用
            const charTraitInput = document.getElementById('charTrait'); // シーン追加時用
            const charRoleInput = document.getElementById('charRole'); // シーン追加時用
            const characterSelectForScene = document.getElementById('characterSelectForScene'); // シーン追加時の既存キャラクター選択
            const storyChapterInput = document.getElementById('storyChapter');
            const storySummaryInput = document.getElementById('storySummary');
            const storyConflictInput = document.getElementById('storyConflict');
            const clearSceneInputsButton = document.getElementById('clearSceneInputs');

            // --- 描画・画像・テーブルUI要素 ---
            const timelineCanvas = document.getElementById('timelineCanvas');
            const timelineContext = timelineCanvas.getContext('2d');
            const timelineDisplayModeButton = document.getElementById('timelineDisplayMode');

            const drawingCanvas = document.getElementById('drawingCanvas');
            const drawingContext = drawingCanvas.getContext('2d');
            const drawingModeButton = document.getElementById('drawingModeButton');
            const lineThicknessInput = document.getElementById('lineThickness');
            const lineColorInput = document.getElementById('lineColor');
            const clearDrawingButton = document.getElementById('clearDrawingButton');

            const imageUploadInput = document.getElementById('imageUpload');
            const imagePreviewElement = document.getElementById('imagePreviewElement');

            const tableRowsInput = document.getElementById('tableRowsInput');
            const tableColsInput = document.getElementById('tableColsInput');
            const createTableButton = document.getElementById('createTableButton');
            const tablePreviewElement = document.getElementById('tablePreviewElement');

            // --- データモデル ---
            let projects = []; // 全ての作品データを保持
            let currentProjectId = null;
            let currentSequenceId = null;
            let currentSceneId = null; // 選択中のシーンID
            let currentCharacterId = null; // 選択中のキャラクターID (新しい機能)

            // 描画・画像・テーブルの一時データ
            let isDrawingMode = false;
            let drawingPath = [];
            let currentDrawingData = []; // 現在のシーンの描画パス
            let currentImageData = null; // 現在のシーンの画像
            let currentTableData = null; // 現在のシーンのテーブル

            // 描画関連
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;

            // --- データ管理関数 ---
            function generateId() {
                return '_' + Math.random().toString(36).substr(2, 9);
            }

            function saveProjects() {
                localStorage.setItem('plotMakerProjects', JSON.stringify(projects));
            }

            function loadProjects() {
                const savedProjects = localStorage.getItem('plotMakerProjects');
                projects = savedProjects ? JSON.parse(savedProjects) : [];
                renderProjectList();
            }

            // --- UIレンダリング関数 ---
            function renderProjectList() {
                projectList.innerHTML = '';
                if (projects.length === 0) {
                    projectList.innerHTML = '<li>作品がありません。「新しい作品」を作成してください。</li>';
                    return;
                }
                projects.forEach(project => {
                    const listItem = document.createElement('li');
                    listItem.textContent = project.name;
                    listItem.dataset.id = project.id;
                    if (project.id === currentProjectId) {
                        listItem.classList.add('selected');
                    }
                    listItem.addEventListener('click', () => selectProject(project.id));
                    projectList.appendChild(listItem);
                });
            }

            function renderCharacterList() {
                characterList.innerHTML = '';
                const currentProject = projects.find(p => p.id === currentProjectId);
                if (!currentProject || !currentProject.characters || currentProject.characters.length === 0) {
                    characterList.innerHTML = '<li>キャラクターが登録されていません。</li>';
                    return;
                }
                currentProject.characters.forEach(char => {
                    const listItem = document.createElement('li');
                    listItem.textContent = char.name;
                    listItem.dataset.id = char.id;
                    if (char.id === currentCharacterId) {
                        listItem.classList.add('selected');
                    }
                    listItem.addEventListener('click', () => selectCharacter(char.id));
                    characterList.appendChild(listItem);
                });
            }

            function renderSequenceList() {
                sequenceList.innerHTML = '';
                const currentProject = projects.find(p => p.id === currentProjectId);
                if (!currentProject || currentProject.sequences.length === 0) {
                    sequenceList.innerHTML = '<li>シークエンスがありません。「新しいシークエンス」を作成してください。</li>';
                    return;
                }
                currentProject.sequences.forEach(seq => {
                    const listItem = document.createElement('li');
                    listItem.textContent = seq.name;
                    listItem.dataset.id = seq.id;
                    if (seq.id === currentSequenceId) {
                        listItem.classList.add('selected');
                    }
                    listItem.addEventListener('click', () => selectSequence(seq.id));
                    sequenceList.appendChild(listItem);
                });
            }

            function renderSceneList() {
                sceneList.innerHTML = '';
                const currentProject = projects.find(p => p.id === currentProjectId);
                const currentSequence = currentProject ? currentProject.sequences.find(s => s.id === currentSequenceId) : null;

                if (!currentSequence || currentSequence.scenes.length === 0) {
                    sceneList.innerHTML = '<li>シーンがありません。「シーンを追加」してください。</li>';
                    return;
                }
                currentSequence.scenes.forEach(scene => {
                    const listItem = document.createElement('li');
                    let displayTitle = '';
                    if (scene.type === 'timeline') {
                        displayTitle = `[${scene.data.date || '日付なし'}] ${scene.data.event?.substring(0, 30) || '出来事なし'}...`;
                    } else if (scene.type === 'character') {
                        // 作品のキャラクターリストから名前を取得、見つからなければシーンのcharNameを使用
                        const charName = currentProject?.characters.find(c => c.id === scene.data.charId)?.name || scene.data.charName;
                        displayTitle = `👤 ${charName || '不明'} (${scene.data.charRole || '役割不明'})`;
                    } else if (scene.type === 'story') {
                        displayTitle = `📖 ${scene.data.storyChapter || '章なし'}: ${scene.data.storySummary?.substring(0, 30) || '概要なし'}...`;
                    }
                    listItem.textContent = displayTitle;
                    listItem.dataset.id = scene.id;
                    if (scene.id === currentSceneId) {
                        listItem.classList.add('selected');
                    }
                    listItem.addEventListener('click', () => selectScene(scene.id));
                    sceneList.appendChild(listItem);
                });
            }

            function renderSelectedSceneDetails() {
                const currentProject = projects.find(p => p.id === currentProjectId);
                const currentSequence = currentProject ? currentProject.sequences.find(s => s.id === currentSequenceId) : null;
                const currentScene = currentSequence ? currentSequence.scenes.find(sc => sc.id === currentSceneId) : null;

                selectedSceneContent.innerHTML = '';
                if (!currentScene) {
                    selectedSceneContent.textContent = 'シーンが選択されていません。';
                    // 描画・画像・テーブルエリアもクリア
                    clearDrawingCanvas();
                    imagePreviewElement.innerHTML = '';
                    tablePreviewElement.innerHTML = '';
                    currentDrawingData = [];
                    currentImageData = null;
                    currentTableData = null;
                    return;
                }

                let detailText = '';
                if (currentScene.type === 'timeline') {
                    detailText = `
                        <strong>日付/時期:</strong> ${currentScene.data.date || '未設定'}<br>
                        <strong>出来事/内容:</strong> ${currentScene.data.event || '未設定'}
                    `;
                } else if (currentScene.type === 'character') {
                    const charName = currentScene.data.charId ?
                                     (currentProject.characters.find(c => c.id === currentScene.data.charId)?.name || currentScene.data.charName) :
                                     currentScene.data.charName;
                    detailText = `
                        <strong>キャラクター名:</strong> ${charName || '未設定'}<br>
                        <strong>特徴/性格:</strong> ${currentScene.data.charTrait || '未設定'}<br>
                        <strong>役割:</strong> ${currentScene.data.charRole || '未設定'}
                        ${currentScene.data.charId ? `<br><button id="openCharacterDetailFromSceneButton" data-char-id="${currentScene.data.charId}">キャラクター詳細を開く</button>` : ''}
                    `;
                } else if (currentScene.type === 'story') {
                    detailText = `
                        <strong>章/シーン:</strong> ${currentScene.data.storyChapter || '未設定'}<br>
                        <strong>概要:</strong> ${currentScene.data.storySummary || '未設定'}<br>
                        <strong>葛藤/解決:</strong> ${currentScene.data.storyConflict || '未設定'}
                    `;
                }
                selectedSceneContent.innerHTML = detailText;

                // 描画データ読み込みと描画
                currentDrawingData = currentScene.drawings || [];
                drawAllDrawings();

                // 画像データ読み込みと表示
                currentImageData = currentScene.image || null;
                if (currentImageData && currentImageData.dataUrl) {
                    const img = document.createElement('img');
                    img.src = currentImageData.dataUrl;
                    imagePreviewElement.innerHTML = '';
                    imagePreviewElement.appendChild(img);
                } else {
                    imagePreviewElement.innerHTML = '';
                }

                // テーブルデータ読み込みと表示
                currentTableData = currentScene.table || null;
                if (currentTableData) {
                    renderTablePreview(currentTableData);
                } else {
                    tablePreviewElement.innerHTML = '';
                }

                // シーン内の「キャラクター詳細を開く」ボタンのイベントリスナー
                const openCharDetailBtn = document.getElementById('openCharacterDetailFromSceneButton');
                if (openCharDetailBtn) {
                    openCharDetailBtn.addEventListener('click', (e) => {
                        const charId = e.target.dataset.charId;
                        if (charId) {
                            selectCharacter(charId); // キャラクターリストで選択状態にして、詳細モーダルを開く
                        }
                    });
                }
            }


            // --- 選択・表示制御 ---
            function selectProject(projectId) {
                currentProjectId = projectId;
                currentSequenceId = null; // 作品が変わったらシークエンス選択をリセット
                currentSceneId = null; // シーン選択もリセット
                currentCharacterId = null; // キャラクター選択もリセット

                const selectedProject = projects.find(p => p.id === currentProjectId);
                currentProjectTitle.textContent = selectedProject ? selectedProject.name : '作品を選択してください';
                
                // 全体概要セクションを表示
                overallSummarySection.style.display = 'block';

                // キャラクターリストセクションを表示
                characterListSection.style.display = 'block';
                renderCharacterList(); // キャラクターリストをレンダリング

                // シークエンスリストを表示
                sequenceListSection.style.display = 'block';
                renderSequenceList();
                
                // メインコンテンツのシーン関連を非表示
                sceneInputSection.style.display = 'none';
                sceneListSection.style.display = 'none';
                sceneDetailsSection.style.display = 'none';
                currentSequenceTitle.style.display = 'none';
                currentSequenceTitle.textContent = ''; // シークエンスタイトルもクリア

                updateUIState();
                populateCharacterSelectForScene(); // シーン追加時のキャラクター選択肢を更新
            }

            function selectCharacter(characterId) {
                currentCharacterId = characterId;
                const currentProject = projects.find(p => p.id === currentProjectId);
                const selectedChar = currentProject?.characters.find(c => c.id === currentCharacterId);

                if (selectedChar) {
                    charDetailNameInput.value = selectedChar.name;
                    charDetailTraitInput.value = selectedChar.traits || '';
                    charDetailRoleInput.value = selectedChar.role || '';
                    charDetailSummaryTextarea.value = selectedChar.details || '';
                    characterDetailModal.style.display = 'flex'; // モーダル表示
                }
                updateUIState();
            }

            function selectSequence(sequenceId) {
                currentSequenceId = sequenceId;
                currentSceneId = null; // シークエンスが変わったらシーン選択をリセット
                const currentProject = projects.find(p => p.id === currentProjectId);
                const selectedSequence = currentProject?.sequences.find(s => s.id === currentSequenceId);
                currentSequenceTitle.textContent = selectedSequence ? selectedSequence.name : '';
                currentSequenceTitle.style.display = 'block';

                // シーン入力とリストを表示
                sceneInputSection.style.display = 'block';
                sceneListSection.style.display = 'block';
                renderSceneList();

                // シーン詳細を非表示
                sceneDetailsSection.style.display = 'none';
                selectedSceneContent.innerHTML = '';

                updateUIState();
                drawTimeline(); // シークエンスが選択されたらタイムラインを再描画
            }

            function selectScene(sceneId) {
                currentSceneId = sceneId;
                renderSelectedSceneDetails(); // シーン詳細を表示

                // シーン詳細セクションを表示
                sceneDetailsSection.style.display = 'block';
                
                updateUIState();
                drawTimeline(); // シーンが選択されたらタイムラインを再描画（選択シーンのハイライトのため）
            }

            function resetMainContentVisibility() {
                // メインコンテンツのすべてのセクションを非表示にする初期化関数
                overallSummarySection.style.display = 'none';
                characterListSection.style.display = 'none';
                sequenceListSection.style.display = 'none';
                sceneInputSection.style.display = 'none';
                sceneListSection.style.display = 'none';
                sceneDetailsSection.style.display = 'none';
                currentProjectTitle.textContent = '作品を選択してください';
                currentSequenceTitle.style.display = 'none';
                currentSequenceTitle.textContent = '';
                selectedSceneContent.innerHTML = ''; // シーン詳細もクリア
                clearDrawingCanvas(); // 描画クリア
                imagePreviewElement.innerHTML = ''; // 画像クリア
                tablePreviewElement.innerHTML = ''; // テーブルクリア
            }

            function updateUIState() {
                // リストの選択状態を更新
                document.querySelectorAll('#project-list li').forEach(li => li.classList.remove('selected'));
                if (currentProjectId) {
                    document.querySelector(`#project-list li[data-id="${currentProjectId}"]`)?.classList.add('selected');
                }
                document.querySelectorAll('#character-list li').forEach(li => li.classList.remove('selected')); // キャラクターリスト
                if (currentCharacterId) {
                    document.querySelector(`#character-list li[data-id="${currentCharacterId}"]`)?.classList.add('selected');
                }
                document.querySelectorAll('#sequence-list li').forEach(li => li.classList.remove('selected'));
                if (currentSequenceId) {
                    document.querySelector(`#sequence-list li[data-id="${currentSequenceId}"]`)?.classList.add('selected');
                }
                document.querySelectorAll('#scene-list li').forEach(li => li.classList.remove('selected'));
                if (currentSceneId) {
                    document.querySelector(`#scene-list li[data-id="${currentSceneId}"]`)?.classList.add('selected');
                }

                // 削除ボタンの有効/無効
                deleteProjectButton.disabled = !currentProjectId;
                deleteCharacterButton.disabled = !currentProjectId || !currentCharacterId; // キャラクター削除ボタン
                deleteSequenceButton.disabled = !currentSequenceId;
                deleteSceneButton.disabled = !currentSceneId;
            }

            // --- イベントリスナー ---
            addProjectButton.addEventListener('click', () => {
                const projectName = prompt('新しい作品のタイトルを入力してください:');
                if (projectName) {
                    const newProject = {
                        id: generateId(),
                        name: projectName,
                        overallSummary: '',
                        characters: [], // 新規作品にキャラクター配列を初期化
                        sequences: []
                    };
                    projects.push(newProject);
                    saveProjects();
                    selectProject(newProject.id); // 新しく作った作品を選択状態にする
                }
            });

            deleteProjectButton.addEventListener('click', () => {
                if (!currentProjectId) return;
                const currentProjectName = projects.find(p => p.id === currentProjectId)?.name;
                if (confirm(`作品「${currentProjectName}」を削除してもよろしいですか？この操作は元に戻せません。`)) {
                    projects = projects.filter(p => p.id !== currentProjectId);
                    currentProjectId = null;
                    currentSequenceId = null;
                    currentSceneId = null;
                    currentCharacterId = null; 
                    saveProjects();
                    renderProjectList(); // 作品リストを再レンダリング
                    resetMainContentVisibility(); // メインコンテンツを完全にリセット
                    updateUIState();
                }
            });

            // キャラクター追加
            addCharacterButton.addEventListener('click', () => {
                if (!currentProjectId) {
                    alert('先に作品を選択または作成してください。');
                    return;
                }
                const charName = prompt('新しいキャラクターの名前を入力してください:');
                if (charName) {
                    const currentProject = projects.find(p => p.id === currentProjectId);
                    if (currentProject) {
                        if (!currentProject.characters) { // 互換性のため初期化
                            currentProject.characters = [];
                        }
                        const newCharacter = {
                            id: generateId(),
                            name: charName,
                            traits: '',
                            role: '',
                            details: ''
                        };
                        currentProject.characters.push(newCharacter);
                        saveProjects();
                        renderCharacterList(); // リストを更新
                        populateCharacterSelectForScene(); // シーンのドロップダウンも更新
                        selectCharacter(newCharacter.id); // 新しいキャラクターを選択し、詳細モーダルを開く
                    }
                }
            });

            // キャラクター削除
            deleteCharacterButton.addEventListener('click', () => {
                if (!currentProjectId || !currentCharacterId) return;
                const currentProject = projects.find(p => p.id === currentProjectId);
                const currentCharacterName = currentProject?.characters.find(c => c.id === currentCharacterId)?.name;
                if (confirm(`キャラクター「${currentCharacterName}」を削除してもよろしいですか？この操作は元に戻せません。`)) {
                    if (currentProject) {
                        currentProject.characters = currentProject.characters.filter(c => c.id !== currentCharacterId);
                        currentCharacterId = null;
                        saveProjects();
                        renderCharacterList(); // リストを更新
                        populateCharacterSelectForScene(); // シーンのドロップダウンも更新
                        updateUIState();
                        characterDetailModal.style.display = 'none'; // モーダルを閉じる
                    }
                }
            });

            addSequenceButton.addEventListener('click', () => {
                if (!currentProjectId) {
                    alert('先に作品を選択または作成してください。');
                    return;
                }
                const sequenceName = prompt('新しいシークエンスのタイトルを入力してください:');
                if (sequenceName) {
                    const currentProject = projects.find(p => p.id === currentProjectId);
                    if (currentProject) {
                        const newSequence = {
                            id: generateId(),
                            name: sequenceName,
                            scenes: []
                        };
                        currentProject.sequences.push(newSequence);
                        saveProjects();
                        selectSequence(newSequence.id); // 新しく作ったシークエンスを選択状態にする
                    }
                }
            });

            deleteSequenceButton.addEventListener('click', () => {
                if (!currentProjectId || !currentSequenceId) return;
                const currentProject = projects.find(p => p.id === currentProjectId);
                const currentSequenceName = currentProject?.sequences.find(s => s.id === currentSequenceId)?.name;
                if (confirm(`シークエンス「${currentSequenceName}」を削除してもよろしいですか？この操作は元に戻せません。`)) {
                    if (currentProject) {
                        currentProject.sequences = currentProject.sequences.filter(s => s.id !== currentSequenceId);
                        currentSequenceId = null;
                        currentSceneId = null; // シークエンス削除でシーン選択もリセット
                        saveProjects();
                        renderSequenceList(); // シークエンスリストを再描画
                        // シーン関連のUIを非表示に
                        sceneInputSection.style.display = 'none';
                        sceneListSection.style.display = 'none';
                        sceneDetailsSection.style.display = 'none';
                        currentSequenceTitle.style.display = 'none';
                        currentSequenceTitle.textContent = '';
                        selectedSceneContent.innerHTML = '';
                        clearDrawingCanvas();
                        imagePreviewElement.innerHTML = '';
                        tablePreviewElement.innerHTML = '';
                        updateUIState();
                    }
                }
            });

            addSceneButton.addEventListener('click', () => {
                if (!currentProjectId || !currentSequenceId) {
                    alert('先に作品とシークエンスを選択してください。');
                    return;
                }

                let newSceneData = {};
                let sceneType = document.querySelector('input[name="plotType"]:checked').value;

                if (sceneType === 'timeline') {
                    const date = dateInput.value.trim();
                    const event = eventInput.value.trim();
                    if (!date || !event) { alert('日付と出来事を入力してください。'); return; }
                    newSceneData = { date, event };
                } else if (sceneType === 'character') {
                    const selectedCharId = characterSelectForScene.value;
                    let charName = charNameInput.value.trim();
                    let charTrait = charTraitInput.value.trim();
                    let charRole = charRoleInput.value.trim();

                    if (selectedCharId) { // 既存のキャラクターを選択した場合
                        const currentProject = projects.find(p => p.id === currentProjectId);
                        const selectedChar = currentProject?.characters.find(c => c.id === selectedCharId);
                        if (selectedChar) {
                            newSceneData = {
                                charId: selectedChar.id, // キャラクターIDを紐付け
                                charName: selectedChar.name, // 名前はシーンにも記録
                                charTrait: selectedChar.traits,
                                charRole: selectedChar.role
                            };
                        }
                    } else { // 新しいキャラクターを追加する場合
                        if (!charName) { alert('キャラクター名を入力してください。'); return; }
                        newSceneData = { charName, charTrait, charRole };

                        // 新しいキャラクターを作品のキャラクターリストにも追加
                        const currentProject = projects.find(p => p.id === currentProjectId);
                        if (currentProject) {
                            if (!currentProject.characters) {
                                currentProject.characters = [];
                            }
                            const newCharacter = {
                                id: generateId(),
                                name: charName,
                                traits: charTrait,
                                role: charRole,
                                details: '' // 新規作成時は空
                            };
                            currentProject.characters.push(newCharacter);
                            newSceneData.charId = newCharacter.id; // シーンにもIDを紐付け
                            saveProjects(); // ここでプロジェクト全体を保存
                            renderCharacterList(); // キャラクターリストを更新
                            populateCharacterSelectForScene(); // ドロップダウンも更新
                        }
                    }
                } else if (sceneType === 'story') {
                    const storyChapter = storyChapterInput.value.trim();
                    const storySummary = storySummaryInput.value.trim();
                    const storyConflict = storyConflictInput.value.trim();
                    if (!storyChapter || !storySummary) { alert('章/シーンと概要を入力してください。'); return; }
                    newSceneData = { storyChapter, storySummary, storyConflict };
                }

                const newScene = {
                    id: generateId(),
                    type: sceneType,
                    data: newSceneData,
                    drawings: currentDrawingData, // 現在の描画データを紐付け
                    image: currentImageData,     // 現在の画像データを紐付け
                    table: currentTableData      // 現在のテーブルデータを紐付け
                };

                const currentProject = projects.find(p => p.id === currentProjectId);
                const currentSequence = currentProject?.sequences.find(s => s.id === currentSequenceId);
                if (currentSequence) {
                    currentSequence.scenes.push(newScene);
                    saveProjects();
                    renderSceneList(); // シーンリストを再描画
                    selectScene(newScene.id); // 追加したシーンを選択状態にする
                    clearSceneInputs();
                }
            });

            deleteSceneButton.addEventListener('click', () => {
                if (!currentProjectId || !currentSequenceId || !currentSceneId) return;
                const currentProject = projects.find(p => p.id === currentProjectId);
                const currentSequence = currentProject?.sequences.find(s => s.id === currentSequenceId);
                
                if (currentSequence) {
                    // シーンの削除
                    currentSequence.scenes = currentSequence.scenes.filter(sc => sc.id !== currentSceneId);
                    currentSceneId = null; // 削除後に選択中のシーンをリセット
                    saveProjects();
                    renderSceneList(); // シーンリストを再描画

                    // シーン詳細セクションを非表示にし、内容をクリア
                    sceneDetailsSection.style.display = 'none';
                    selectedSceneContent.innerHTML = '';
                    clearDrawingCanvas();
                    imagePreviewElement.innerHTML = '';
                    tablePreviewElement.innerHTML = '';
                    updateUIState();
                }
            });

            clearSceneInputsButton.addEventListener('click', clearSceneInputs);

            function clearSceneInputs() {
                dateInput.value = '';
                eventInput.value = '';
                charNameInput.value = '';
                charTraitInput.value = '';
                charRoleInput.value = '';
                characterSelectForScene.value = ''; // ドロップダウンもリセット
                storyChapterInput.value = '';
                storySummaryInput.value = '';
                storyConflictInput.value = '';

                // 描画・画像・テーブルの一時データをクリア
                currentDrawingData = [];
                clearDrawingCanvas();
                currentImageData = null;
                imagePreviewElement.innerHTML = '';
                currentTableData = null;
                tablePreviewElement.innerHTML = '';
            }

            // プロットタイプ切り替え
            radioButtons.forEach(radio => {
                radio.addEventListener('change', (event) => {
                    const plotType = event.target.value;
                    timelineInputs.style.display = 'none';
                    characterInputs.style.display = 'none';
                    storyInputs.style.display = 'none';
                    if (plotType === 'timeline') {
                        timelineInputs.style.display = 'block';
                    } else if (plotType === 'character') {
                        characterInputs.style.display = 'block';
                        populateCharacterSelectForScene(); // キャラクター選択肢を更新
                    } else if (plotType === 'story') {
                        storyInputs.style.display = 'block';
                    }
                    clearSceneInputs(); // 入力フォーム切り替え時もクリア
                });
            });

            // シーンのキャラクタープロット入力時に既存キャラクターを選択するためのドロップダウンを生成
            function populateCharacterSelectForScene() {
                characterSelectForScene.innerHTML = '<option value="">-- 新しいキャラクター --</option>';
                const currentProject = projects.find(p => p.id === currentProjectId);
                if (currentProject && currentProject.characters) {
                    currentProject.characters.forEach(char => {
                        const option = document.createElement('option');
                        option.value = char.id;
                        option.textContent = char.name;
                        characterSelectForScene.appendChild(option);
                    });
                }
            }

            // ドロップダウン選択時、名前・特徴・役割の入力欄を無効化/有効化
            characterSelectForScene.addEventListener('change', () => {
                const isExistingCharSelected = characterSelectForScene.value !== '';
                charNameInput.disabled = isExistingCharSelected;
                charTraitInput.disabled = isExistingCharSelected;
                charRoleInput.disabled = isExistingCharSelected;

                // 既存キャラクターを選択した場合、その情報を入力欄に表示（編集は不可だが参考用）
                if (isExistingCharSelected) {
                    const currentProject = projects.find(p => p.id === currentProjectId);
                    const selectedChar = currentProject?.characters.find(c => c.id === characterSelectForScene.value);
                    if (selectedChar) {
                        charNameInput.value = selectedChar.name;
                        charTraitInput.value = selectedChar.traits;
                        charRoleInput.value = selectedChar.role;
                    }
                } else {
                    charNameInput.value = '';
                    charTraitInput.value = '';
                    charRoleInput.value = '';
                }
            });


            // --- 全体概要モーダル関連 ---
            openOverallSummaryModalButton.addEventListener('click', () => {
                const currentProject = projects.find(p => p.id === currentProjectId);
                if (currentProject) {
                    overallSummaryTextarea.value = currentProject.overallSummary || '';
                    overallSummaryModal.style.display = 'flex'; // Flexboxで中央表示
                }
            });

            closeOverallSummaryModalButton.addEventListener('click', () => {
                overallSummaryModal.style.display = 'none';
            });

            // モーダルの外側クリックで閉じる
            overallSummaryModal.addEventListener('click', (event) => {
                if (event.target === overallSummaryModal) {
                    overallSummaryModal.style.display = 'none';
                }
            });

            saveOverallSummaryButton.addEventListener('click', () => {
                const currentProject = projects.find(p => p.id === currentProjectId);
                if (currentProject) {
                    currentProject.overallSummary = overallSummaryTextarea.value;
                    saveProjects();
                    alert('全体概要を保存しました！');
                    overallSummaryModal.style.display = 'none';
                }
            });

            // --- キャラクター詳細モーダル関連 ---
            // キャラクターリストのクリックイベントはrenderCharacterList内で設定
            closeCharacterDetailModalButton.addEventListener('click', () => {
                characterDetailModal.style.display = 'none';
                currentCharacterId = null; // 選択解除
                updateUIState();
            });

            characterDetailModal.addEventListener('click', (event) => {
                if (event.target === characterDetailModal) {
                    characterDetailModal.style.display = 'none';
                    currentCharacterId = null; // 選択解除
                    updateUIState();
                }
            });

            saveCharacterDetailButton.addEventListener('click', () => {
                const currentProject = projects.find(p => p.id === currentProjectId);
                const selectedChar = currentProject?.characters.find(c => c.id === currentCharacterId);
                if (selectedChar) {
                    selectedChar.name = charDetailNameInput.value.trim();
                    selectedChar.traits = charDetailTraitInput.value.trim();
                    selectedChar.role = charDetailRoleInput.value.trim();
                    selectedChar.details = charDetailSummaryTextarea.value.trim();
                    saveProjects();
                    alert('キャラクター詳細を保存しました！');
                    characterDetailModal.style.display = 'none';
                    renderCharacterList(); // リスト表示を更新
                    populateCharacterSelectForScene(); // シーンのドロップダウンも更新
                    // キャラクター名が変更された場合、シーンリストの表示も更新する必要がある
                    if (currentProjectId && currentSequenceId) { // 現在作品とシークエンスが選択されていれば
                        renderSceneList();
                        renderSelectedSceneDetails(); // 選択中のシーン詳細も更新
                    }
                }
            });


            // --- 描画機能 ---
            function clearDrawingCanvas() {
                drawingContext.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
            }

            function drawAllDrawings() {
                clearDrawingCanvas();
                drawingContext.lineCap = 'round'; // 線端のスタイル
                drawingContext.lineJoin = 'round'; // 線結合部のスタイル

                currentDrawingData.forEach(path => {
                    drawingContext.beginPath();
                    drawingContext.strokeStyle = path.color;
                    drawingContext.lineWidth = path.thickness;
                    if (path.points.length > 0) {
                        drawingContext.moveTo(path.points[0].x, path.points[0].y);
                        for(let i = 1; i < path.points.length; i++) {
                            drawingContext.lineTo(path.points[i].x, path.points[i].y);
                        }
                    }
                    drawingContext.stroke();
                });
            }

            drawingModeButton.addEventListener('click', () => {
                isDrawingMode = !isDrawingMode;
                drawingModeButton.textContent = isDrawingMode ? '描画モード終了' : '描画モード開始';
                drawingModeButton.classList.toggle('danger', isDrawingMode);
                drawingCanvas.style.cursor = isDrawingMode ? 'crosshair' : 'default';
                if (!currentSceneId && isDrawingMode) {
                    alert('シーンが選択されていません。描画は一時的で、シーンに保存されません。');
                } else {
                    alert(isDrawingMode ? '描画モードを開始しました。' : '描画モードを終了しました。');
                }
            });

            drawingCanvas.addEventListener('mousedown', (e) => {
                if (!isDrawingMode) return;
                isDrawing = true;
                const rect = drawingCanvas.getBoundingClientRect();
                lastX = e.clientX - rect.left;
                lastY = e.clientY - rect.top;
                drawingPath = [{ x: lastX, y: lastY }];
            });

            drawingCanvas.addEventListener('mousemove', (e) => {
                if (!isDrawing || !isDrawingMode) return;
                const rect = drawingCanvas.getBoundingClientRect();
                const currentX = e.clientX - rect.left;
                const currentY = e.clientY - rect.top;

                drawingContext.beginPath();
                drawingContext.moveTo(lastX, lastY);
                drawingContext.lineTo(currentX, currentY);
                drawingContext.strokeStyle = lineColorInput.value;
                drawingContext.lineWidth = lineThicknessInput.value;
                drawingContext.stroke();

                drawingPath.push({ x: currentX, y: currentY });
                lastX = currentX;
                lastY = currentY;
            });

            drawingCanvas.addEventListener('mouseup', () => {
                if (isDrawing && isDrawingMode) {
                    currentDrawingData.push({
                        points: drawingPath,
                        color: lineColorInput.value,
                        thickness: lineThicknessInput.value
                    });
                    isDrawing = false;
                    // シーンが選択されていれば、描画データをシーンに保存
                    const currentProject = projects.find(p => p.id === currentProjectId);
                    const currentSequence = currentProject?.sequences.find(s => s.id === currentSequenceId);
                    const currentScene = currentSequence?.scenes.find(sc => sc.id === currentSceneId);
                    if (currentScene) {
                        currentScene.drawings = currentDrawingData;
                        saveProjects();
                        // alert('描画データを保存しました。'); // 保存のたびにアラートはうるさいのでコメントアウト
                    } else {
                        // alert('シーンが選択されていないため、描画は一時的です。シーンを選択して保存してください。');
                    }
                }
            });

            // モバイルデバイス向けタッチイベント
            drawingCanvas.addEventListener('touchstart', (e) => {
                if (!isDrawingMode) return;
                e.preventDefault(); // スクロールなどを防ぐ
                isDrawing = true;
                const rect = drawingCanvas.getBoundingClientRect();
                lastX = e.touches[0].clientX - rect.left;
                lastY = e.touches[0].clientY - rect.top;
                drawingPath = [{ x: lastX, y: lastY }];
            });

            drawingCanvas.addEventListener('touchmove', (e) => {
                if (!isDrawing || !isDrawingMode) return;
                e.preventDefault(); // スクロールなどを防ぐ
                const rect = drawingCanvas.getBoundingClientRect();
                const currentX = e.touches[0].clientX - rect.left;
                const currentY = e.touches[0].clientY - rect.top;

                drawingContext.beginPath();
                drawingContext.moveTo(lastX, lastY);
                drawingContext.lineTo(currentX, currentY);
                drawingContext.strokeStyle = lineColorInput.value;
                drawingContext.lineWidth = lineThicknessInput.value;
                drawingContext.stroke();

                drawingPath.push({ x: currentX, y: currentY });
                lastX = currentX;
                lastY = currentY;
            });

            drawingCanvas.addEventListener('touchend', () => {
                if (isDrawing && isDrawingMode) {
                    currentDrawingData.push({
                        points: drawingPath,
                        color: lineColorInput.value,
                        thickness: lineThicknessInput.value
                    });
                    isDrawing = false;
                    const currentProject = projects.find(p => p.id === currentProjectId);
                    const currentSequence = currentProject?.sequences.find(s => s.id === currentSequenceId);
                    const currentScene = currentSequence?.scenes.find(sc => sc.id === currentSceneId);
                    if (currentScene) {
                        currentScene.drawings = currentDrawingData;
                        saveProjects();
                        // alert('描画データを保存しました。');
                    } else {
                        // alert('シーンが選択されていないため、描画は一時的です。シーンを選択して保存してください。');
                    }
                }
            });

            clearDrawingButton.addEventListener('click', () => {
                if (confirm('描画を全てクリアしますか？')) {
                    clearDrawingCanvas();
                    currentDrawingData = [];
                    const currentProject = projects.find(p => p.id === currentProjectId);
                    const currentSequence = currentProject?.sequences.find(s => s.id === currentSequenceId);
                    const currentScene = currentSequence?.scenes.find(sc => sc.id === currentSceneId);
                    if (currentScene) {
                        currentScene.drawings = currentDrawingData;
                        saveProjects();
                        alert('描画をクリアして保存しました。');
                    } else {
                        alert('描画をクリアしました。');
                    }
                }
            });


            // --- 画像アップロード ---
            imageUploadInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        currentImageData = { dataUrl: e.target.result, name: file.name };
                        const img = document.createElement('img');
                        img.src = currentImageData.dataUrl;
                        imagePreviewElement.innerHTML = '';
                        imagePreviewElement.appendChild(img);

                        // シーンが選択されていれば、画像データをシーンに保存
                        const currentProject = projects.find(p => p.id === currentProjectId);
                        const currentSequence = currentProject?.sequences.find(s => s.id === currentSequenceId);
                        const currentScene = currentSequence?.scenes.find(sc => sc.id === currentSceneId);
                        if (currentScene) {
                            currentScene.image = currentImageData;
                            saveProjects();
                            alert('画像を保存しました。');
                        } else {
                            alert('シーンが選択されていないため、画像は一時的です。シーンを選択して保存してください。');
                        }
                    };
                    reader.readAsDataURL(file);
                } else {
                    currentImageData = null;
                    imagePreviewElement.innerHTML = '';
                    const currentProject = projects.find(p => p.id === currentProjectId);
                    const currentSequence = currentProject?.sequences.find(s => s.id === currentSequenceId);
                    const currentScene = currentSequence?.scenes.find(sc => sc.id === currentSceneId);
                    if (currentScene) {
                        delete currentScene.image; // 画像データを削除
                        saveProjects();
                        alert('画像を削除しました。');
                    }
                }
            });

            // --- テーブル作成 ---
            function renderTablePreview(data) {
                if (!data || data.length === 0) {
                    tablePreviewElement.innerHTML = '';
                    return;
                }
                const table = document.createElement('table');
                table.innerHTML = ''; // クリア

                data.forEach((row, rowIndex) => {
                    const tr = document.createElement('tr');
                    row.forEach((cell, colIndex) => {
                        const td = document.createElement('td');
                        td.textContent = cell;
                        td.contentEditable = true; // インライン編集可能にする
                        td.dataset.rowIndex = rowIndex;
                        td.dataset.colIndex = colIndex;
                        td.addEventListener('blur', (e) => {
                            // 編集内容をcurrentTableDataに反映
                            currentTableData[parseInt(e.target.dataset.rowIndex)][parseInt(e.target.dataset.colIndex)] = e.target.textContent;
                            // シーンが選択されていれば、テーブルデータをシーンに保存
                            const currentProject = projects.find(p => p.id === currentProjectId);
                            const currentSequence = currentProject?.sequences.find(s => s.id === currentSequenceId);
                            const currentScene = currentSequence?.scenes.find(sc => sc.id === currentSceneId);
                            if (currentScene) {
                                currentScene.table = currentTableData;
                                saveProjects();
                                // console.log('テーブルデータを保存しました。'); // デバッグ用
                            }
                        });
                        tr.appendChild(td);
                    });
                    table.appendChild(tr);
                });
                tablePreviewElement.innerHTML = '';
                tablePreviewElement.appendChild(table);
            }

            createTableButton.addEventListener('click', () => {
                const rows = parseInt(tableRowsInput.value) || 3;
                const cols = parseInt(tableColsInput.value) || 3;
                if (rows > 0 && cols > 0) {
                    currentTableData = Array.from({ length: rows }, () => Array(cols).fill(''));
                    renderTablePreview(currentTableData);
                    // シーンが選択されていれば、テーブルデータをシーンに保存
                    const currentProject = projects.find(p => p.id === currentProjectId);
                    const currentSequence = currentProject?.sequences.find(s => s.id === currentSequenceId);
                    const currentScene = currentSequence?.scenes.find(sc => sc.id === currentSceneId);
                    if (currentScene) {
                        currentScene.table = currentTableData;
                        saveProjects();
                        alert('テーブルを作成・保存しました。');
                    } else {
                        alert('シーンが選択されていないため、テーブルは一時的です。シーンを選択して保存してください。');
                    }
                } else {
                    alert('行数と列数は1以上で指定してください。');
                }
            });

            // --- タイムライン描画 ---
            function drawTimeline() {
                timelineContext.clearRect(0, 0, timelineCanvas.width, timelineCanvas.height);
                timelineContext.font = '12px Arial';
                timelineContext.fillStyle = '#333';
                timelineContext.textAlign = 'center';
                timelineContext.strokeStyle = '#ccc';
                timelineContext.lineWidth = 1;

                const currentProject = projects.find(p => p.id === currentProjectId);
                const currentSequence = currentProject?.sequences.find(s => s.id === currentSequenceId);

                if (!currentSequence || currentSequence.scenes.length === 0) {
                    timelineContext.fillText('このシークエンスにはシーンがありません。', timelineCanvas.width / 2, timelineCanvas.height / 2);
                    return;
                }

                // タイムライン軸の描画
                const startX = 50;
                const endX = timelineCanvas.width - 50;
                const lineY = timelineCanvas.height / 2;
                timelineContext.beginPath();
                timelineContext.moveTo(startX, lineY);
                timelineContext.lineTo(endX, lineY);
                timelineContext.stroke();

                // 各シーンをタイムライン上に配置
                const sceneCount = currentSequence.scenes.length;
                // シーンが1つの場合は間隔を0にする (線上に1点だけ描画)
                const spacing = (sceneCount > 1) ? (endX - startX) / (sceneCount - 1) : 0; 

                currentSequence.scenes.forEach((scene, index) => {
                    const x = startX + (index * spacing);
                    const y = lineY;

                    // 目盛り
                    timelineContext.beginPath();
                    timelineContext.moveTo(x, y - 5);
                    timelineContext.lineTo(x, y + 5);
                    timelineContext.stroke();

                    // シーン名（データに応じて表示を調整）
                    let sceneLabel = '';
                    if (scene.type === 'timeline' && scene.data.date) {
                        sceneLabel = scene.data.date;
                    } else if (scene.type === 'character') {
                        // シーンが持つcharNameを使用、またはcharIdから作品のキャラクター名を取得
                        sceneLabel = scene.data.charName || (currentProject?.characters.find(c => c.id === scene.data.charId)?.name || `👤 シーン${index + 1}`);
                    } else if (scene.type === 'story' && scene.data.storyChapter) {
                        sceneLabel = scene.data.storyChapter;
                    } else {
                        sceneLabel = `シーン ${index + 1}`;
                    }

                    // テキストを回転させて表示
                    timelineContext.save();
                    timelineContext.translate(x, y + 15);
                    timelineContext.rotate(Math.PI / 6); // 30度回転
                    timelineContext.fillText(sceneLabel, 0, 0);
                    timelineContext.restore();

                    // 選択中のシーンをハイライト
                    if (scene.id === currentSceneId) {
                        timelineContext.beginPath();
                        timelineContext.arc(x, y, 8, 0, Math.PI * 2);
                        timelineContext.fillStyle = '#3498db';
                        timelineContext.fill();
                        timelineContext.strokeStyle = '#2980b9';
                        timelineContext.lineWidth = 2;
                        timelineContext.stroke();
                    }
                });
            }

            timelineDisplayModeButton.addEventListener('click', () => {
                // 現在のプロジェクトとシークエンスが選択されている場合のみ描画
                if (currentProjectId && currentSequenceId) {
                    drawTimeline();
                } else {
                    alert('タイムラインを表示するには、作品とシークエンスを選択してください。');
                }
            });


            // --- 初期化 ---
            loadProjects(); // アプリ起動時に保存されたプロジェクトを読み込む
            if (projects.length > 0) {
                // 最後に選択されていたプロジェクトなどを記憶・復元するロジックがあればより良い
                // 今回はデフォルトで最初のプロジェクトを選択
                // projects[0]が存在する場合のみselectProjectを呼び出す
                if (projects[0]) {
                    selectProject(projects[0].id);
                }
            } else {
                resetMainContentVisibility(); // プロジェクトが一つもない場合はUIを初期状態に
            }
            updateUIState(); // UIの初期状態を更新
        });
    </script>
</body>
</html>
